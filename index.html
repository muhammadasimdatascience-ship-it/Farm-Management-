import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'firebase/auth';
import { 
  getFirestore, collection, doc, setDoc, getDoc, addDoc, 
  updateDoc, deleteDoc, onSnapshot, query, where 
} from 'firebase/firestore';
import { 
  Layout, Tabs, Card, Table, Button, Modal, Form, Input, 
  Select, DatePicker, InputNumber, Space, Statistic, Row, Col, 
  message, Divider, List, Tag, Upload 
} from 'antd';
import { 
  PlusOutlined, DownloadOutlined, UploadOutlined, FilePdfOutlined, 
  WalletOutlined, UserOutlined, EnvironmentOutlined, StockOutlined,
  DashboardOutlined, TableOutlined
} from '@ant-design/icons';

const { Header, Content } = Layout;
const { Option } = Select;

// --- Firebase Configuration ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'farm-mgmt-system-001';

// --- Constants ---
const LIVESTOCK_CATS = ['Cow', 'Beef', 'Goat', 'Others'];
const CROP_EXPENSE_TYPES = ['Labor', 'Seeds', 'Fertilizer', 'Others'];

// Helper to load external scripts dynamically for jspdf and xlsx
const loadScript = (url) => {
  return new Promise((resolve) => {
    const script = document.createElement('script');
    script.src = url;
    script.onload = () => resolve(true);
    script.onerror = () => resolve(false);
    document.head.appendChild(script);
  });
};

const App = () => {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('1');
  const [isModalOpen, setIsModalOpen] = useState(false);
  const [editingItem, setEditingItem] = useState(null);
  const [libsReady, setLibsReady] = useState(false);
  const [form] = Form.useForm();

  // State for data
  const [livestockData, setLivestockData] = useState([]);
  const [cropData, setCropData] = useState([]);
  const [waterData, setWaterData] = useState([]);
  const [otherExpenses, setOtherExpenses] = useState([]);
  const [incomeData, setIncomeData] = useState([]);

  // --- External Libs Loading ---
  useEffect(() => {
    const initLibs = async () => {
      const jspdf = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js');
      const autotable = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js');
      const xlsx = await loadScript('https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js');
      if (jspdf && autotable && xlsx) setLibsReady(true);
    };
    initLibs();
  }, []);

  // --- Auth & Data Fetching ---
  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    const unsubscribeAuth = onAuthStateChanged(auth, setUser);
    return () => unsubscribeAuth();
  }, []);

  useEffect(() => {
    if (!user) return;

    const collections = [
      { name: 'livestock', setter: setLivestockData },
      { name: 'crops', setter: setCropData },
      { name: 'water', setter: setWaterData },
      { name: 'expenses', setter: setOtherExpenses },
      { name: 'income', setter: setIncomeData },
    ];

    const unsubscribes = collections.map(({ name, setter }) => {
      return onSnapshot(
        collection(db, 'artifacts', appId, 'public', 'data', name),
        (snapshot) => {
          const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          setter(data);
        },
        (error) => console.error(`Error fetching ${name}:`, error)
      );
    });

    return () => unsubscribes.forEach(unsub => unsub());
  }, [user]);

  // --- CRUD Operations ---
  const handleSave = async (values) => {
    if (!user) return;
    try {
      const collectionMap = {
        '1': 'livestock',
        '2': 'crops',
        '3': 'water',
        '4': 'expenses',
        '5': 'income'
      };
      const colName = collectionMap[activeTab];
      
      const payload = {
        ...values,
        date: values.date ? values.date.format('YYYY-MM-DD') : new Date().toISOString().split('T')[0],
        updatedAt: new Date().toISOString()
      };

      if (editingItem) {
        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, editingItem.id), payload);
        message.success('Entry updated successfully');
      } else {
        payload.createdAt = new Date().toISOString();
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', colName), payload);
        message.success('Entry added successfully');
      }
      setIsModalOpen(false);
      setEditingItem(null);
      form.resetFields();
    } catch (error) {
      message.error('Error saving data');
    }
  };

  const handleDelete = async (id, colName) => {
    try {
      await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', colName, id));
      message.success('Entry deleted');
    } catch (error) {
      message.error('Delete failed');
    }
  };

  // --- PDF Export Logic ---
  const generatePDF = (title, data, columns) => {
    if (!window.jspdf) return message.error('PDF Library not loaded');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text(title, 14, 15);
    const tableData = data.map(item => columns.map(col => item[col.dataIndex] || ''));
    doc.autoTable({
      head: [columns.map(col => col.title)],
      body: tableData,
      startY: 20,
    });
    doc.save(`${title.replace(/\s/g, '_')}_${new Date().toLocaleDateString()}.pdf`);
  };

  // --- Excel Templates & Upload ---
  const downloadTemplate = (type) => {
    if (!window.XLSX) return message.error('Excel Library not loaded');
    const templates = {
      livestock: [['Date', 'Category', 'ExpenseType', 'Amount', 'ManagedBy', 'Description']],
      crops: [['Date', 'CropName', 'ExpenseType', 'Amount', 'ManagedBy', 'Description']],
      water: [['Date', 'FarmerName', 'StartTime', 'EndTime', 'Rate', 'PaidAmount']],
    };
    const ws = window.XLSX.utils.aoa_to_sheet(templates[type]);
    const wb = window.XLSX.utils.book_new();
    window.XLSX.utils.book_append_sheet(wb, ws, "Template");
    window.XLSX.writeFile(wb, `${type}_template.xlsx`);
  };

  const handleUpload = (file, type) => {
    if (!window.XLSX) return false;
    const reader = new FileReader();
    reader.onload = async (e) => {
      const data = new Uint8Array(e.target.result);
      const workbook = window.XLSX.read(data, { type: 'array' });
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = window.XLSX.utils.sheet_to_json(sheet);
      
      for (const item of json) {
        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', type), {
          ...item,
          createdAt: new Date().toISOString()
        });
      }
      message.success(`Uploaded ${json.length} records to ${type}`);
    };
    reader.readAsArrayBuffer(file);
    return false;
  };

  // --- Column Definitions ---
  const commonColumns = (colName) => [
    { title: 'Date', dataIndex: 'date', key: 'date' },
    { title: 'Managed By', dataIndex: 'managedBy', key: 'managedBy' },
    { title: 'Amount', dataIndex: 'amount', key: 'amount', render: (val) => `PKR ${val}` },
    {
      title: 'Action',
      key: 'action',
      render: (_, record) => (
        <Space size="middle">
          <Button type="link" onClick={() => { setEditingItem(record); form.setFieldsValue(record); setIsModalOpen(true); }}>Edit</Button>
          <Button type="link" danger onClick={() => handleDelete(record.id, colName)}>Delete</Button>
        </Space>
      ),
    },
  ];

  const livestockColumns = [
    { title: 'Category', dataIndex: 'category', key: 'category' },
    { title: 'Item (Khal/Fodder)', dataIndex: 'expenseType', key: 'expenseType' },
    ...commonColumns('livestock')
  ];

  const cropColumns = [
    { title: 'Crop Name', dataIndex: 'cropName', key: 'cropName' },
    { title: 'Type (Seed/Fertilizer)', dataIndex: 'expenseType', key: 'expenseType' },
    ...commonColumns('crops')
  ];

  const waterColumns = [
    { title: 'Farmer', dataIndex: 'farmerName', key: 'farmerName' },
    { 
      title: 'Calculation', 
      key: 'calc', 
      render: (_, r) => {
        const hours = (r.endTime - r.startTime) || 0;
        const total = hours * r.rate;
        return `(${r.startTime}-${r.endTime}) x ${r.rate} = ${total}`;
      }
    },
    { title: 'Total Bill', key: 'total', render: (_, r) => (r.endTime - r.startTime) * r.rate },
    { title: 'Paid', dataIndex: 'paidAmount', key: 'paid' },
    { 
      title: 'Balance', 
      key: 'balance', 
      render: (_, r) => ((r.endTime - r.startTime) * r.rate) - (r.paidAmount || 0),
      className: 'font-bold text-red-500'
    },
    ...commonColumns('water').filter(c => c.key !== 'amount')
  ];

  // --- Totals Logic ---
  const stats = useMemo(() => {
    const livestockExp = livestockData.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
    const cropExp = cropData.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
    const otherExp = otherExpenses.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);
    const waterIncome = waterData.reduce((acc, curr) => acc + (Number(curr.paidAmount) || 0), 0);
    const generalIncome = incomeData.reduce((acc, curr) => acc + (Number(curr.amount) || 0), 0);

    return {
      totalExp: livestockExp + cropExp + otherExp,
      totalIncome: waterIncome + generalIncome,
      net: (waterIncome + generalIncome) - (livestockExp + cropExp + otherExp)
    };
  }, [livestockData, cropData, otherExpenses, waterData, incomeData]);

  return (
    <Layout className="min-h-screen bg-gray-50">
      <Header className="bg-green-800 flex items-center justify-between px-8 h-16">
        <div className="text-white text-xl font-bold flex items-center gap-2">
          <EnvironmentOutlined /> GreenLeaf Farm Management
        </div>
        <div className="text-white opacity-80">
          User ID: {user?.uid || 'Authenticating...'}
        </div>
      </Header>

      <Content className="p-4 md:p-8">
        <Row gutter={[16, 16]} className="mb-8">
          <Col xs={24} sm={8}>
            <Card className="shadow-sm border-0 border-l-4 border-l-red-500">
              <Statistic title="Total Expenses" value={stats.totalExp} prefix="PKR" />
            </Card>
          </Col>
          <Col xs={24} sm={8}>
            <Card className="shadow-sm border-0 border-l-4 border-l-green-500">
              <Statistic title="Total Income" value={stats.totalIncome} prefix="PKR" />
            </Card>
          </Col>
          <Col xs={24} sm={8}>
            <Card className="shadow-sm border-0 border-l-4 border-l-blue-500">
              <Statistic title="Net Balance" value={stats.net} prefix="PKR" />
            </Card>
          </Col>
        </Row>

        <Card className="shadow-md rounded-lg">
          <Tabs 
            activeKey={activeTab} 
            onChange={setActiveTab}
            items={[
              {
                key: '1',
                label: <span><StockOutlined /> Livestock</span>,
                children: (
                  <div>
                    <div className="flex justify-between mb-4 flex-wrap gap-2">
                      <Space wrap>
                        <Button type="primary" icon={<PlusOutlined />} onClick={() => { setEditingItem(null); form.resetFields(); setIsModalOpen(true); }}>Add Livestock Entry</Button>
                        <Button icon={<DownloadOutlined />} onClick={() => downloadTemplate('livestock')}>Template</Button>
                        <Upload beforeUpload={(file) => handleUpload(file, 'livestock')} showUploadList={false}>
                          <Button icon={<UploadOutlined />}>Upload Excel</Button>
                        </Upload>
                      </Space>
                      <Button icon={<FilePdfOutlined />} onClick={() => generatePDF('Livestock Report', livestockData, livestockColumns)}>Export PDF</Button>
                    </div>
                    <Table dataSource={livestockData} columns={livestockColumns} rowKey="id" pagination={{ pageSize: 5 }} scroll={{ x: true }} />
                  </div>
                )
              },
              {
                key: '2',
                label: <span><TableOutlined /> Crops</span>,
                children: (
                  <div>
                    <div className="flex justify-between mb-4 flex-wrap gap-2">
                      <Space wrap>
                        <Button type="primary" icon={<PlusOutlined />} onClick={() => { setEditingItem(null); form.resetFields(); setIsModalOpen(true); }}>Add Crop Entry</Button>
                        <Button icon={<DownloadOutlined />} onClick={() => downloadTemplate('crops')}>Template</Button>
                        <Upload beforeUpload={(file) => handleUpload(file, 'crops')} showUploadList={false}>
                          <Button icon={<UploadOutlined />}>Upload Excel</Button>
                        </Upload>
                      </Space>
                      <Button icon={<FilePdfOutlined />} onClick={() => generatePDF('Crops Report', cropData, cropColumns)}>Export PDF</Button>
                    </div>
                    <Table dataSource={cropData} columns={cropColumns} rowKey="id" pagination={{ pageSize: 5 }} scroll={{ x: true }} />
                  </div>
                )
              },
              {
                key: '3',
                label: <span><WalletOutlined /> Water Supply</span>,
                children: (
                  <div>
                    <div className="flex justify-between mb-4 flex-wrap gap-2">
                      <Space wrap>
                        <Button type="primary" icon={<PlusOutlined />} onClick={() => { setEditingItem(null); form.resetFields(); setIsModalOpen(true); }}>New Billing</Button>
                        <Button icon={<DownloadOutlined />} onClick={() => downloadTemplate('water')}>Template</Button>
                      </Space>
                      <Button icon={<FilePdfOutlined />} onClick={() => generatePDF('Water Supply Ledger', waterData, waterColumns)}>Export PDF</Button>
                    </div>
                    <Table dataSource={waterData} columns={waterColumns} rowKey="id" scroll={{ x: true }} />
                  </div>
                )
              },
              {
                key: '4',
                label: <span><UserOutlined /> Salaries & Expenses</span>,
                children: (
                  <div>
                    <div className="flex justify-between mb-4 flex-wrap gap-2">
                      <Button type="primary" icon={<PlusOutlined />} onClick={() => { setEditingItem(null); form.resetFields(); setIsModalOpen(true); }}>Add Other Expense</Button>
                      <Button icon={<FilePdfOutlined />} onClick={() => generatePDF('General Expenses', otherExpenses, commonColumns('expenses'))}>Export PDF</Button>
                    </div>
                    <Table dataSource={otherExpenses} columns={commonColumns('expenses')} rowKey="id" scroll={{ x: true }} />
                  </div>
                )
              },
              {
                key: '6',
                label: <span><DashboardOutlined /> Consolidated Reports</span>,
                children: (
                  <div className="space-y-6">
                    <Row gutter={[16, 16]}>
                      <Col xs={24} md={12}>
                        <Card title="Expense Breakdown" size="small">
                          <List
                            itemLayout="horizontal"
                            dataSource={[
                              { label: 'Livestock', val: livestockData.reduce((a,c) => a+(Number(c.amount)||0), 0) },
                              { label: 'Crops', val: cropData.reduce((a,c) => a+(Number(c.amount)||0), 0) },
                              { label: 'General', val: otherExpenses.reduce((a,c) => a+(Number(c.amount)||0), 0) },
                            ]}
                            renderItem={item => (
                              <List.Item extra={<strong>PKR {item.val}</strong>}>
                                {item.label}
                              </List.Item>
                            )}
                          />
                        </Card>
                      </Col>
                      <Col xs={24} md={12}>
                        <Card title="Managed By (Accountability)" size="small">
                          <List
                            itemLayout="horizontal"
                            dataSource={Array.from(new Set([...livestockData, ...cropData, ...otherExpenses].map(x => x.managedBy))).filter(Boolean)}
                            renderItem={manager => {
                              const total = [...livestockData, ...cropData, ...otherExpenses]
                                .filter(x => x.managedBy === manager)
                                .reduce((a,c) => a+(Number(c.amount)||0), 0);
                              return (
                                <List.Item extra={<Tag color="orange">PKR {total}</Tag>}>
                                  {manager}
                                </List.Item>
                              );
                            }}
                          />
                        </Card>
                      </Col>
                    </Row>
                    <Divider />
                    <div className="text-center">
                      <Button type="primary" size="large" icon={<FilePdfOutlined />} onClick={() => {
                        const allData = [
                          ...livestockData.map(d => ({ ...d, source: 'Livestock' })),
                          ...cropData.map(d => ({ ...d, source: 'Crops' })),
                          ...otherExpenses.map(d => ({ ...d, source: 'General' }))
                        ];
                        generatePDF('Full Farm Summary Report', allData, [
                          { title: 'Source', dataIndex: 'source' },
                          { title: 'Date', dataIndex: 'date' },
                          { title: 'Amount', dataIndex: 'amount' },
                          { title: 'Managed By', dataIndex: 'managedBy' }
                        ]);
                      }}>Download Full Monthly Report (PDF)</Button>
                    </div>
                  </div>
                )
              }
            ]}
          />
        </Card>

        {/* --- Entry Modal --- */}
        <Modal
          title={editingItem ? "Edit Entry" : "New Entry"}
          open={isModalOpen}
          onCancel={() => setIsModalOpen(false)}
          onOk={() => form.submit()}
          destroyOnClose
        >
          <Form form={form} layout="vertical" onFinish={handleSave}>
            <Row gutter={16}>
              <Col span={12}>
                <Form.Item name="date" label="Date" rules={[{ required: true }]}>
                  <DatePicker className="w-full" />
                </Form.Item>
              </Col>
              <Col span={12}>
                <Form.Item name="managedBy" label="Managed By (Ledger)" rules={[{ required: true }]}>
                  <Input placeholder="Person Name" />
                </Form.Item>
              </Col>
            </Row>

            {activeTab === '1' && (
              <>
                <Form.Item name="category" label="Category" rules={[{ required: true }]}>
                  <Select placeholder="Select Category">
                    {LIVESTOCK_CATS.map(c => <Option key={c} value={c}>{c}</Option>)}
                  </Select>
                </Form.Item>
                <Form.Item name="expenseType" label="Expense Item" rules={[{ required: true }]}>
                  <Select placeholder="Select Item">
                    {['Khal', 'Chokar', 'Tori', 'Grass', 'Medicine', 'Others'].map(i => <Option key={i} value={i}>{i}</Option>)}
                  </Select>
                </Form.Item>
              </>
            )}

            {activeTab === '2' && (
              <>
                <Form.Item name="cropName" label="Crop Name" rules={[{ required: true }]}>
                  <Input placeholder="e.g. Wheat, Sugarcane" />
                </Form.Item>
                <Form.Item name="expenseType" label="Expense Type" rules={[{ required: true }]}>
                  <Select>
                    {CROP_EXPENSE_TYPES.map(t => <Option key={t} value={t}>{t}</Option>)}
                  </Select>
                </Form.Item>
              </>
            )}

            {activeTab === '3' && (
              <>
                <Form.Item name="farmerName" label="Farmer Name" rules={[{ required: true }]}>
                  <Input />
                </Form.Item>
                <Row gutter={16}>
                  <Col span={8}><Form.Item name="startTime" label="Start Time (Hour)"><InputNumber className="w-full" min={0} /></Form.Item></Col>
                  <Col span={8}><Form.Item name="endTime" label="End Time (Hour)"><InputNumber className="w-full" min={0} /></Form.Item></Col>
                  <Col span={8}><Form.Item name="rate" label="Rate/Hour"><InputNumber className="w-full" min={0} /></Form.Item></Col>
                </Row>
                <Form.Item name="paidAmount" label="Payment Received">
                  <InputNumber className="w-full" placeholder="Initial Payment" />
                </Form.Item>
              </>
            )}

            {activeTab !== '3' && (
              <Form.Item name="amount" label="Amount (PKR)" rules={[{ required: true }]}>
                <InputNumber className="w-full" min={0} />
              </Form.Item>
            )}

            <Form.Item name="description" label="Notes/Description">
              <Input.TextArea />
            </Form.Item>
          </Form>
        </Modal>
      </Content>

      <style>{`
        .ant-layout-header { line-height: 64px; }
        .shadow-sm { box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .shadow-md { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .w-full { width: 100%; }
        .ant-card { border-radius: 8px; }
      `}</style>
    </Layout>
  );
};

export default App;
