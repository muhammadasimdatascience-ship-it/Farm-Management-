<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-green: #2E8B57;
            --light-green: #90EE90;
            --dark-green: #228B22;
            --gold: #FFD700;
            --blue: #4169E1;
            --red: #DC3545;
            --orange: #FD7E14;
            --purple: #6F42C1;
        }
        
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .sidebar {
            background: white;
            min-height: calc(100vh - 80px);
            box-shadow: 3px 0 15px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 0;
            padding-top: 20px;
        }
        
        .sidebar .nav-link {
            color: #495057;
            padding: 14px 20px;
            margin: 5px 10px;
            border-radius: 8px;
            border-left: 5px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .sidebar .nav-link:hover {
            background: linear-gradient(90deg, rgba(46, 139, 87, 0.1), rgba(144, 238, 144, 0.1));
            color: var(--dark-green);
            transform: translateX(5px);
        }
        
        .sidebar .nav-link.active {
            background: linear-gradient(90deg, var(--primary-green), var(--light-green));
            color: white;
            border-left: 5px solid var(--gold);
            box-shadow: 0 4px 8px rgba(46, 139, 87, 0.2);
        }
        
        .main-content {
            padding: 25px;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 25px;
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            color: white;
            border-bottom: none;
            padding: 20px;
            font-weight: 600;
        }
        
        .card-header h5 {
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .stat-card {
            color: white;
            padding: 25px 20px;
            border-radius: 12px;
            text-align: center;
            height: 100%;
        }
        
        .stat-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .stat-card h3 {
            font-size: 2.2rem;
            font-weight: 700;
            margin: 10px 0;
        }
        
        .stat-card p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(46, 139, 87, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            border: none;
            border-radius: 8px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--gold), #FFA500);
            border: none;
            border-radius: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--red), #FF6B6B);
            border: none;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .btn-info {
            background: linear-gradient(135deg, var(--blue), #6EA8FE);
            border: none;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .form-control, .form-select {
            border-radius: 8px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 0.25rem rgba(46, 139, 87, 0.25);
            transform: translateY(-2px);
        }
        
        .table {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }
        
        .table th {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            color: white;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table td {
            padding: 15px;
            vertical-align: middle;
            border-color: #f1f3f4;
        }
        
        .table tbody tr {
            transition: all 0.2s ease;
        }
        
        .table tbody tr:hover {
            background-color: rgba(46, 139, 87, 0.05);
            transform: scale(1.002);
        }
        
        .table .btn-sm {
            padding: 6px 12px;
            border-radius: 6px;
        }
        
        .currency {
            font-family: 'Courier New', monospace;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .income {
            color: var(--primary-green);
            background: rgba(46, 139, 87, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .expense {
            color: var(--red);
            background: rgba(220, 53, 69, 0.1);
            padding: 4px 10px;
            border-radius: 4px;
            display: inline-block;
        }
        
        .balance-positive {
            color: var(--primary-green);
            font-weight: 700;
        }
        
        .balance-negative {
            color: var(--red);
            font-weight: 700;
        }
        
        .modal-content {
            border-radius: 12px;
            border: none;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
            color: white;
            border-radius: 12px 12px 0 0;
            padding: 20px;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .tab-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.08);
        }
        
        .dashboard-icon {
            font-size: 3.5rem;
            color: var(--primary-green);
            margin-bottom: 20px;
            opacity: 0.8;
        }
        
        .dashboard-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-stat {
            flex: 1;
            min-width: 200px;
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .dashboard-stat:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .dashboard-stat h3 {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-green);
            margin: 15px 0;
        }
        
        .dashboard-stat p {
            color: #6c757d;
            font-weight: 500;
        }
        
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification.success {
            background: linear-gradient(135deg, var(--primary-green), var(--dark-green));
        }
        
        .notification.error {
            background: linear-gradient(135deg, var(--red), #FF6B6B);
        }
        
        .notification.info {
            background: linear-gradient(135deg, var(--blue), #6EA8FE);
        }
        
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .excel-upload-area {
            border: 3px dashed #dee2e6;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 20px 0;
        }
        
        .excel-upload-area:hover {
            border-color: var(--primary-green);
            background: rgba(46, 139, 87, 0.05);
        }
        
        .excel-upload-area i {
            font-size: 3rem;
            color: var(--primary-green);
            margin-bottom: 20px;
        }
        
        .date-range-picker {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
        }
        
        .badge {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .badge-success {
            background: linear-gradient(135deg, #28a745, #20c997);
        }
        
        .badge-warning {
            background: linear-gradient(135deg, var(--gold), #FFA500);
            color: #333;
        }
        
        .badge-danger {
            background: linear-gradient(135deg, var(--red), #FF6B6B);
        }
        
        .badge-info {
            background: linear-gradient(135deg, var(--blue), #6EA8FE);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .search-box {
            max-width: 300px;
        }
        
        .pagination {
            justify-content: center;
            margin-top: 30px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: relative;
                min-height: auto;
                margin-bottom: 20px;
            }
            
            .main-content {
                padding: 15px;
            }
            
            .dashboard-stat {
                min-width: 100%;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .search-box {
                max-width: 100%;
            }
        }
        
        .print-only {
            display: none;
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block;
            }
            
            body * {
                visibility: hidden;
            }
            
            .tab-content, .tab-content * {
                visibility: visible;
            }
            
            .tab-content {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                box-shadow: none;
            }
        }
        
        /* Water supply table improvements */
        .water-table-actions {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
        }
        
        /* PDF loading indicator */
        .pdf-loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            z-index: 9999;
            display: none;
        }
        
        /* Manager ledger styles */
        .ledger-entry {
            border-left: 4px solid var(--primary-green);
            margin-bottom: 15px;
            padding-left: 15px;
        }
        
        .ledger-entry.payment {
            border-left-color: var(--blue);
        }
        
        .ledger-entry.debit {
            border-left-color: var(--red);
        }
        
        .balance-amount {
            font-weight: bold;
            font-size: 1.1em;
        }
        
        .balance-positive {
            color: var(--primary-green);
        }
        
        .balance-negative {
            color: var(--red);
        }
        
        /* Quick reports tabs */
        .quick-reports-tabs .nav-link {
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 8px;
        }
        
        .report-summary-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .report-summary-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading" id="loading">
        <div class="loader"></div>
    </div>
    
    <!-- PDF Loading Indicator -->
    <div class="pdf-loading" id="pdfLoading">
        <div class="text-center">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Generating PDF...</h5>
            <p>Please wait while the PDF is being generated</p>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tractor me-2"></i>
                Farm Management System
            </a>
            <div class="d-flex align-items-center">
                <div class="me-3 text-white">
                    <i class="fas fa-calendar-alt me-2"></i>
                    <span id="currentDate"></span>
                </div>
                <button class="btn btn-outline-light me-2" onclick="exportAllData()">
                    <i class="fas fa-download me-1"></i> Backup
                </button>
                <button class="btn btn-outline-light" onclick="printCurrentTab()">
                    <i class="fas fa-print me-1"></i> Print
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 sidebar no-print">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="#dashboard" onclick="showTab('dashboard')">
                        <i class="fas fa-home me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#livestock" onclick="showTab('livestock')">
                        <i class="fas fa-cow me-2"></i> Livestock
                    </a>
                    <a class="nav-link" href="#crops" onclick="showTab('crops')">
                        <i class="fas fa-seedling me-2"></i> Crops
                    </a>
                    <a class="nav-link" href="#water" onclick="showTab('water')">
                        <i class="fas fa-tint me-2"></i> Water Supply
                    </a>
                    <a class="nav-link" href="#expenses" onclick="showTab('expenses')">
                        <i class="fas fa-money-bill-wave me-2"></i> Expenses
                    </a>
                    <a class="nav-link" href="#income" onclick="showTab('income')">
                        <i class="fas fa-chart-line me-2"></i> Income
                    </a>
                    <a class="nav-link" href="#reports" onclick="showTab('reports')">
                        <i class="fas fa-file-alt me-2"></i> Reports
                    </a>
                </nav>
                
                <div class="mt-4 p-3">
                    <h6 class="text-muted mb-3"><i class="fas fa-database me-2"></i>Data Management</h6>
                    <button class="btn btn-outline-primary w-100 mb-2" onclick="exportAllData()">
                        <i class="fas fa-download me-1"></i> Export All
                    </button>
                    <button class="btn btn-outline-success w-100 mb-2" onclick="document.getElementById('importFile').click()">
                        <i class="fas fa-upload me-1"></i> Import Data
                    </button>
                    <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
                    <button class="btn btn-outline-danger w-100" onclick="clearAllData()">
                        <i class="fas fa-trash me-1"></i> Clear All
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content main-content">
                    <h2 class="mb-4"><i class="fas fa-chart-pie text-primary me-2"></i>Dashboard Overview</h2>
                    
                    <div class="dashboard-stats">
                        <div class="dashboard-stat">
                            <i class="fas fa-cow dashboard-icon"></i>
                            <h3 id="totalLivestock">0</h3>
                            <p>Total Livestock</p>
                        </div>
                        <div class="dashboard-stat">
                            <i class="fas fa-seedling dashboard-icon"></i>
                            <h3 id="totalCrops">0</h3>
                            <p>Crop Types</p>
                        </div>
                        <div class="dashboard-stat">
                            <i class="fas fa-money-bill-wave dashboard-icon"></i>
                            <h3 id="totalIncome">Rs 0</h3>
                            <p>Total Income</p>
                        </div>
                        <div class="dashboard-stat">
                            <i class="fas fa-coins dashboard-icon"></i>
                            <h3 id="totalExpenses">Rs 0</h3>
                            <p>Total Expenses</p>
                        </div>
                        <div class="dashboard-stat">
                            <i class="fas fa-tint dashboard-icon"></i>
                            <h3 id="totalFarmers">0</h3>
                            <p>Farmers Registered</p>
                        </div>
                        <div class="dashboard-stat">
                            <i class="fas fa-chart-line dashboard-icon"></i>
                            <h3 id="netProfit">Rs 0</h3>
                            <p>Net Profit</p>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar me-2"></i>Monthly Financial Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="monthlyChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-3">
                                        <button class="btn btn-primary" onclick="showTab('livestock')">
                                            <i class="fas fa-plus me-2"></i>Add Livestock Entry
                                        </button>
                                        <button class="btn btn-success" onclick="showTab('crops')">
                                            <i class="fas fa-plus me-2"></i>Add Crop Entry
                                        </button>
                                        <button class="btn btn-info" onclick="showTab('water')">
                                            <i class="fas fa-plus me-2"></i>Add Water Bill
                                        </button>
                                        <button class="btn btn-warning" onclick="generateMonthlyReport()">
                                            <i class="fas fa-file-pdf me-2"></i>Generate Monthly Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-history me-2"></i>Recent Transactions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentTransactions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-exclamation-triangle me-2"></i>Alerts & Notifications</h5>
                                </div>
                                <div class="card-body">
                                    <div id="alertsContainer"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 01: Livestock -->
                <div id="livestock" class="tab-content main-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-cow text-primary me-2"></i>Livestock Management</h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="downloadExcelTemplate('livestock')">
                                <i class="fas fa-file-excel me-1"></i> Excel Template
                            </button>
                            <button class="btn btn-primary" onclick="showImportModal('livestock')">
                                <i class="fas fa-upload me-1"></i> Import Excel
                            </button>
                            <button class="btn btn-warning" onclick="exportToExcel('livestock')">
                                <i class="fas fa-download me-1"></i> Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-plus-circle me-2"></i>Add Livestock Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="livestockForm" onsubmit="return saveLivestockEntry(event)">
                                        <div class="mb-3">
                                            <label class="form-label">Category *</label>
                                            <select class="form-select" id="livestockCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="Cow">Cow</option>
                                                <option value="Beef">Beef</option>
                                                <option value="Goat">Goat</option>
                                                <option value="Sheep">Sheep</option>
                                                <option value="Buffalo">Buffalo</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Animal Name/ID *</label>
                                            <input type="text" class="form-control" id="animalName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Tag Number</label>
                                            <input type="text" class="form-control" id="tagNumber">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expense Type</label>
                                            <select class="form-select" id="expenseType">
                                                <option value="">Select Expense Type</option>
                                                <option value="Khal">Khal</option>
                                                <option value="Chokar">Chokar</option>
                                                <option value="Tori">Tori</option>
                                                <option value="Ghaas">Ghaas (Grass/Fodder)</option>
                                                <option value="Medical">Medical</option>
                                                <option value="Vaccination">Vaccination</option>
                                                <option value="Labor">Labor</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Expense Amount (Rs)</label>
                                                <input type="number" class="form-control" id="expenseAmount" min="0" step="1">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Income Amount (Rs)</label>
                                                <input type="number" class="form-control" id="incomeAmount" min="0" step="1">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By</label>
                                            <input type="text" class="form-control" id="managedBy" placeholder="Person responsible">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="entryDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="description" rows="3" placeholder="Additional notes..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Quick Stats -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Livestock Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div id="livestockStats"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-list me-2"></i>Livestock Records</h5>
                                </div>
                                <div class="card-body">
                                    <div class="date-range-picker">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="livestockFromDate">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="livestockToDate">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Category</label>
                                                <select class="form-select" id="livestockFilterCategory">
                                                    <option value="">All</option>
                                                    <option value="Cow">Cow</option>
                                                    <option value="Beef">Beef</option>
                                                    <option value="Goat">Goat</option>
                                                    <option value="Others">Others</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="filterLivestockRecords()">
                                                    <i class="fas fa-filter me-1"></i> Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Category</th>
                                                    <th>Animal</th>
                                                    <th>Type</th>
                                                    <th>Expense</th>
                                                    <th>Income</th>
                                                    <th>Managed By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="livestockTable"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted" id="livestockCount">Showing 0 records</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary" onclick="generateLivestockPDF()">
                                                <i class="fas fa-file-pdf me-2"></i>Generate PDF
                                            </button>
                                            <button class="btn btn-success ms-2" onclick="generateLivestockLedger()">
                                                <i class="fas fa-book me-2"></i>View Ledger
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 02: Crops -->
                <div id="crops" class="tab-content main-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-seedling text-primary me-2"></i>Crop Management</h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="downloadExcelTemplate('crops')">
                                <i class="fas fa-file-excel me-1"></i> Excel Template
                            </button>
                            <button class="btn btn-primary" onclick="showImportModal('crops')">
                                <i class="fas fa-upload me-1"></i> Import Excel
                            </button>
                            <button class="btn btn-warning" onclick="exportToExcel('crops')">
                                <i class="fas fa-download me-1"></i> Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-plus-circle me-2"></i>Add Crop Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="cropForm" onsubmit="return saveCropEntry(event)">
                                        <div class="mb-3">
                                            <label class="form-label">Crop Name *</label>
                                            <input type="text" class="form-control" id="cropName" required placeholder="e.g., Wheat, Rice, Cotton">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expense Type *</label>
                                            <select class="form-select" id="cropExpenseType" required>
                                                <option value="">Select Type</option>
                                                <option value="Labor">Labor</option>
                                                <option value="Seeds">Seeds (Beej)</option>
                                                <option value="Fertilizer">Fertilizer (Khaad)</option>
                                                <option value="Spray">Spray</option>
                                                <option value="Irrigation">Irrigation</option>
                                                <option value="Pesticide">Pesticide</option>
                                                <option value="Harvesting">Harvesting</option>
                                                <option value="Transport">Transport</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Expense Amount (Rs) *</label>
                                                <input type="number" class="form-control" id="cropExpenseAmount" required min="0" step="1">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Income Amount (Rs)</label>
                                                <input type="number" class="form-control" id="cropIncome" min="0" step="1">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Area (Acres)</label>
                                                <input type="number" class="form-control" id="cropArea" step="0.01" min="0">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">Yield (Kg)</label>
                                                <input type="number" class="form-control" id="cropYield" step="1" min="0">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By</label>
                                            <input type="text" class="form-control" id="cropManagedBy" placeholder="Person responsible">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="cropDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="cropDescription" rows="3" placeholder="Additional notes..."></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Crop Stats -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar me-2"></i>Crop Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div id="cropStats"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-list me-2"></i>Crop Records</h5>
                                </div>
                                <div class="card-body">
                                    <div class="date-range-picker">
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="cropFromDate">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="cropToDate">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label">Crop Type</label>
                                                <select class="form-select" id="cropFilterType">
                                                    <option value="">All</option>
                                                    <option value="Wheat">Wheat</option>
                                                    <option value="Rice">Rice</option>
                                                    <option value="Cotton">Cotton</option>
                                                    <option value="Sugarcane">Sugarcane</option>
                                                    <option value="Maize">Maize</option>
                                                    <option value="Others">Others</option>
                                                </select>
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="filterCropRecords()">
                                                    <i class="fas fa-filter me-1"></i> Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Crop</th>
                                                    <th>Type</th>
                                                    <th>Expense</th>
                                                    <th>Income</th>
                                                    <th>Area</th>
                                                    <th>Managed By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cropTable"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted" id="cropCount">Showing 0 records</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary" onclick="generateCropPDF()">
                                                <i class="fas fa-file-pdf me-2"></i>Generate PDF
                                            </button>
                                            <button class="btn btn-success ms-2" onclick="generateCropLedger()">
                                                <i class="fas fa-book me-2"></i>View Ledger
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 03: Water Supply -->
                <div id="water" class="tab-content main-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-tint text-primary me-2"></i>Water Supply Management</h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="downloadExcelTemplate('water')">
                                <i class="fas fa-file-excel me-1"></i> Excel Template
                            </button>
                            <button class="btn btn-primary" onclick="showImportModal('water')">
                                <i class="fas fa-upload me-1"></i> Import Excel
                            </button>
                            <button class="btn btn-warning" onclick="exportToExcel('water')">
                                <i class="fas fa-download me-1"></i> Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-plus-circle me-2"></i>Water Billing Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="waterForm" onsubmit="return saveWaterEntry(event)">
                                        <input type="hidden" id="waterEntryId">
                                        <div class="mb-3">
                                            <label class="form-label">Farmer Name *</label>
                                            <input type="text" class="form-control" id="farmerName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Father Name</label>
                                            <input type="text" class="form-control" id="fatherName">
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">Start Time *</label>
                                                <input type="datetime-local" class="form-control" id="startTime" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">End Time *</label>
                                                <input type="datetime-local" class="form-control" id="endTime" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Rate (Rs per hour) *</label>
                                            <input type="number" class="form-control" id="waterRate" value="100" min="0" step="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Payment Received (Rs)</label>
                                            <input type="number" class="form-control" id="paymentReceived" min="0" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Payment Date</label>
                                            <input type="date" class="form-control" id="paymentDate">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Billing Date *</label>
                                            <input type="date" class="form-control" id="waterDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By *</label>
                                            <input type="text" class="form-control" id="waterManagedBy" placeholder="Person responsible" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="waterDescription" rows="2" placeholder="Additional notes..."></textarea>
                                        </div>
                                        <div class="alert alert-info">
                                            <div class="d-flex justify-content-between">
                                                <span><strong>Calculated Bill:</strong></span>
                                                <span id="calculatedBill" class="fw-bold fs-5">Rs 0</span>
                                            </div>
                                            <div class="mt-2">
                                                <small>Hours: <span id="calculatedHours">0</span> | Rate: Rs <span id="rateDisplay">100</span>/hr</small>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                            
                            <!-- Water Stats -->
                            <div class="card mt-4">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-line me-2"></i>Water Supply Stats</h5>
                                </div>
                                <div class="card-body">
                                    <div id="waterStats"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-users me-2"></i>Water Supply Records</h5>
                                        <div class="search-box">
                                            <input type="text" class="form-control" id="waterSearch" placeholder="Search farmer...">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="date-range-picker">
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="waterFromDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="waterToDate">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label">Managed By</label>
                                                <select class="form-select" id="waterFilterManager">
                                                    <option value="">All Managers</option>
                                                </select>
                                            </div>
                                            <div class="col-md-3 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="filterWaterRecords()">
                                                    <i class="fas fa-filter me-1"></i> Filter
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Farmer</th>
                                                    <th>Hours</th>
                                                    <th>Rate</th>
                                                    <th>Total Bill</th>
                                                    <th>Paid</th>
                                                    <th>Balance</th>
                                                    <th>Managed By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="waterTable"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted" id="waterCount">Showing 0 records</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary" onclick="generateWaterPDF()">
                                                <i class="fas fa-file-pdf me-2"></i>Generate PDF
                                            </button>
                                            <button class="btn btn-success ms-2" onclick="showAllLedgers()">
                                                <i class="fas fa-book me-2"></i>All Ledgers
                                            </button>
                                            <button class="btn btn-info ms-2" onclick="showManagerLedger()">
                                                <i class="fas fa-user-tie me-2"></i>Manager Ledger
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 04: Expenses -->
                <div id="expenses" class="tab-content main-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-money-bill-wave text-primary me-2"></i>Expense Management</h2>
                        <div class="action-buttons">
                            <button class="btn btn-success" onclick="downloadExcelTemplate('expenses')">
                                <i class="fas fa-file-excel me-1"></i> Excel Template
                            </button>
                            <button class="btn btn-primary" onclick="showImportModal('expenses')">
                                <i class="fas fa-upload me-1"></i> Import Excel
                            </button>
                            <button class="btn btn-warning" onclick="exportToExcel('expenses')">
                                <i class="fas fa-download me-1"></i> Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--red), #FF6B6B);">
                                <i class="fas fa-coins"></i>
                                <h3 id="totalExpensesAmount">Rs 0</h3>
                                <p>Total Expenses</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--orange), #FD9843);">
                                <i class="fas fa-calendar-alt"></i>
                                <h3 id="monthlyExpenses">Rs 0</h3>
                                <p>This Month</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, var(--purple), #A370F7);">
                                <i class="fas fa-user-tie"></i>
                                <h3 id="managedExpenses">Rs 0</h3>
                                <p>Managed Expenses</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card" style="background: linear-gradient(135deg, #20c997, #3DD9D6);">
                                <i class="fas fa-percentage"></i>
                                <h3 id="expenseGrowth">0%</h3>
                                <p>Growth Rate</p>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-plus-circle me-2"></i>Add Expense</h5>
                                </div>
                                <div class="card-body">
                                    <form id="expenseForm" onsubmit="return saveExpense(event)">
                                        <div class="mb-3">
                                            <label class="form-label">Expense Category *</label>
                                            <select class="form-select" id="expenseCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="Salary">Salaries</option>
                                                <option value="Livestock">Livestock Expenses</option>
                                                <option value="Crop">Crop Expenses</option>
                                                <option value="Machinery">Machinery</option>
                                                <option value="Maintenance">Maintenance</option>
                                                <option value="Utilities">Utilities</option>
                                                <option value="Transport">Transport</option>
                                                <option value="Marketing">Marketing</option>
                                                <option value="Office">Office Expenses</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Amount (Rs) *</label>
                                            <input type="number" class="form-control" id="expenseAmountMain" required min="0" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By *</label>
                                            <input type="text" class="form-control" id="expenseManagedBy" required placeholder="Person responsible">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Payment Method</label>
                                            <select class="form-select" id="paymentMethod">
                                                <option value="Cash">Cash</option>
                                                <option value="Bank Transfer">Bank Transfer</option>
                                                <option value="Cheque">Cheque</option>
                                                <option value="Digital">Digital Payment</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description *</label>
                                            <textarea class="form-control" id="expenseDescription" rows="3" required placeholder="Purpose of expense..."></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date *</label>
                                            <input type="date" class="form-control" id="expenseDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Receipt/Invoice No.</label>
                                            <input type="text" class="form-control" id="receiptNumber" placeholder="If available">
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Expense
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Expense Records</h5>
                                        <div class="search-box">
                                            <input type="text" class="form-control" id="expenseSearch" placeholder="Search expenses...">
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Category</th>
                                                    <th>Amount</th>
                                                    <th>Managed By</th>
                                                    <th>Description</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expenseTable"></tbody>
                                        </table>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-center mt-3">
                                        <div>
                                            <span class="text-muted" id="expenseCount">Showing 0 expenses</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-primary" onclick="generateExpensePDF()">
                                                <i class="fas fa-file-pdf me-2"></i>Generate PDF
                                            </button>
                                            <button class="btn btn-success ms-2" onclick="generateExpenseAnalysis()">
                                                <i class="fas fa-chart-pie me-2"></i>Analysis
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 05: Income -->
                <div id="income" class="tab-content main-content" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h2><i class="fas fa-chart-line text-primary me-2"></i>Income Consolidated</h2>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="generateIncomePDF()">
                                <i class="fas fa-file-pdf me-1"></i> PDF Report
                            </button>
                            <button class="btn btn-success" onclick="exportToExcel('income')">
                                <i class="fas fa-file-excel me-1"></i> Export Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar me-2"></i>Income Distribution</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="incomeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-info-circle me-2"></i>Income Summary</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <h6>Total Income</h6>
                                        <h3 id="incomeTotal" class="text-success">Rs 0</h3>
                                    </div>
                                    <div class="mb-3">
                                        <h6>This Month</h6>
                                        <h4 id="incomeThisMonth" class="text-primary">Rs 0</h4>
                                    </div>
                                    <div class="mb-3">
                                        <h6>Last Month</h6>
                                        <h4 id="incomeLastMonth" class="text-info">Rs 0</h4>
                                    </div>
                                    <div>
                                        <h6>Growth Rate</h6>
                                        <h4 id="incomeGrowth" class="text-success">0%</h4>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Income Sources</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Source</th>
                                                <th>Amount</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incomeSources"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-calendar-alt me-2"></i>Monthly Income Trend</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Livestock</th>
                                                <th>Crops</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthlyIncome"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 06: Reports -->
                <div id="reports" class="tab-content main-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-file-alt text-primary me-2"></i>Reports & Analytics</h2>
                    
                    <!-- Quick Reports Tabs -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5><i class="fas fa-bolt me-2"></i>Quick Reports</h5>
                        </div>
                        <div class="card-body">
                            <ul class="nav nav-pills nav-fill quick-reports-tabs mb-3" id="quickReportsTab" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="today-tab" data-bs-toggle="pill" data-bs-target="#today" type="button" role="tab" onclick="generateTodayReport()">
                                        <i class="fas fa-sun me-2"></i>Today
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="weekly-tab" data-bs-toggle="pill" data-bs-target="#weekly" type="button" role="tab" onclick="generateWeeklyReport()">
                                        <i class="fas fa-calendar-week me-2"></i>Weekly
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="monthly-tab" data-bs-toggle="pill" data-bs-target="#monthly" type="button" role="tab" onclick="generateMonthlyReport()">
                                        <i class="fas fa-calendar-alt me-2"></i>Monthly
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="yearly-tab" data-bs-toggle="pill" data-bs-target="#yearly" type="button" role="tab" onclick="generateYearlyReport()">
                                        <i class="fas fa-calendar me-2"></i>Yearly
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="profitloss-tab" data-bs-toggle="pill" data-bs-target="#profitloss" type="button" role="tab" onclick="generateProfitLossReport()">
                                        <i class="fas fa-balance-scale me-2"></i>Profit & Loss
                                    </button>
                                </li>
                            </ul>
                            
                            <div class="tab-content" id="quickReportsTabContent">
                                <div class="tab-pane fade show active" id="today" role="tabpanel">
                                    <div id="todayReportContent" class="text-center py-4">
                                        <p class="text-muted">Click on Today tab to generate report</p>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="weekly" role="tabpanel">
                                    <div id="weeklyReportContent" class="text-center py-4">
                                        <p class="text-muted">Click on Weekly tab to generate report</p>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="monthly" role="tabpanel">
                                    <div id="monthlyReportContent" class="text-center py-4">
                                        <p class="text-muted">Click on Monthly tab to generate report</p>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="yearly" role="tabpanel">
                                    <div id="yearlyReportContent" class="text-center py-4">
                                        <p class="text-muted">Click on Yearly tab to generate report</p>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="profitloss" role="tabpanel">
                                    <div id="profitLossReportContent" class="text-center py-4">
                                        <p class="text-muted">Click on Profit & Loss tab to generate report</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-cogs me-2"></i>Report Generator</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100 text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                                    <h5>Monthly Summary</h5>
                                                    <p class="text-muted">Complete monthly report</p>
                                                    <button class="btn btn-danger w-100" onclick="generateMonthlySummaryPDF()">
                                                        Generate PDF
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100 text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                                    <h5>Financial Analysis</h5>
                                                    <p class="text-muted">Income vs Expenses</p>
                                                    <button class="btn btn-primary w-100" onclick="generateFinancialAnalysis()">
                                                        Generate Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100 text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-user-tie fa-3x text-success mb-3"></i>
                                                    <h5>Managed Expenses</h5>
                                                    <p class="text-muted">By individual</p>
                                                    <button class="btn btn-success w-100" onclick="generateManagedExpensesReport()">
                                                        Generate Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100 text-center">
                                                <div class="card-body">
                                                    <i class="fas fa-tint fa-3x text-info mb-3"></i>
                                                    <h5>Water Bills</h5>
                                                    <p class="text-muted">Water supply report</p>
                                                    <button class="btn btn-info w-100" onclick="generateWaterReportPDF()">
                                                        Generate PDF
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-calendar me-2"></i>Date Range Reports</h5>
                                </div>
                                <div class="card-body">
                                    <form id="reportForm" onsubmit="return generateCustomReport(event)">
                                        <div class="mb-3">
                                            <label class="form-label">Report Type</label>
                                            <select class="form-select" id="reportType" required>
                                                <option value="">Select Report Type</option>
                                                <option value="livestock">Livestock</option>
                                                <option value="crops">Crops</option>
                                                <option value="expenses">Expenses</option>
                                                <option value="income">Income</option>
                                                <option value="water">Water Supply</option>
                                                <option value="all">All Categories</option>
                                            </select>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="reportFromDate" required>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="reportToDate" required>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Report Format</label>
                                            <div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="reportFormat" id="formatPDF" value="pdf" checked>
                                                    <label class="form-check-label" for="formatPDF">PDF</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="reportFormat" id="formatExcel" value="excel">
                                                    <label class="form-check-label" for="formatExcel">Excel</label>
                                                </div>
                                            </div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-chart-bar me-2"></i>Generate Report
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie me-2"></i>Report Statistics</h5>
                                </div>
                                <div class="card-body">
                                    <div id="reportStats">
                                        <div class="row text-center">
                                            <div class="col-6 mb-3">
                                                <div class="p-3 bg-light rounded">
                                                    <h4 id="reportTotalIncome" class="text-success">Rs 0</h4>
                                                    <small>Total Income</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="p-3 bg-light rounded">
                                                    <h4 id="reportTotalExpense" class="text-danger">Rs 0</h4>
                                                    <small>Total Expense</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="p-3 bg-light rounded">
                                                    <h4 id="reportNetProfit" class="text-primary">Rs 0</h4>
                                                    <small>Net Profit</small>
                                                </div>
                                            </div>
                                            <div class="col-6 mb-3">
                                                <div class="p-3 bg-light rounded">
                                                    <h4 id="reportTotalRecords" class="text-info">0</h4>
                                                    <small>Total Records</small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Excel Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="excel-upload-area" id="excelDropArea" onclick="document.getElementById('excelFileInput').click()">
                        <i class="fas fa-file-excel"></i>
                        <h5>Drop Excel file here or click to upload</h5>
                        <p class="text-muted">Supports .xlsx, .xls files</p>
                        <input type="file" id="excelFileInput" style="display:none" accept=".xlsx,.xls" onchange="handleExcelUpload()">
                    </div>
                    <div class="mt-3">
                        <h6>Uploaded Data Preview:</h6>
                        <div class="table-responsive">
                            <table class="table" id="excelPreview">
                                <!-- Excel data preview will be shown here -->
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="currentImportTab">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="confirmImport" onclick="confirmExcelImport()">Import Data</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal for Water Supply -->
    <div class="modal fade" id="editWaterModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Water Supply Entry</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editWaterForm" onsubmit="return updateWaterEntry(event)">
                        <input type="hidden" id="editWaterId">
                        <div class="mb-3">
                            <label class="form-label">Farmer Name *</label>
                            <input type="text" class="form-control" id="editFarmerName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Father Name</label>
                            <input type="text" class="form-control" id="editFatherName">
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">Start Time *</label>
                                <input type="datetime-local" class="form-control" id="editStartTime" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">End Time *</label>
                                <input type="datetime-local" class="form-control" id="editEndTime" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Rate (Rs per hour) *</label>
                            <input type="number" class="form-control" id="editWaterRate" min="0" step="1" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Received (Rs)</label>
                            <input type="number" class="form-control" id="editPaymentReceived" min="0" step="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Date</label>
                            <input type="date" class="form-control" id="editPaymentDate">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Billing Date *</label>
                            <input type="date" class="form-control" id="editWaterDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Managed By *</label>
                            <input type="text" class="form-control" id="editWaterManagedBy" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="editWaterDescription" rows="2"></textarea>
                        </div>
                        <div class="alert alert-info">
                            <div class="d-flex justify-content-between">
                                <span><strong>Calculated Bill:</strong></span>
                                <span id="editCalculatedBill" class="fw-bold fs-5">Rs 0</span>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Entry</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Manager Ledger Modal -->
    <div class="modal fade" id="managerLedgerModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manager Ledger</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <select class="form-select" id="selectManager" onchange="loadManagerLedger(this.value)">
                                <option value="">Select Manager</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <button class="btn btn-primary w-100" onclick="generateManagerLedgerPDF()">
                                <i class="fas fa-file-pdf me-2"></i>Export PDF
                            </button>
                        </div>
                    </div>
                    <div id="managerLedgerContent">
                        <div class="text-center py-5">
                            <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Select a manager to view their ledger</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal fade" id="paymentModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Payment</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="paymentForm" onsubmit="return addPayment(event)">
                        <input type="hidden" id="paymentWaterId">
                        <div class="mb-3">
                            <label class="form-label">Amount (Rs) *</label>
                            <input type="number" class="form-control" id="paymentAmount" required min="0" step="1">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Date *</label>
                            <input type="date" class="form-control" id="newPaymentDate" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Payment Method</label>
                            <select class="form-select" id="paymentMethodSelect">
                                <option value="Cash">Cash</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Digital">Digital Payment</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="paymentDescription" rows="2" placeholder="Payment notes..."></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Payment</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Initialize variables
        let currentUser = 'farm_admin';
        let livestockData = [];
        let cropData = [];
        let waterData = [];
        let expenseData = [];
        let managerLedgers = {};
        let currentChart = null;
        let monthlyChart = null;
        let incomeChart = null;
        let excelPreviewData = [];

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            setupEventListeners();
            loadAllData();
            updateDashboard();
        });

        function initializeApp() {
            // Set current date
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            
            // Set default dates in forms
            const today = now.toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value && !input.hasAttribute('readonly')) {
                    input.value = today;
                }
            });
            
            // Set default datetime
            const nowDateTime = new Date();
            nowDateTime.setMinutes(nowDateTime.getMinutes() - nowDateTime.getTimezoneOffset());
            document.getElementById('startTime').value = nowDateTime.toISOString().slice(0, 16);
            document.getElementById('endTime').value = nowDateTime.toISOString().slice(0, 16);
            document.getElementById('newPaymentDate').value = today;
            
            // Calculate water bill initially
            calculateWaterBill();
            
            // Load data from localStorage
            loadFromLocalStorage();
            
            // Initialize manager ledgers
            initializeManagerLedgers();
        }

        function setupEventListeners() {
            // Water bill calculation
            document.getElementById('startTime').addEventListener('change', calculateWaterBill);
            document.getElementById('endTime').addEventListener('change', calculateWaterBill);
            document.getElementById('waterRate').addEventListener('input', calculateWaterBill);
            
            // Edit water bill calculation
            document.getElementById('editStartTime').addEventListener('change', calculateEditWaterBill);
            document.getElementById('editEndTime').addEventListener('change', calculateEditWaterBill);
            document.getElementById('editWaterRate').addEventListener('input', calculateEditWaterBill);
            
            // Auto-save forms
            setupAutoSave('livestockForm', 'livestock');
            setupAutoSave('cropForm', 'crop');
            setupAutoSave('waterForm', 'water');
            setupAutoSave('expenseForm', 'expense');
            
            // Search functionality
            document.getElementById('expenseSearch').addEventListener('input', filterExpenses);
            document.getElementById('waterSearch').addEventListener('input', filterWaterRecords);
            
            // Drag and drop for Excel upload
            const dropArea = document.getElementById('excelDropArea');
            if (dropArea) {
                dropArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropArea.style.borderColor = 'var(--primary-green)';
                    dropArea.style.background = 'rgba(46, 139, 87, 0.1)';
                });
                
                dropArea.addEventListener('dragleave', () => {
                    dropArea.style.borderColor = '#dee2e6';
                    dropArea.style.background = '#f8f9fa';
                });
                
                dropArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropArea.style.borderColor = '#dee2e6';
                    dropArea.style.background = '#f8f9fa';
                    
                    const files = e.dataTransfer.files;
                    if (files.length > 0 && (files[0].name.endsWith('.xlsx') || files[0].name.endsWith('.xls'))) {
                        handleExcelFile(files[0]);
                    }
                });
            }
        }

        // ========== DATA STORAGE FUNCTIONS ==========
        function loadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('farm_management_data');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    livestockData = data.livestock || [];
                    cropData = data.crops || [];
                    waterData = data.water || [];
                    expenseData = data.expenses || [];
                    managerLedgers = data.managerLedgers || {};
                    
                    // Update all displays
                    updateLivestockDisplay();
                    updateCropDisplay();
                    updateWaterDisplay();
                    updateExpenseDisplay();
                    updateIncomeDisplay();
                    updateManagerSelect();
                }
            } catch (e) {
                showNotification('Error loading saved data', 'error');
            }
        }

        function saveToLocalStorage() {
            try {
                const data = {
                    livestock: livestockData,
                    crops: cropData,
                    water: waterData,
                    expenses: expenseData,
                    managerLedgers: managerLedgers,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('farm_management_data', JSON.stringify(data));
            } catch (e) {
                showNotification('Error saving data', 'error');
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatCurrency(amount) {
            if (amount === undefined || amount === null || amount === '') return 'Rs 0';
            
            const num = parseFloat(amount);
            if (isNaN(num)) return 'Rs 0';
            
            // Format without .00 for whole numbers
            const formatted = num.toLocaleString('en-IN', {
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            });
            
            return 'Rs ' + formatted;
        }

        function formatNumber(num) {
            if (num === undefined || num === null || num === '') return '0';
            
            const number = parseFloat(num);
            if (isNaN(number)) return '0';
            
            return number.toLocaleString('en-IN', {
                maximumFractionDigits: 0,
                minimumFractionDigits: 0
            });
        }

        function showNotification(message, type = 'success') {
            const container = document.getElementById('notification-container');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${message}
            `;
            
            container.appendChild(notification);
            
            // Remove notification after 5 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 5000);
            
            // Add CSS for slide out
            if (!document.querySelector('#slideOutStyle')) {
                const style = document.createElement('style');
                style.id = 'slideOutStyle';
                style.textContent = `
                    @keyframes slideOut {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        function showLoading() {
            document.getElementById('loading').style.display = 'flex';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showPDFLoading() {
            document.getElementById('pdfLoading').style.display = 'block';
        }

        function hidePDFLoading() {
            document.getElementById('pdfLoading').style.display = 'none';
        }

        function setupAutoSave(formId, type) {
            const form = document.getElementById(formId);
            if (!form) return;
            
            const saveKey = `form_draft_${type}`;
            
            // Load saved draft
            const saved = localStorage.getItem(saveKey);
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input) input.value = data[key];
                    });
                } catch (e) {
                    console.error('Error loading draft:', e);
                }
            }
            
            // Auto-save on input
            form.addEventListener('input', function() {
                const formData = new FormData(form);
                const data = {};
                formData.forEach((value, key) => {
                    data[key] = value;
                });
                localStorage.setItem(saveKey, JSON.stringify(data));
            });
            
            // Clear on submit
            form.addEventListener('submit', function() {
                localStorage.removeItem(saveKey);
            });
        }

        // ========== TAB MANAGEMENT ==========
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav links
            document.querySelectorAll('.sidebar .nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).style.display = 'block';
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Load specific data if needed
            switch(tabName) {
                case 'livestock':
                    updateLivestockStats();
                    break;
                case 'crops':
                    updateCropStats();
                    break;
                case 'water':
                    updateWaterStats();
                    updateManagerSelect();
                    break;
                case 'expenses':
                    updateExpenseStats();
                    break;
                case 'income':
                    updateIncomeDisplay();
                    break;
                case 'reports':
                    updateReportStats();
                    break;
            }
            
            // Scroll to top
            window.scrollTo(0, 0);
        }

        // ========== WATER SUPPLY MANAGEMENT ==========
        function calculateWaterBill() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const rate = parseInt(document.getElementById('waterRate').value) || 0;
            
            document.getElementById('rateDisplay').textContent = formatNumber(rate);
            
            if (startTime && endTime) {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const hours = Math.max(0, (end - start) / (1000 * 60 * 60));
                const bill = Math.round(hours * rate);
                
                document.getElementById('calculatedHours').textContent = hours.toFixed(2);
                document.getElementById('calculatedBill').textContent = formatCurrency(bill);
            } else {
                document.getElementById('calculatedHours').textContent = '0';
                document.getElementById('calculatedBill').textContent = formatCurrency(0);
            }
        }

        function calculateEditWaterBill() {
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            const rate = parseInt(document.getElementById('editWaterRate').value) || 0;
            
            if (startTime && endTime) {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const hours = Math.max(0, (end - start) / (1000 * 60 * 60));
                const bill = Math.round(hours * rate);
                
                document.getElementById('editCalculatedBill').textContent = formatCurrency(bill);
            }
        }

        function saveWaterEntry(e) {
            e.preventDefault();
            
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const start = new Date(startTime);
            const end = new Date(endTime);
            const hours = Math.max(0, (end - start) / (1000 * 60 * 60));
            const totalBill = Math.round(hours * parseInt(document.getElementById('waterRate').value));
            const paymentReceived = parseInt(document.getElementById('paymentReceived').value) || 0;
            const balance = totalBill - paymentReceived;
            const managedBy = document.getElementById('waterManagedBy').value.trim();
            
            const entry = {
                id: Date.now().toString(),
                farmerName: document.getElementById('farmerName').value.trim(),
                fatherName: document.getElementById('fatherName').value.trim(),
                startTime: startTime,
                endTime: endTime,
                rate: parseInt(document.getElementById('waterRate').value),
                totalBill: totalBill,
                paymentReceived: paymentReceived,
                balance: balance,
                paymentDate: document.getElementById('paymentDate').value,
                date: document.getElementById('waterDate').value,
                managedBy: managedBy,
                description: document.getElementById('waterDescription').value,
                hours: parseFloat(hours.toFixed(2)),
                timestamp: new Date().toISOString(),
                payments: paymentReceived > 0 ? [{
                    amount: paymentReceived,
                    date: document.getElementById('paymentDate').value || document.getElementById('waterDate').value,
                    method: 'Cash',
                    description: 'Initial payment'
                }] : []
            };
            
            waterData.unshift(entry);
            
            // Update manager ledger
            updateManagerLedger(managedBy, entry);
            
            saveToLocalStorage();
            updateWaterDisplay();
            updateManagerSelect();
            
            // Clear form
            document.getElementById('waterForm').reset();
            document.getElementById('waterEntryId').value = '';
            document.getElementById('waterRate').value = 100;
            document.getElementById('waterDate').value = new Date().toISOString().split('T')[0];
            const nowDateTime = new Date();
            nowDateTime.setMinutes(nowDateTime.getMinutes() - nowDateTime.getTimezoneOffset());
            document.getElementById('startTime').value = nowDateTime.toISOString().slice(0, 16);
            document.getElementById('endTime').value = nowDateTime.toISOString().slice(0, 16);
            
            showNotification('Water billing entry saved successfully!');
        }

        function updateWaterEntry(e) {
            e.preventDefault();
            
            const id = document.getElementById('editWaterId').value;
            const index = waterData.findIndex(item => item.id === id);
            
            if (index === -1) {
                showNotification('Entry not found!', 'error');
                return false;
            }
            
            const startTime = document.getElementById('editStartTime').value;
            const endTime = document.getElementById('editEndTime').value;
            const start = new Date(startTime);
            const end = new Date(endTime);
            const hours = Math.max(0, (end - start) / (1000 * 60 * 60));
            const totalBill = Math.round(hours * parseInt(document.getElementById('editWaterRate').value));
            const paymentReceived = parseInt(document.getElementById('editPaymentReceived').value) || 0;
            const balance = totalBill - paymentReceived;
            const managedBy = document.getElementById('editWaterManagedBy').value.trim();
            const oldManagedBy = waterData[index].managedBy;
            
            // Update entry
            waterData[index] = {
                ...waterData[index],
                farmerName: document.getElementById('editFarmerName').value.trim(),
                fatherName: document.getElementById('editFatherName').value.trim(),
                startTime: startTime,
                endTime: endTime,
                rate: parseInt(document.getElementById('editWaterRate').value),
                totalBill: totalBill,
                paymentReceived: paymentReceived,
                balance: balance,
                paymentDate: document.getElementById('editPaymentDate').value,
                date: document.getElementById('editWaterDate').value,
                managedBy: managedBy,
                description: document.getElementById('editWaterDescription').value,
                hours: parseFloat(hours.toFixed(2)),
                updatedAt: new Date().toISOString()
            };
            
            // Update manager ledger if manager changed
            if (oldManagedBy !== managedBy) {
                removeFromManagerLedger(oldManagedBy, id);
                updateManagerLedger(managedBy, waterData[index]);
            } else {
                updateManagerLedger(managedBy, waterData[index]);
            }
            
            saveToLocalStorage();
            updateWaterDisplay();
            updateManagerSelect();
            
            bootstrap.Modal.getInstance(document.getElementById('editWaterModal')).hide();
            showNotification('Water entry updated successfully!');
            
            return false;
        }

        function editWaterEntry(id) {
            const entry = waterData.find(item => item.id === id);
            if (!entry) {
                showNotification('Entry not found!', 'error');
                return;
            }
            
            // Populate form
            document.getElementById('editWaterId').value = entry.id;
            document.getElementById('editFarmerName').value = entry.farmerName;
            document.getElementById('editFatherName').value = entry.fatherName || '';
            document.getElementById('editStartTime').value = entry.startTime;
            document.getElementById('editEndTime').value = entry.endTime;
            document.getElementById('editWaterRate').value = entry.rate;
            document.getElementById('editPaymentReceived').value = entry.paymentReceived;
            document.getElementById('editPaymentDate').value = entry.paymentDate || '';
            document.getElementById('editWaterDate').value = entry.date;
            document.getElementById('editWaterManagedBy').value = entry.managedBy;
            document.getElementById('editWaterDescription').value = entry.description || '';
            
            // Calculate bill
            calculateEditWaterBill();
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editWaterModal'));
            modal.show();
        }

        function deleteWaterEntry(id) {
            if (!confirm('Are you sure you want to delete this water entry?')) {
                return;
            }
            
            const index = waterData.findIndex(item => item.id === id);
            if (index === -1) {
                showNotification('Entry not found!', 'error');
                return;
            }
            
            const entry = waterData[index];
            
            // Remove from manager ledger
            removeFromManagerLedger(entry.managedBy, id);
            
            // Remove from water data
            waterData.splice(index, 1);
            
            saveToLocalStorage();
            updateWaterDisplay();
            updateManagerSelect();
            
            showNotification('Water entry deleted successfully!');
        }

        function addPaymentToWater(id) {
            const entry = waterData.find(item => item.id === id);
            if (!entry) {
                showNotification('Entry not found!', 'error');
                return;
            }
            
            document.getElementById('paymentWaterId').value = id;
            document.getElementById('paymentAmount').value = entry.balance;
            document.getElementById('paymentAmount').max = entry.balance;
            
            const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        function addPayment(e) {
            e.preventDefault();
            
            const id = document.getElementById('paymentWaterId').value;
            const index = waterData.findIndex(item => item.id === id);
            
            if (index === -1) {
                showNotification('Entry not found!', 'error');
                return false;
            }
            
            const amount = parseInt(document.getElementById('paymentAmount').value) || 0;
            const paymentDate = document.getElementById('newPaymentDate').value;
            
            if (amount <= 0) {
                showNotification('Please enter a valid amount!', 'error');
                return false;
            }
            
            // Update water entry
            waterData[index].paymentReceived += amount;
            waterData[index].balance = waterData[index].totalBill - waterData[index].paymentReceived;
            waterData[index].paymentDate = paymentDate;
            
            // Add to payments array
            if (!waterData[index].payments) {
                waterData[index].payments = [];
            }
            
            waterData[index].payments.push({
                amount: amount,
                date: paymentDate,
                method: document.getElementById('paymentMethodSelect').value,
                description: document.getElementById('paymentDescription').value || 'Payment received'
            });
            
            // Update manager ledger
            updateManagerLedger(waterData[index].managedBy, waterData[index]);
            
            saveToLocalStorage();
            updateWaterDisplay();
            
            bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
            showNotification('Payment added successfully!');
            
            return false;
        }

        function updateWaterDisplay() {
            const tableBody = document.getElementById('waterTable');
            if (!tableBody) return;
            
            let filteredData = waterData;
            
            // Apply filters
            const fromDate = document.getElementById('waterFromDate')?.value;
            const toDate = document.getElementById('waterToDate')?.value;
            const searchTerm = document.getElementById('waterSearch')?.value.toLowerCase();
            const managerFilter = document.getElementById('waterFilterManager')?.value;
            
            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }
            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }
            if (searchTerm) {
                filteredData = filteredData.filter(item => 
                    item.farmerName.toLowerCase().includes(searchTerm) ||
                    (item.fatherName && item.fatherName.toLowerCase().includes(searchTerm))
                );
            }
            if (managerFilter) {
                filteredData = filteredData.filter(item => item.managedBy === managerFilter);
            }
            
            // Update table
            tableBody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = `
                    <tr>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td>
                            <strong>${item.farmerName}</strong>
                            ${item.fatherName ? `<br><small class="text-muted">${item.fatherName}</small>` : ''}
                        </td>
                        <td>${item.hours.toFixed(2)}</td>
                        <td>${formatCurrency(item.rate)}</td>
                        <td class="currency">${formatCurrency(item.totalBill)}</td>
                        <td class="currency income">${formatCurrency(item.paymentReceived)}</td>
                        <td class="currency ${item.balance > 0 ? 'balance-negative' : 'balance-positive'}">
                            ${formatCurrency(item.balance)}
                        </td>
                        <td>${item.managedBy}</td>
                        <td>
                            <div class="water-table-actions">
                                <button class="btn btn-warning btn-sm" onclick="editWaterEntry('${item.id}')">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteWaterEntry('${item.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ${item.balance > 0 ? `
                                    <button class="btn btn-success btn-sm" onclick="addPaymentToWater('${item.id}')">
                                        <i class="fas fa-money-bill"></i>
                                    </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            // Update count
            document.getElementById('waterCount').textContent = 
                `Showing ${filteredData.length} of ${waterData.length} records`;
            
            updateWaterStats();
            updateDashboard();
        }

        function filterWaterRecords() {
            updateWaterDisplay();
        }

        function updateWaterStats() {
            const statsContainer = document.getElementById('waterStats');
            if (!statsContainer) return;
            
            // Calculate statistics
            let totalBill = 0;
            let totalPaid = 0;
            let totalBalance = 0;
            let totalHours = 0;
            const managers = new Set();
            
            waterData.forEach(item => {
                totalBill += item.totalBill;
                totalPaid += item.paymentReceived;
                totalBalance += item.balance;
                totalHours += item.hours || 0;
                if (item.managedBy) managers.add(item.managedBy);
            });
            
            const statsHTML = `
                <div class="row">
                    <div class="col-6">
                        <div class="text-primary">
                            <small>Total Billed</small>
                            <h5>${formatCurrency(totalBill)}</h5>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-success">
                            <small>Total Received</small>
                            <h5>${formatCurrency(totalPaid)}</h5>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-6">
                        <div class="${totalBalance > 0 ? 'text-danger' : 'text-success'}">
                            <small>Pending Balance</small>
                            <h5>${formatCurrency(Math.abs(totalBalance))}</h5>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="text-info">
                            <small>Total Hours</small>
                            <h5>${totalHours.toFixed(2)}</h5>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <small>Active Managers: ${managers.size}</small>
                    </div>
                </div>
            `;
            
            statsContainer.innerHTML = statsHTML;
        }

        // ========== MANAGER LEDGER FUNCTIONS ==========
        function initializeManagerLedgers() {
            if (!managerLedgers) {
                managerLedgers = {};
            }
            
            // Initialize from existing water data
            waterData.forEach(entry => {
                if (entry.managedBy) {
                    updateManagerLedger(entry.managedBy, entry);
                }
            });
        }

        function updateManagerLedger(managerName, entry) {
            if (!managerName) return;
            
            if (!managerLedgers[managerName]) {
                managerLedgers[managerName] = {
                    totalCollected: 0,
                    totalPending: 0,
                    totalBilled: 0,
                    entries: [],
                    payments: []
                };
            }
            
            const ledger = managerLedgers[managerName];
            
            // Check if entry already exists
            const entryIndex = ledger.entries.findIndex(e => e.id === entry.id);
            
            if (entryIndex === -1) {
                // Add new entry
                ledger.entries.push({
                    id: entry.id,
                    farmerName: entry.farmerName,
                    date: entry.date,
                    amount: entry.totalBill,
                    paid: entry.paymentReceived,
                    balance: entry.balance
                });
            } else {
                // Update existing entry
                ledger.entries[entryIndex] = {
                    id: entry.id,
                    farmerName: entry.farmerName,
                    date: entry.date,
                    amount: entry.totalBill,
                    paid: entry.paymentReceived,
                    balance: entry.balance
                };
            }
            
            // Update totals
            ledger.totalBilled = ledger.entries.reduce((sum, e) => sum + e.amount, 0);
            ledger.totalCollected = ledger.entries.reduce((sum, e) => sum + e.paid, 0);
            ledger.totalPending = ledger.entries.reduce((sum, e) => sum + e.balance, 0);
            
            saveToLocalStorage();
        }

        function removeFromManagerLedger(managerName, entryId) {
            if (!managerName || !managerLedgers[managerName]) return;
            
            const ledger = managerLedgers[managerName];
            const entryIndex = ledger.entries.findIndex(e => e.id === entryId);
            
            if (entryIndex !== -1) {
                ledger.entries.splice(entryIndex, 1);
                
                // Update totals
                ledger.totalBilled = ledger.entries.reduce((sum, e) => sum + e.amount, 0);
                ledger.totalCollected = ledger.entries.reduce((sum, e) => sum + e.paid, 0);
                ledger.totalPending = ledger.entries.reduce((sum, e) => sum + e.balance, 0);
                
                saveToLocalStorage();
            }
        }

        function updateManagerSelect() {
            const select = document.getElementById('waterFilterManager');
            const selectManager = document.getElementById('selectManager');
            
            if (!select || !selectManager) return;
            
            // Clear existing options except first
            while (select.options.length > 1) select.remove(1);
            while (selectManager.options.length > 1) selectManager.remove(1);
            
            // Get unique managers
            const managers = [...new Set(waterData.map(item => item.managedBy).filter(Boolean))].sort();
            
            managers.forEach(manager => {
                const option = document.createElement('option');
                option.value = manager;
                option.textContent = manager;
                select.appendChild(option.cloneNode(true));
                selectManager.appendChild(option);
            });
        }

        function showManagerLedger() {
            const modal = new bootstrap.Modal(document.getElementById('managerLedgerModal'));
            modal.show();
        }

        function loadManagerLedger(managerName) {
            const content = document.getElementById('managerLedgerContent');
            
            if (!managerName || !managerLedgers[managerName]) {
                content.innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-user-tie fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Select a manager to view their ledger</p>
                    </div>
                `;
                return;
            }
            
            const ledger = managerLedgers[managerName];
            
            let html = `
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="mb-0">${managerName} - Ledger Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-primary">${formatCurrency(ledger.totalBilled)}</h4>
                                    <small>Total Billed</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="text-success">${formatCurrency(ledger.totalCollected)}</h4>
                                    <small>Total Collected</small>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="p-3 bg-light rounded">
                                    <h4 class="${ledger.totalPending > 0 ? 'text-danger' : 'text-success'}">
                                        ${formatCurrency(ledger.totalPending)}
                                    </h4>
                                    <small>Pending Balance</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Detailed Entries</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Farmer</th>
                                        <th>Billed Amount</th>
                                        <th>Paid Amount</th>
                                        <th>Balance</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            ledger.entries.forEach(entry => {
                const status = entry.balance === 0 ? 'Paid' : entry.balance > 0 ? 'Pending' : 'Advance';
                const statusClass = entry.balance === 0 ? 'badge-success' : 
                                  entry.balance > 0 ? 'badge-warning' : 'badge-info';
                
                html += `
                    <tr>
                        <td>${new Date(entry.date).toLocaleDateString()}</td>
                        <td>${entry.farmerName}</td>
                        <td class="currency">${formatCurrency(entry.amount)}</td>
                        <td class="currency income">${formatCurrency(entry.paid)}</td>
                        <td class="currency ${entry.balance > 0 ? 'balance-negative' : 'balance-positive'}">
                            ${formatCurrency(entry.balance)}
                        </td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
        }

        function generateManagerLedgerPDF() {
            const managerName = document.getElementById('selectManager').value;
            if (!managerName || !managerLedgers[managerName]) {
                showNotification('Please select a manager first!', 'error');
                return;
            }
            
            showPDFLoading();
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const ledger = managerLedgers[managerName];
                    
                    // Title
                    doc.setFontSize(20);
                    doc.text('Manager Ledger Report', 105, 20, { align: 'center' });
                    
                    // Manager Info
                    doc.setFontSize(14);
                    doc.text(`Manager: ${managerName}`, 20, 35);
                    doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 20, 45);
                    
                    // Summary
                    doc.setFontSize(12);
                    doc.text('Summary:', 20, 60);
                    doc.setFontSize(10);
                    doc.text(`Total Billed: ${formatCurrency(ledger.totalBilled)}`, 20, 70);
                    doc.text(`Total Collected: ${formatCurrency(ledger.totalCollected)}`, 20, 78);
                    doc.text(`Pending Balance: ${formatCurrency(ledger.totalPending)}`, 20, 86);
                    
                    // Table data
                    const tableData = ledger.entries.map(entry => [
                        new Date(entry.date).toLocaleDateString(),
                        entry.farmerName,
                        formatCurrency(entry.amount),
                        formatCurrency(entry.paid),
                        formatCurrency(entry.balance),
                        entry.balance === 0 ? 'Paid' : entry.balance > 0 ? 'Pending' : 'Advance'
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        head: [['Date', 'Farmer', 'Billed', 'Paid', 'Balance', 'Status']],
                        body: tableData,
                        startY: 100,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 3 },
                        headStyles: { fillColor: [46, 139, 87], textColor: 255 },
                        alternateRowStyles: { fillColor: [240, 240, 240] },
                        margin: { left: 20, right: 20 }
                    });
                    
                    // Save PDF
                    doc.save(`${managerName}_ledger_${new Date().toISOString().split('T')[0]}.pdf`);
                    hidePDFLoading();
                    showNotification('Manager ledger PDF generated!');
                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    hidePDFLoading();
                    showNotification('Error generating PDF. Please try again.', 'error');
                }
            }, 100);
        }

        // ========== QUICK REPORTS FUNCTIONS ==========
        function generateTodayReport() {
            const today = new Date().toISOString().split('T')[0];
            const todayData = {
                livestock: livestockData.filter(item => item.date === today),
                crops: cropData.filter(item => item.date === today),
                water: waterData.filter(item => item.date === today),
                expenses: expenseData.filter(item => item.date === today)
            };
            
            displayReport('Today', todayData, 'todayReportContent');
        }

        function generateWeeklyReport() {
            const today = new Date();
            const weekAgo = new Date(today);
            weekAgo.setDate(today.getDate() - 7);
            
            const weekData = {
                livestock: livestockData.filter(item => new Date(item.date) >= weekAgo),
                crops: cropData.filter(item => new Date(item.date) >= weekAgo),
                water: waterData.filter(item => new Date(item.date) >= weekAgo),
                expenses: expenseData.filter(item => new Date(item.date) >= weekAgo)
            };
            
            displayReport('Weekly', weekData, 'weeklyReportContent');
        }

        function generateMonthlyReport() {
            const today = new Date();
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);
            
            const monthData = {
                livestock: livestockData.filter(item => new Date(item.date) >= monthAgo),
                crops: cropData.filter(item => new Date(item.date) >= monthAgo),
                water: waterData.filter(item => new Date(item.date) >= monthAgo),
                expenses: expenseData.filter(item => new Date(item.date) >= monthAgo)
            };
            
            displayReport('Monthly', monthData, 'monthlyReportContent');
        }

        function generateYearlyReport() {
            const today = new Date();
            const yearAgo = new Date(today);
            yearAgo.setFullYear(today.getFullYear() - 1);
            
            const yearData = {
                livestock: livestockData.filter(item => new Date(item.date) >= yearAgo),
                crops: cropData.filter(item => new Date(item.date) >= yearAgo),
                water: waterData.filter(item => new Date(item.date) >= yearAgo),
                expenses: expenseData.filter(item => new Date(item.date) >= yearAgo)
            };
            
            displayReport('Yearly', yearData, 'yearlyReportContent');
        }

        function generateProfitLossReport() {
            const today = new Date();
            const monthAgo = new Date(today);
            monthAgo.setMonth(today.getMonth() - 1);
            
            // Calculate income
            const livestockIncome = livestockData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.incomeAmount || 0), 0);
                
            const cropIncome = cropData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.incomeAmount || 0), 0);
            
            const totalIncome = livestockIncome + cropIncome;
            
            // Calculate expenses
            const livestockExpense = livestockData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.expenseAmount || 0), 0);
                
            const cropExpense = cropData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.expenseAmount || 0), 0);
                
            const waterExpense = waterData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.totalBill || 0), 0);
                
            const otherExpense = expenseData
                .filter(item => new Date(item.date) >= monthAgo)
                .reduce((sum, item) => sum + (item.amount || 0), 0);
            
            const totalExpense = livestockExpense + cropExpense + waterExpense + otherExpense;
            const netProfit = totalIncome - totalExpense;
            
            const reportData = {
                title: 'Profit & Loss',
                period: 'Last 30 Days',
                income: totalIncome,
                expense: totalExpense,
                profit: netProfit,
                details: {
                    'Livestock Income': livestockIncome,
                    'Crop Income': cropIncome,
                    'Livestock Expense': livestockExpense,
                    'Crop Expense': cropExpense,
                    'Water Expense': waterExpense,
                    'Other Expense': otherExpense
                }
            };
            
            displayProfitLossReport(reportData, 'profitLossReportContent');
        }

        function displayReport(title, data, containerId) {
            const container = document.getElementById(containerId);
            
            // Calculate totals
            const livestockCount = data.livestock.length;
            const cropCount = data.crops.length;
            const waterCount = data.water.length;
            const expenseCount = data.expenses.length;
            
            const totalIncome = data.livestock.reduce((sum, item) => sum + (item.incomeAmount || 0), 0) +
                              data.crops.reduce((sum, item) => sum + (item.incomeAmount || 0), 0);
            
            const totalExpense = data.livestock.reduce((sum, item) => sum + (item.expenseAmount || 0), 0) +
                               data.crops.reduce((sum, item) => sum + (item.expenseAmount || 0), 0) +
                               data.water.reduce((sum, item) => sum + (item.totalBill || 0), 0) +
                               data.expenses.reduce((sum, item) => sum + (item.amount || 0), 0);
            
            const netProfit = totalIncome - totalExpense;
            
            let html = `
                <div class="report-summary">
                    <h5 class="mb-4">${title} Report Summary</h5>
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card report-summary-card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Livestock</h6>
                                    <h3 class="text-primary">${livestockCount}</h3>
                                    <small>Entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card report-summary-card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Crops</h6>
                                    <h3 class="text-success">${cropCount}</h3>
                                    <small>Entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card report-summary-card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Water Supply</h6>
                                    <h3 class="text-info">${waterCount}</h3>
                                    <small>Entries</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card report-summary-card">
                                <div class="card-body text-center">
                                    <h6 class="text-muted">Expenses</h6>
                                    <h3 class="text-danger">${expenseCount}</h3>
                                    <small>Entries</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-success bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Total Income</h6>
                                    <h4 class="text-success">${formatCurrency(totalIncome)}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-danger bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Total Expense</h6>
                                    <h4 class="text-danger">${formatCurrency(totalExpense)}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card ${netProfit >= 0 ? 'bg-success' : 'bg-danger'} bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Net Profit/Loss</h6>
                                    <h4 class="${netProfit >= 0 ? 'text-success' : 'text-danger'}">
                                        ${formatCurrency(netProfit)}
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="generate${title}PDF()">
                            <i class="fas fa-file-pdf me-2"></i>Export ${title} Report as PDF
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function displayProfitLossReport(data, containerId) {
            const container = document.getElementById(containerId);
            
            let html = `
                <div class="report-summary">
                    <h5 class="mb-4">${data.title} Report</h5>
                    <p class="text-muted mb-4">Period: ${data.period}</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-4 mb-3">
                            <div class="card bg-success bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Total Income</h6>
                                    <h4 class="text-success">${formatCurrency(data.income)}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card bg-danger bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Total Expense</h6>
                                    <h4 class="text-danger">${formatCurrency(data.expense)}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card ${data.profit >= 0 ? 'bg-success' : 'bg-danger'} bg-opacity-10">
                                <div class="card-body text-center">
                                    <h6>Net ${data.profit >= 0 ? 'Profit' : 'Loss'}</h6>
                                    <h4 class="${data.profit >= 0 ? 'text-success' : 'text-danger'}">
                                        ${formatCurrency(data.profit)}
                                    </h4>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header">
                            <h6 class="mb-0">Income & Expense Breakdown</h6>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Category</th>
                                        <th>Amount</th>
                                        <th>Type</th>
                                    </tr>
                                </thead>
                                <tbody>
            `;
            
            Object.entries(data.details).forEach(([category, amount]) => {
                const isIncome = category.includes('Income');
                html += `
                    <tr>
                        <td>${category}</td>
                        <td class="${isIncome ? 'text-success' : 'text-danger'}">
                            ${formatCurrency(amount)}
                        </td>
                        <td>
                            <span class="badge ${isIncome ? 'bg-success' : 'bg-danger'}">
                                ${isIncome ? 'Income' : 'Expense'}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <button class="btn btn-primary" onclick="generateProfitLossPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Export Profit & Loss Report as PDF
                        </button>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // ========== PDF GENERATION FUNCTIONS ==========
        function generateWaterPDF() {
            showPDFLoading();
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Title
                    doc.setFontSize(18);
                    doc.text('Water Supply Report', 105, 20, { align: 'center' });
                    
                    // Date
                    doc.setFontSize(11);
                    doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });
                    
                    // Summary
                    let totalBill = 0;
                    let totalPaid = 0;
                    let totalBalance = 0;
                    let totalHours = 0;
                    
                    waterData.forEach(item => {
                        totalBill += item.totalBill;
                        totalPaid += item.paymentReceived;
                        totalBalance += item.balance;
                        totalHours += item.hours || 0;
                    });
                    
                    const summaryY = 40;
                    doc.setFontSize(12);
                    doc.text('Summary:', 20, summaryY);
                    doc.setFontSize(10);
                    doc.text(`Total Records: ${waterData.length}`, 20, summaryY + 8);
                    doc.text(`Total Billed: ${formatCurrency(totalBill)}`, 20, summaryY + 16);
                    doc.text(`Total Received: ${formatCurrency(totalPaid)}`, 20, summaryY + 24);
                    doc.text(`Pending Balance: ${formatCurrency(totalBalance)}`, 20, summaryY + 32);
                    doc.text(`Total Hours: ${totalHours.toFixed(2)}`, 20, summaryY + 40);
                    
                    // Table data (limited to prevent hanging)
                    const maxRows = 100; // Limit rows to prevent hanging
                    const tableData = waterData.slice(0, maxRows).map(item => [
                        new Date(item.date).toLocaleDateString(),
                        item.farmerName.substring(0, 15), // Limit name length
                        item.hours.toFixed(2),
                        formatCurrency(item.rate),
                        formatCurrency(item.totalBill),
                        formatCurrency(item.paymentReceived),
                        formatCurrency(item.balance),
                        item.managedBy.substring(0, 10) // Limit manager name
                    ]);
                    
                    // Add table
                    doc.autoTable({
                        head: [['Date', 'Farmer', 'Hours', 'Rate', 'Total', 'Paid', 'Balance', 'Manager']],
                        body: tableData,
                        startY: summaryY + 50,
                        theme: 'grid',
                        styles: { fontSize: 7, cellPadding: 2 },
                        headStyles: { fillColor: [65, 105, 225], textColor: 255 },
                        alternateRowStyles: { fillColor: [240, 240, 240] },
                        margin: { left: 15, right: 15 }
                    });
                    
                    // Add note if data was truncated
                    if (waterData.length > maxRows) {
                        const finalY = doc.lastAutoTable.finalY || 200;
                        doc.setFontSize(8);
                        doc.text(`* Showing first ${maxRows} of ${waterData.length} records`, 20, finalY + 10);
                    }
                    
                    // Save PDF
                    doc.save(`water_report_${new Date().toISOString().split('T')[0]}.pdf`);
                    hidePDFLoading();
                    showNotification('Water supply PDF generated successfully!');
                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    hidePDFLoading();
                    showNotification('Error generating PDF. Please try with less data.', 'error');
                }
            }, 100);
        }

        function generateMonthlySummaryPDF() {
            generateMonthlyReportPDF();
        }

        function generateMonthlyReportPDF() {
            showPDFLoading();
            
            setTimeout(() => {
                try {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    
                    // Title
                    doc.setFontSize(20);
                    doc.text('Monthly Farm Report', 105, 20, { align: 'center' });
                    
                    // Month
                    const now = new Date();
                    const monthYear = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    doc.setFontSize(14);
                    doc.text(`Month: ${monthYear}`, 105, 30, { align: 'center' });
                    
                    // Date
                    doc.setFontSize(11);
                    doc.text(`Generated on: ${now.toLocaleDateString()}`, 105, 38, { align: 'center' });
                    
                    // Calculate monthly totals
                    const startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    const endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    
                    // Filter data for current month
                    const currentMonthLivestock = livestockData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                    
                    const currentMonthCrops = cropData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                    
                    const currentMonthExpenses = expenseData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                    
                    const currentMonthWater = waterData.filter(item => {
                        const itemDate = new Date(item.date);
                        return itemDate >= startDate && itemDate <= endDate;
                    });
                    
                    // Calculate totals
                    let livestockIncome = 0;
                    let livestockExpense = 0;
                    let cropIncome = 0;
                    let cropExpense = 0;
                    let otherExpenses = 0;
                    let waterExpense = 0;
                    
                    currentMonthLivestock.forEach(item => {
                        livestockIncome += item.incomeAmount || 0;
                        livestockExpense += item.expenseAmount || 0;
                    });
                    
                    currentMonthCrops.forEach(item => {
                        cropIncome += item.incomeAmount || 0;
                        cropExpense += item.expenseAmount || 0;
                    });
                    
                    currentMonthExpenses.forEach(item => {
                        otherExpenses += item.amount || 0;
                    });
                    
                    currentMonthWater.forEach(item => {
                        waterExpense += item.totalBill || 0;
                    });
                    
                    const totalIncome = livestockIncome + cropIncome;
                    const totalExpense = livestockExpense + cropExpense + otherExpenses + waterExpense;
                    const netProfit = totalIncome - totalExpense;
                    
                    // Summary section
                    const summaryY = 50;
                    doc.setFontSize(14);
                    doc.text('Financial Summary', 20, summaryY);
                    
                    doc.setFontSize(11);
                    doc.text(`Livestock Income: ${formatCurrency(livestockIncome)}`, 20, summaryY + 10);
                    doc.text(`Livestock Expenses: ${formatCurrency(livestockExpense)}`, 20, summaryY + 18);
                    doc.text(`Crop Income: ${formatCurrency(cropIncome)}`, 20, summaryY + 26);
                    doc.text(`Crop Expenses: ${formatCurrency(cropExpense)}`, 20, summaryY + 34);
                    doc.text(`Other Expenses: ${formatCurrency(otherExpenses)}`, 20, summaryY + 42);
                    doc.text(`Water Expenses: ${formatCurrency(waterExpense)}`, 20, summaryY + 50);
                    
                    // Totals
                    const totalsY = summaryY + 65;
                    doc.setFontSize(12);
                    doc.setDrawColor(0);
                    doc.setLineWidth(0.5);
                    doc.line(20, totalsY - 5, 190, totalsY - 5);
                    
                    doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, totalsY);
                    doc.text(`Total Expenses: ${formatCurrency(totalExpense)}`, 20, totalsY + 10);
                    
                    doc.setFontSize(14);
                    if (netProfit >= 0) {
                        doc.setTextColor(46, 139, 87);
                    } else {
                        doc.setTextColor(220, 53, 69);
                    }
                    doc.text(`Net Profit: ${formatCurrency(netProfit)}`, 20, totalsY + 20);
                    
                    // Save PDF
                    doc.save(`monthly_report_${now.getFullYear()}_${(now.getMonth() + 1).toString().padStart(2, '0')}.pdf`);
                    hidePDFLoading();
                    showNotification('Monthly PDF report generated!');
                } catch (error) {
                    console.error('PDF Generation Error:', error);
                    hidePDFLoading();
                    showNotification('Error generating PDF. Please try again.', 'error');
                }
            }, 100);
        }

        // ========== OTHER FUNCTIONS (from original code) ==========
        // Note: Due to length, I'm including only the new/changed functions.
        // The original functions (saveLivestockEntry, updateLivestockDisplay, etc.)
        // should remain as they were in your original code.

        function updateReportStats() {
            // Calculate total income
            let totalIncome = 0;
            livestockData.forEach(item => totalIncome += item.incomeAmount || 0);
            cropData.forEach(item => totalIncome += item.incomeAmount || 0);
            
            // Calculate total expenses
            let totalExpenses = 0;
            livestockData.forEach(item => totalExpenses += item.expenseAmount || 0);
            cropData.forEach(item => totalExpenses += item.expenseAmount || 0);
            expenseData.forEach(item => totalExpenses += item.amount || 0);
            waterData.forEach(item => totalExpenses += item.totalBill || 0);
            
            // Calculate net profit
            const netProfit = totalIncome - totalExpenses;
            
            // Update display
            document.getElementById('reportTotalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('reportTotalExpense').textContent = formatCurrency(totalExpenses);
            document.getElementById('reportNetProfit').textContent = formatCurrency(netProfit);
            document.getElementById('reportTotalRecords').textContent = 
                livestockData.length + cropData.length + waterData.length + expenseData.length;
        }

        // Initialize the rest of your original functions
        // ... [Keep all your original functions from the provided code]

        // Initialize sample data if needed
        function addSampleData() {
            if (waterData.length === 0 && localStorage.getItem('sample_data_added') !== 'true') {
                // Add sample water data
                waterData.push({
                    id: '1',
                    farmerName: 'Akram Khan',
                    fatherName: 'Javed Khan',
                    startTime: '2024-01-20T08:00',
                    endTime: '2024-01-20T12:00',
                    rate: 100,
                    totalBill: 400,
                    paymentReceived: 400,
                    balance: 0,
                    paymentDate: '2024-01-22',
                    date: '2024-01-20',
                    managedBy: 'Manager 1',
                    description: 'Morning irrigation',
                    hours: 4,
                    timestamp: '2024-01-20T12:00:00Z',
                    payments: [{
                        amount: 400,
                        date: '2024-01-22',
                        method: 'Cash',
                        description: 'Full payment'
                    }]
                });
                
                waterData.push({
                    id: '2',
                    farmerName: 'Saeed Ahmed',
                    fatherName: 'Noor Ahmed',
                    startTime: '2024-01-18T14:00',
                    endTime: '2024-01-18T18:00',
                    rate: 100,
                    totalBill: 400,
                    paymentReceived: 200,
                    balance: 200,
                    paymentDate: '',
                    date: '2024-01-18',
                    managedBy: 'Manager 2',
                    description: 'Afternoon session',
                    hours: 4,
                    timestamp: '2024-01-18T18:00:00Z',
                    payments: [{
                        amount: 200,
                        date: '2024-01-18',
                        method: 'Cash',
                        description: 'Partial payment'
                    }]
                });
                
                saveToLocalStorage();
                localStorage.setItem('sample_data_added', 'true');
                
                loadAllData();
                showNotification('Sample water data loaded successfully!');
            }
        }

        // Call addSampleData on first load
        setTimeout(addSampleData, 1000);
        
        // Make sure to call updateReportStats when showing reports tab
        const originalShowTab = showTab;
        showTab = function(tabName) {
            originalShowTab(tabName);
            if (tabName === 'reports') {
                updateReportStats();
            }
        };

    </script>
</body>
</html>
