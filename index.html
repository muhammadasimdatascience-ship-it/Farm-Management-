<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriFarm Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.3.0/build/global/luxon.min.js"></script>
    <style>
        :root {
            --primary-color: #2e7d32;
            --secondary-color: #4caf50;
            --accent-color: #8bc34a;
            --light-color: #f1f8e9;
            --dark-color: #1b5e20;
            --danger-color: #f44336;
            --warning-color: #ff9800;
            --info-color: #2196f3;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        header {
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 40px;
            text-align: center;
            border-bottom: 5px solid var(--accent-color);
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        header h1 i {
            color: var(--accent-color);
        }

        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .tabs-container {
            display: flex;
            background: var(--light-color);
            border-bottom: 2px solid #ddd;
            flex-wrap: wrap;
        }

        .tab {
            padding: 18px 30px;
            background: transparent;
            border: none;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: var(--dark-color);
            position: relative;
        }

        .tab:hover {
            background: rgba(76, 175, 80, 0.1);
        }

        .tab.active {
            background: white;
            color: var(--primary-color);
            border-top: 3px solid var(--primary-color);
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 125, 50, 0.3);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #3d8b40;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning:hover {
            background: #f57c00;
            transform: translateY(-2px);
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-info:hover {
            background: #1976d2;
            transform: translateY(-2px);
        }

        .form-container {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            display: none;
        }

        .form-container.active {
            display: block;
            animation: slideDown 0.4s ease;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .form-control {
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e0e0e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
            text-align: left;
            padding: 18px 15px;
            position: sticky;
            top: 0;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            vertical-align: middle;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }

        .action-btn.edit {
            background: #e3f2fd;
            color: var(--info-color);
        }

        .action-btn.delete {
            background: #ffebee;
            color: var(--danger-color);
        }

        .action-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-left: 5px solid var(--primary-color);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-title {
            font-size: 1rem;
            color: #666;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-change {
            font-size: 0.9rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .positive {
            color: var(--secondary-color);
        }

        .negative {
            color: var(--danger-color);
        }

        .filter-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            min-width: 200px;
        }

        .footer {
            text-align: center;
            padding: 25px;
            margin-top: 40px;
            border-top: 1px solid #eee;
            color: #666;
            font-size: 0.9rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            animation: modalFade 0.3s ease;
        }

        @keyframes modalFade {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-header {
            padding: 25px 30px;
            background: var(--primary-color);
            color: white;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .close-modal {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }

        .close-modal:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .notification {
            position: fixed;
            top: 30px;
            right: 30px;
            padding: 18px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.4s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--secondary-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--info-color);
        }

        @media (max-width: 768px) {
            .tab {
                padding: 15px;
                font-size: 1rem;
            }
            
            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .action-buttons {
                width: 100%;
                justify-content: flex-start;
            }
            
            .btn {
                padding: 10px 15px;
                font-size: 0.9rem;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }

        .search-box {
            flex: 1;
            max-width: 400px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            background: white url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23777' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E") no-repeat 15px center;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #777;
            font-size: 1.1rem;
        }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #ddd;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-tractor"></i> AgriFarm Management System</h1>
            <p class="subtitle">Complete Livestock, Crop, Water Supply & Financial Management Solution</p>
        </header>

        <div class="tabs-container">
            <button class="tab active" data-tab="livestock">
                <i class="fas fa-cow"></i> Livestock
            </button>
            <button class="tab" data-tab="crop">
                <i class="fas fa-seedling"></i> Crop
            </button>
            <button class="tab" data-tab="water">
                <i class="fas fa-tint"></i> Water Supply
            </button>
            <button class="tab" data-tab="expenses">
                <i class="fas fa-money-bill-wave"></i> Expenses
            </button>
            <button class="tab" data-tab="income">
                <i class="fas fa-chart-line"></i> Income
            </button>
            <button class="tab" data-tab="reports">
                <i class="fas fa-file-alt"></i> Reports
            </button>
        </div>

        <!-- Livestock Tab -->
        <div class="tab-content active" id="livestock">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-cow"></i> Livestock Management</h2>
                <div class="action-buttons">
                    <div class="search-box">
                        <input type="text" id="livestockSearch" placeholder="Search livestock entries...">
                    </div>
                    <button class="btn btn-primary" onclick="showLivestockForm()">
                        <i class="fas fa-plus"></i> Add Entry
                    </button>
                    <button class="btn btn-secondary" onclick="downloadLivestockTemplate()">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button class="btn btn-info" onclick="document.getElementById('livestockUpload').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <input type="file" id="livestockUpload" accept=".xlsx,.xls" style="display:none" onchange="uploadLivestockExcel(this)">
                </div>
            </div>

            <div class="form-container" id="livestockForm">
                <h3 style="margin-bottom:20px; color:var(--primary-color);">
                    <i class="fas fa-edit"></i> <span id="livestockFormTitle">Add New Livestock Entry</span>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="livestockDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Category</label>
                        <select id="livestockCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="Cow">Cow</option>
                            <option value="Beef">Beef</option>
                            <option value="Goat">Goat</option>
                            <option value="Others">Others</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Managed By</label>
                        <input type="text" id="livestockManager" class="form-control" placeholder="Enter manager name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-haykal"></i> Khal (kg)</label>
                        <input type="number" id="livestockKhal" class="form-control" placeholder="Enter quantity" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-wheat-awn"></i> Chokar (kg)</label>
                        <input type="number" id="livestockChokar" class="form-control" placeholder="Enter quantity" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-leaf"></i> Tori (kg)</label>
                        <input type="number" id="livestockTori" class="form-control" placeholder="Enter quantity" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-grass"></i> Ghaas (kg)</label>
                        <input type="number" id="livestockGhaas" class="form-control" placeholder="Enter quantity" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill"></i> Total Expense (Rs)</label>
                        <input type="number" id="livestockExpense" class="form-control" placeholder="Enter amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill-wave"></i> Income (Rs)</label>
                        <input type="number" id="livestockIncome" class="form-control" placeholder="Enter income amount" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Description</label>
                        <textarea id="livestockDescription" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="saveLivestockEntry()">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                    <button class="btn btn-danger" onclick="cancelLivestockForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <div class="stats-container" id="livestockStats">
                <!-- Stats will be dynamically generated -->
            </div>

            <div class="table-container">
                <table id="livestockTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Managed By</th>
                            <th>Khal (kg)</th>
                            <th>Chokar (kg)</th>
                            <th>Tori (kg)</th>
                            <th>Ghaas (kg)</th>
                            <th>Expense (Rs)</th>
                            <th>Income (Rs)</th>
                            <th>Balance (Rs)</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="livestockTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div id="livestockNoData" class="no-data" style="display:none;">
                    <i class="fas fa-database"></i>
                    <p>No livestock data available. Add your first entry!</p>
                </div>
            </div>
        </div>

        <!-- Crop Tab -->
        <div class="tab-content" id="crop">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-seedling"></i> Crop Management</h2>
                <div class="action-buttons">
                    <div class="search-box">
                        <input type="text" id="cropSearch" placeholder="Search crop entries...">
                    </div>
                    <button class="btn btn-primary" onclick="showCropForm()">
                        <i class="fas fa-plus"></i> Add Entry
                    </button>
                    <button class="btn btn-secondary" onclick="downloadCropTemplate()">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button class="btn btn-info" onclick="document.getElementById('cropUpload').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <input type="file" id="cropUpload" accept=".xlsx,.xls" style="display:none" onchange="uploadCropExcel(this)">
                </div>
            </div>

            <div class="form-container" id="cropForm">
                <h3 style="margin-bottom:20px; color:var(--primary-color);">
                    <i class="fas fa-edit"></i> <span id="cropFormTitle">Add New Crop Entry</span>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="cropDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Crop Type</label>
                        <input type="text" id="cropType" class="form-control" placeholder="e.g., Wheat, Rice, Corn" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Managed By</label>
                        <input type="text" id="cropManager" class="form-control" placeholder="Enter manager name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-user-friends"></i> Labor Cost (Rs)</label>
                        <input type="number" id="cropLabor" class="form-control" placeholder="Enter amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-seedling"></i> Seeds Cost (Rs)</label>
                        <input type="number" id="cropSeeds" class="form-control" placeholder="Enter amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-flask"></i> Fertilizer Cost (Rs)</label>
                        <input type="number" id="cropFertilizer" class="form-control" placeholder="Enter amount" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-tools"></i> Other Expenses (Rs)</label>
                        <input type="number" id="cropOthers" class="form-control" placeholder="Enter amount" step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill"></i> Total Expense (Rs)</label>
                        <input type="number" id="cropExpense" class="form-control" placeholder="Enter amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill-wave"></i> Income (Rs)</label>
                        <input type="number" id="cropIncome" class="form-control" placeholder="Enter income amount" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Description</label>
                        <textarea id="cropDescription" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="saveCropEntry()">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                    <button class="btn btn-danger" onclick="cancelCropForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <div class="stats-container" id="cropStats">
                <!-- Stats will be dynamically generated -->
            </div>

            <div class="table-container">
                <table id="cropTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Crop Type</th>
                            <th>Managed By</th>
                            <th>Labor (Rs)</th>
                            <th>Seeds (Rs)</th>
                            <th>Fertilizer (Rs)</th>
                            <th>Other (Rs)</th>
                            <th>Expense (Rs)</th>
                            <th>Income (Rs)</th>
                            <th>Balance (Rs)</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="cropTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div id="cropNoData" class="no-data" style="display:none;">
                    <i class="fas fa-database"></i>
                    <p>No crop data available. Add your first entry!</p>
                </div>
            </div>
        </div>

        <!-- Water Supply Tab -->
        <div class="tab-content" id="water">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-tint"></i> Water Supply Management</h2>
                <div class="action-buttons">
                    <div class="search-box">
                        <input type="text" id="waterSearch" placeholder="Search farmer entries...">
                    </div>
                    <button class="btn btn-primary" onclick="showWaterForm()">
                        <i class="fas fa-plus"></i> Add Farmer
                    </button>
                    <button class="btn btn-secondary" onclick="downloadWaterTemplate()">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button class="btn btn-info" onclick="document.getElementById('waterUpload').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <input type="file" id="waterUpload" accept=".xlsx,.xls" style="display:none" onchange="uploadWaterExcel(this)">
                </div>
            </div>

            <div class="form-container" id="waterForm">
                <h3 style="margin-bottom:20px; color:var(--primary-color);">
                    <i class="fas fa-edit"></i> <span id="waterFormTitle">Add New Water Supply Entry</span>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="waterDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Farmer Name</label>
                        <input type="text" id="waterFarmer" class="form-control" placeholder="Enter farmer name" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-phone"></i> Contact Number</label>
                        <input type="text" id="waterContact" class="form-control" placeholder="Enter contact number">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> Start Time (24hr)</label>
                        <input type="time" id="waterStart" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-clock"></i> End Time (24hr)</label>
                        <input type="time" id="waterEnd" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill"></i> Rate per Hour (Rs)</label>
                        <input type="number" id="waterRate" class="form-control" placeholder="Enter rate" step="0.01" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calculator"></i> Total Hours</label>
                        <input type="number" id="waterHours" class="form-control" placeholder="Auto-calculated" readonly step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-calculator"></i> Total Bill (Rs)</label>
                        <input type="number" id="waterBill" class="form-control" placeholder="Auto-calculated" readonly step="0.01">
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill-wave"></i> Amount Paid (Rs)</label>
                        <input type="number" id="waterPaid" class="form-control" placeholder="Enter paid amount" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Description</label>
                        <textarea id="waterDescription" class="form-control" rows="3" placeholder="Additional notes..."></textarea>
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="saveWaterEntry()">
                        <i class="fas fa-save"></i> Save Entry
                    </button>
                    <button class="btn btn-danger" onclick="cancelWaterForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <div class="stats-container" id="waterStats">
                <!-- Stats will be dynamically generated -->
            </div>

            <div class="table-container">
                <table id="waterTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Farmer Name</th>
                            <th>Contact</th>
                            <th>Start Time</th>
                            <th>End Time</th>
                            <th>Hours</th>
                            <th>Rate/Hr (Rs)</th>
                            <th>Total Bill (Rs)</th>
                            <th>Paid (Rs)</th>
                            <th>Balance (Rs)</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="waterTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div id="waterNoData" class="no-data" style="display:none;">
                    <i class="fas fa-database"></i>
                    <p>No water supply data available. Add your first entry!</p>
                </div>
            </div>
        </div>

        <!-- Expenses Tab -->
        <div class="tab-content" id="expenses">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Expense Management</h2>
                <div class="action-buttons">
                    <div class="search-box">
                        <input type="text" id="expenseSearch" placeholder="Search expense entries...">
                    </div>
                    <button class="btn btn-primary" onclick="showExpenseForm()">
                        <i class="fas fa-plus"></i> Add Expense
                    </button>
                    <button class="btn btn-secondary" onclick="downloadExpenseTemplate()">
                        <i class="fas fa-download"></i> Download Template
                    </button>
                    <button class="btn btn-info" onclick="document.getElementById('expenseUpload').click()">
                        <i class="fas fa-upload"></i> Upload Excel
                    </button>
                    <input type="file" id="expenseUpload" accept=".xlsx,.xls" style="display:none" onchange="uploadExpenseExcel(this)">
                </div>
            </div>

            <div class="form-container" id="expenseForm">
                <h3 style="margin-bottom:20px; color:var(--primary-color);">
                    <i class="fas fa-edit"></i> <span id="expenseFormTitle">Add New Expense</span>
                </h3>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-calendar"></i> Date</label>
                        <input type="date" id="expenseDate" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-tag"></i> Expense Category</label>
                        <select id="expenseCategory" class="form-control" required>
                            <option value="">Select Category</option>
                            <option value="Livestock">Livestock</option>
                            <option value="Crop">Crop</option>
                            <option value="Salary">Salary</option>
                            <option value="Employee">Employee Expense</option>
                            <option value="Machinery">Machinery</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-user"></i> Managed By</label>
                        <input type="text" id="expenseManager" class="form-control" placeholder="Enter manager name" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-file-invoice-dollar"></i> Expense Type</label>
                        <input type="text" id="expenseType" class="form-control" placeholder="e.g., Seeds, Fertilizer, Labor" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-money-bill"></i> Amount (Rs)</label>
                        <input type="number" id="expenseAmount" class="form-control" placeholder="Enter amount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label><i class="fas fa-receipt"></i> Payment Method</label>
                        <select id="expenseMethod" class="form-control">
                            <option value="Cash">Cash</option>
                            <option value="Bank">Bank Transfer</option>
                            <option value="Check">Check</option>
                            <option value="Digital">Digital Payment</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label><i class="fas fa-sticky-note"></i> Description</label>
                        <textarea id="expenseDescription" class="form-control" rows="3" placeholder="Additional details..."></textarea>
                    </div>
                </div>
                <div style="display:flex; gap:15px; margin-top:20px;">
                    <button class="btn btn-primary" onclick="saveExpenseEntry()">
                        <i class="fas fa-save"></i> Save Expense
                    </button>
                    <button class="btn btn-danger" onclick="cancelExpenseForm()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </div>

            <div class="stats-container" id="expenseStats">
                <!-- Stats will be dynamically generated -->
            </div>

            <div class="table-container">
                <table id="expenseTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Managed By</th>
                            <th>Amount (Rs)</th>
                            <th>Payment Method</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expenseTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div id="expenseNoData" class="no-data" style="display:none;">
                    <i class="fas fa-database"></i>
                    <p>No expense data available. Add your first entry!</p>
                </div>
            </div>
        </div>

        <!-- Income Tab -->
        <div class="tab-content" id="income">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-chart-line"></i> Income Dashboard</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="generateIncomePDF()">
                        <i class="fas fa-file-pdf"></i> Generate PDF Report
                    </button>
                    <button class="btn btn-secondary" onclick="downloadIncomeExcel()">
                        <i class="fas fa-file-excel"></i> Export to Excel
                    </button>
                </div>
            </div>

            <div class="stats-container" id="incomeStats">
                <!-- Stats will be dynamically generated -->
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="incomeFromDate" class="form-control">
                </div>
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="incomeToDate" class="form-control">
                </div>
                <div class="filter-group">
                    <label>Category</label>
                    <select id="incomeCategoryFilter" class="form-control">
                        <option value="">All Categories</option>
                        <option value="Livestock">Livestock</option>
                        <option value="Crop">Crop</option>
                        <option value="Water">Water Supply</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="filterIncomeData()">
                    <i class="fas fa-filter"></i> Filter
                </button>
                <button class="btn btn-secondary" onclick="resetIncomeFilter()">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>

            <div class="table-container">
                <table id="incomeTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Source</th>
                            <th>Category</th>
                            <th>Amount (Rs)</th>
                            <th>Description</th>
                            <th>Received By</th>
                        </tr>
                    </thead>
                    <tbody id="incomeTableBody">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
                <div id="incomeNoData" class="no-data" style="display:none;">
                    <i class="fas fa-database"></i>
                    <p>No income data available.</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports">
            <div class="section-header">
                <h2 class="section-title"><i class="fas fa-file-alt"></i> Reports & Analytics</h2>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="generateSummaryReport()">
                        <i class="fas fa-file-pdf"></i> Full Report
                    </button>
                    <button class="btn btn-secondary" onclick="generateLedgerReport()">
                        <i class="fas fa-book"></i> Ledger Report
                    </button>
                </div>
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">
                        <i class="fas fa-cow" style="color:var(--primary-color);"></i>
                        Total Livestock Income
                    </div>
                    <div class="stat-value" id="reportLivestockIncome">Rs 0</div>
                    <div class="stat-change positive" id="reportLivestockChange">
                        <i class="fas fa-arrow-up"></i> 0% from last month
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">
                        <i class="fas fa-seedling" style="color:var(--secondary-color);"></i>
                        Total Crop Income
                    </div>
                    <div class="stat-value" id="reportCropIncome">Rs 0</div>
                    <div class="stat-change positive" id="reportCropChange">
                        <i class="fas fa-arrow-up"></i> 0% from last month
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">
                        <i class="fas fa-tint" style="color:var(--info-color);"></i>
                        Water Supply Revenue
                    </div>
                    <div class="stat-value" id="reportWaterIncome">Rs 0</div>
                    <div class="stat-change positive" id="reportWaterChange">
                        <i class="fas fa-arrow-up"></i> 0% from last month
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">
                        <i class="fas fa-money-bill-wave" style="color:var(--warning-color);"></i>
                        Total Expenses
                    </div>
                    <div class="stat-value" id="reportTotalExpenses">Rs 0</div>
                    <div class="stat-change negative" id="reportExpenseChange">
                        <i class="fas fa-arrow-up"></i> 0% from last month
                    </div>
                </div>
            </div>

            <div class="filter-container">
                <div class="filter-group">
                    <label>Report Type</label>
                    <select id="reportType" class="form-control" onchange="updateReportFilters()">
                        <option value="summary">Summary Report</option>
                        <option value="category">Category-wise Report</option>
                        <option value="ledger">Ledger Report</option>
                        <option value="manager">Expense Manager Report</option>
                    </select>
                </div>
                <div class="filter-group" id="categoryFilterGroup">
                    <label>Category</label>
                    <select id="reportCategory" class="form-control">
                        <option value="">All Categories</option>
                        <option value="Livestock">Livestock</option>
                        <option value="Crop">Crop</option>
                        <option value="Water">Water Supply</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>From Date</label>
                    <input type="date" id="reportFromDate" class="form-control">
                </div>
                <div class="filter-group">
                    <label>To Date</label>
                    <input type="date" id="reportToDate" class="form-control">
                </div>
                <button class="btn btn-primary" onclick="generateReport()">
                    <i class="fas fa-chart-bar"></i> Generate Report
                </button>
                <button class="btn btn-secondary" onclick="exportReportExcel()">
                    <i class="fas fa-file-excel"></i> Export Excel
                </button>
            </div>

            <div class="table-container">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <!-- Dynamic headers based on report type -->
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Report data will be loaded here -->
                    </tbody>
                </table>
                <div id="reportNoData" class="no-data" style="display:none;">
                    <i class="fas fa-chart-bar"></i>
                    <p>No report data available. Generate a report to see data.</p>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2024 AgriFarm Management System | Developed for Agricultural Business Management</p>
            <p style="margin-top:10px; font-size:0.8rem;">
                <i class="fas fa-sync-alt"></i> Auto-save enabled | All data is stored in your browser's local storage
            </p>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification">
        <i class="fas fa-check-circle"></i>
        <span id="notificationMessage">Operation successful!</span>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal" id="pdfModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;"><i class="fas fa-file-pdf"></i> PDF Preview</h3>
                <button class="close-modal" onclick="closePDFModal()">Ã</button>
            </div>
            <div class="modal-body">
                <iframe id="pdfViewer" style="width:100%; height:500px; border:none;"></iframe>
            </div>
        </div>
    </div>

    <script>
        // Initialize data storage
        let livestockData = JSON.parse(localStorage.getItem('livestockData')) || [];
        let cropData = JSON.parse(localStorage.getItem('cropData')) || [];
        let waterData = JSON.parse(localStorage.getItem('waterData')) || [];
        let expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
        let editingId = null;
        let currentEditingTab = null;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for all date inputs
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(input => {
                if (!input.id.includes('From') && !input.id.includes('To')) {
                    input.value = today;
                }
            });

            // Load all data
            loadLivestockData();
            loadCropData();
            loadWaterData();
            loadExpenseData();
            loadIncomeData();
            updateReportStats();

            // Setup tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });

            // Setup search functionality
            setupSearch();
            
            // Setup auto-save
            setupAutoSave();
            
            // Setup real-time calculations
            setupCalculations();
            
            // Show welcome notification
            showNotification('Welcome to AgriFarm Management System! All data is auto-saved.', 'success');
        });

        // Tab switching function
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            // Deactivate all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab content
            document.getElementById(tabId).classList.add('active');

            // Activate clicked tab
            document.querySelector(`.tab[data-tab="${tabId}"]`).classList.add('active');
        }

        // Setup search functionality
        function setupSearch() {
            const searchIds = ['livestockSearch', 'cropSearch', 'waterSearch', 'expenseSearch'];
            searchIds.forEach(id => {
                const searchInput = document.getElementById(id);
                if (searchInput) {
                    searchInput.addEventListener('input', function(e) {
                        const searchTerm = e.target.value.toLowerCase();
                        const tabId = id.replace('Search', '');
                        
                        switch(tabId) {
                            case 'livestock':
                                filterLivestockData(searchTerm);
                                break;
                            case 'crop':
                                filterCropData(searchTerm);
                                break;
                            case 'water':
                                filterWaterData(searchTerm);
                                break;
                            case 'expense':
                                filterExpenseData(searchTerm);
                                break;
                        }
                    });
                }
            });
        }

        // Setup auto-save
        function setupAutoSave() {
            // Save data to localStorage whenever changes are made
            setInterval(() => {
                localStorage.setItem('livestockData', JSON.stringify(livestockData));
                localStorage.setItem('cropData', JSON.stringify(cropData));
                localStorage.setItem('waterData', JSON.stringify(waterData));
                localStorage.setItem('expenseData', JSON.stringify(expenseData));
            }, 2000); // Auto-save every 2 seconds
        }

        // Setup real-time calculations
        function setupCalculations() {
            // Water supply calculations
            const waterStart = document.getElementById('waterStart');
            const waterEnd = document.getElementById('waterEnd');
            const waterRate = document.getElementById('waterRate');
            
            function calculateWaterBill() {
                if (waterStart.value && waterEnd.value && waterRate.value) {
                    const start = new Date(`2000-01-01T${waterStart.value}`);
                    const end = new Date(`2000-01-01T${waterEnd.value}`);
                    
                    // Handle overnight time
                    if (end < start) {
                        end.setDate(end.getDate() + 1);
                    }
                    
                    const hours = (end - start) / (1000 * 60 * 60);
                    document.getElementById('waterHours').value = hours.toFixed(2);
                    document.getElementById('waterBill').value = (hours * parseFloat(waterRate.value)).toFixed(2);
                }
            }
            
            if (waterStart && waterEnd && waterRate) {
                waterStart.addEventListener('change', calculateWaterBill);
                waterEnd.addEventListener('change', calculateWaterBill);
                waterRate.addEventListener('input', calculateWaterBill);
            }
            
            // Auto-calculate total expense for crop
            const cropInputs = ['cropLabor', 'cropSeeds', 'cropFertilizer', 'cropOthers'];
            cropInputs.forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', calculateCropTotal);
                }
            });
            
            function calculateCropTotal() {
                let total = 0;
                cropInputs.forEach(id => {
                    const value = parseFloat(document.getElementById(id).value) || 0;
                    total += value;
                });
                document.getElementById('cropExpense').value = total.toFixed(2);
            }
        }

        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageElement = document.getElementById('notificationMessage');
            
            notification.className = `notification ${type}`;
            messageElement.textContent = message;
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ========== LIVESTOCK MANAGEMENT ==========
        function showLivestockForm() {
            document.getElementById('livestockForm').classList.add('active');
            editingId = null;
            currentEditingTab = 'livestock';
            document.getElementById('livestockFormTitle').textContent = 'Add New Livestock Entry';
            resetLivestockForm();
        }

        function cancelLivestockForm() {
            document.getElementById('livestockForm').classList.remove('active');
            editingId = null;
            currentEditingTab = null;
        }

        function resetLivestockForm() {
            document.getElementById('livestockDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('livestockCategory').value = '';
            document.getElementById('livestockManager').value = '';
            document.getElementById('livestockKhal').value = '';
            document.getElementById('livestockChokar').value = '';
            document.getElementById('livestockTori').value = '';
            document.getElementById('livestockGhaas').value = '';
            document.getElementById('livestockExpense').value = '';
            document.getElementById('livestockIncome').value = '';
            document.getElementById('livestockDescription').value = '';
        }

        function saveLivestockEntry() {
            const entry = {
                id: editingId || Date.now(),
                date: document.getElementById('livestockDate').value,
                category: document.getElementById('livestockCategory').value,
                manager: document.getElementById('livestockManager').value,
                khal: parseFloat(document.getElementById('livestockKhal').value) || 0,
                chokar: parseFloat(document.getElementById('livestockChokar').value) || 0,
                tori: parseFloat(document.getElementById('livestockTori').value) || 0,
                ghaas: parseFloat(document.getElementById('livestockGhaas').value) || 0,
                expense: parseFloat(document.getElementById('livestockExpense').value) || 0,
                income: parseFloat(document.getElementById('livestockIncome').value) || 0,
                description: document.getElementById('livestockDescription').value,
                timestamp: new Date().toISOString()
            };

            if (!entry.date || !entry.category || !entry.manager) {
                showNotification('Please fill all required fields!', 'error');
                return;
            }

            if (editingId) {
                const index = livestockData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    livestockData[index] = entry;
                    showNotification('Livestock entry updated successfully!', 'success');
                }
            } else {
                livestockData.push(entry);
                showNotification('Livestock entry added successfully!', 'success');
            }

            localStorage.setItem('livestockData', JSON.stringify(livestockData));
            loadLivestockData();
            cancelLivestockForm();
        }

        function loadLivestockData() {
            const tbody = document.getElementById('livestockTableBody');
            tbody.innerHTML = '';
            
            if (livestockData.length === 0) {
                document.getElementById('livestockNoData').style.display = 'block';
                updateLivestockStats();
                return;
            }
            
            document.getElementById('livestockNoData').style.display = 'none';
            
            livestockData.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                const balance = entry.income - entry.expense;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td><span class="badge" style="background:#4CAF50;color:white;padding:4px 8px;border-radius:4px;">${entry.category}</span></td>
                    <td>${entry.manager}</td>
                    <td>${entry.khal || '0'}</td>
                    <td>${entry.chokar || '0'}</td>
                    <td>${entry.tori || '0'}</td>
                    <td>${entry.ghaas || '0'}</td>
                    <td style="color:#f44336;font-weight:bold;">Rs ${formatNumber(entry.expense)}</td>
                    <td style="color:#4CAF50;font-weight:bold;">Rs ${formatNumber(entry.income)}</td>
                    <td style="color:${balance >= 0 ? '#4CAF50' : '#f44336'};font-weight:bold;">Rs ${formatNumber(balance)}</td>
                    <td>${entry.description || '-'}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit" onclick="editLivestockEntry(${entry.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete" onclick="deleteLivestockEntry(${entry.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateLivestockStats();
            filterLivestockData(document.getElementById('livestockSearch').value);
        }

        function editLivestockEntry(id) {
            const entry = livestockData.find(item => item.id === id);
            if (entry) {
                editingId = id;
                currentEditingTab = 'livestock';
                document.getElementById('livestockForm').classList.add('active');
                document.getElementById('livestockFormTitle').textContent = 'Edit Livestock Entry';
                
                document.getElementById('livestockDate').value = entry.date;
                document.getElementById('livestockCategory').value = entry.category;
                document.getElementById('livestockManager').value = entry.manager;
                document.getElementById('livestockKhal').value = entry.khal || '';
                document.getElementById('livestockChokar').value = entry.chokar || '';
                document.getElementById('livestockTori').value = entry.tori || '';
                document.getElementById('livestockGhaas').value = entry.ghaas || '';
                document.getElementById('livestockExpense').value = entry.expense || '';
                document.getElementById('livestockIncome').value = entry.income || '';
                document.getElementById('livestockDescription').value = entry.description || '';
                
                // Scroll to form
                document.getElementById('livestockForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteLivestockEntry(id) {
            if (confirm('Are you sure you want to delete this livestock entry?')) {
                livestockData = livestockData.filter(item => item.id !== id);
                localStorage.setItem('livestockData', JSON.stringify(livestockData));
                loadLivestockData();
                showNotification('Livestock entry deleted successfully!', 'success');
            }
        }

        function updateLivestockStats() {
            const statsContainer = document.getElementById('livestockStats');
            if (!statsContainer) return;
            
            const totalExpense = livestockData.reduce((sum, item) => sum + (item.expense || 0), 0);
            const totalIncome = livestockData.reduce((sum, item) => sum + (item.income || 0), 0);
            const totalBalance = totalIncome - totalExpense;
            
            // Group by category
            const categoryStats = {};
            livestockData.forEach(item => {
                if (!categoryStats[item.category]) {
                    categoryStats[item.category] = { expense: 0, income: 0 };
                }
                categoryStats[item.category].expense += item.expense || 0;
                categoryStats[item.category].income += item.income || 0;
            });
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-bill-wave"></i> Total Expense</div>
                    <div class="stat-value" style="color:#f44336;">Rs ${formatNumber(totalExpense)}</div>
                    <div class="stat-change">All livestock categories</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-chart-line"></i> Total Income</div>
                    <div class="stat-value" style="color:#4CAF50;">Rs ${formatNumber(totalIncome)}</div>
                    <div class="stat-change positive">From livestock sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-balance-scale"></i> Net Balance</div>
                    <div class="stat-value" style="color:${totalBalance >= 0 ? '#4CAF50' : '#f44336'};">Rs ${formatNumber(totalBalance)}</div>
                    <div class="stat-change ${totalBalance >= 0 ? 'positive' : 'negative'}">
                        ${totalBalance >= 0 ? 'Profit' : 'Loss'}
                    </div>
                </div>
            `;
            
            // Add a category summary if there are multiple categories
            const categories = Object.keys(categoryStats);
            if (categories.length > 0) {
                const mainCategory = categories[0];
                const catExpense = categoryStats[mainCategory].expense;
                const catIncome = categoryStats[mainCategory].income;
                const catBalance = catIncome - catExpense;
                
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-cow"></i> ${mainCategory} Summary</div>
                        <div class="stat-value">Rs ${formatNumber(catBalance)}</div>
                        <div class="stat-change">
                            Income: Rs ${formatNumber(catIncome)} | Expense: Rs ${formatNumber(catExpense)}
                        </div>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = statsHTML;
        }

        function filterLivestockData(searchTerm = '') {
            const tbody = document.getElementById('livestockTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            }
        }

        function downloadLivestockTemplate() {
            const template = [
                ['Date', 'Category', 'Managed By', 'Khal (kg)', 'Chokar (kg)', 'Tori (kg)', 'Ghaas (kg)', 'Expense (Rs)', 'Income (Rs)', 'Description']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Livestock Template');
            
            XLSX.writeFile(wb, 'Livestock_Template.xlsx');
            showNotification('Livestock template downloaded!', 'success');
        }

        function uploadLivestockExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                let importedCount = 0;
                jsonData.forEach(row => {
                    if (row.Date && row.Category && row['Managed By']) {
                        const entry = {
                            id: Date.now() + Math.random(),
                            date: formatExcelDate(row.Date),
                            category: row.Category,
                            manager: row['Managed By'],
                            khal: parseFloat(row['Khal (kg)']) || 0,
                            chokar: parseFloat(row['Chokar (kg)']) || 0,
                            tori: parseFloat(row['Tori (kg)']) || 0,
                            ghaas: parseFloat(row['Ghaas (kg)']) || 0,
                            expense: parseFloat(row['Expense (Rs)']) || 0,
                            income: parseFloat(row['Income (Rs)']) || 0,
                            description: row.Description || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        livestockData.push(entry);
                        importedCount++;
                    }
                });
                
                localStorage.setItem('livestockData', JSON.stringify(livestockData));
                loadLivestockData();
                showNotification(`Imported ${importedCount} livestock entries successfully!`, 'success');
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // ========== CROP MANAGEMENT ==========
        function showCropForm() {
            document.getElementById('cropForm').classList.add('active');
            editingId = null;
            currentEditingTab = 'crop';
            document.getElementById('cropFormTitle').textContent = 'Add New Crop Entry';
            resetCropForm();
        }

        function cancelCropForm() {
            document.getElementById('cropForm').classList.remove('active');
            editingId = null;
            currentEditingTab = null;
        }

        function resetCropForm() {
            document.getElementById('cropDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('cropType').value = '';
            document.getElementById('cropManager').value = '';
            document.getElementById('cropLabor').value = '';
            document.getElementById('cropSeeds').value = '';
            document.getElementById('cropFertilizer').value = '';
            document.getElementById('cropOthers').value = '';
            document.getElementById('cropExpense').value = '';
            document.getElementById('cropIncome').value = '';
            document.getElementById('cropDescription').value = '';
        }

        function saveCropEntry() {
            const entry = {
                id: editingId || Date.now(),
                date: document.getElementById('cropDate').value,
                type: document.getElementById('cropType').value,
                manager: document.getElementById('cropManager').value,
                labor: parseFloat(document.getElementById('cropLabor').value) || 0,
                seeds: parseFloat(document.getElementById('cropSeeds').value) || 0,
                fertilizer: parseFloat(document.getElementById('cropFertilizer').value) || 0,
                others: parseFloat(document.getElementById('cropOthers').value) || 0,
                expense: parseFloat(document.getElementById('cropExpense').value) || 0,
                income: parseFloat(document.getElementById('cropIncome').value) || 0,
                description: document.getElementById('cropDescription').value,
                timestamp: new Date().toISOString()
            };

            if (!entry.date || !entry.type || !entry.manager) {
                showNotification('Please fill all required fields!', 'error');
                return;
            }

            if (editingId) {
                const index = cropData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    cropData[index] = entry;
                    showNotification('Crop entry updated successfully!', 'success');
                }
            } else {
                cropData.push(entry);
                showNotification('Crop entry added successfully!', 'success');
            }

            localStorage.setItem('cropData', JSON.stringify(cropData));
            loadCropData();
            cancelCropForm();
        }

        function loadCropData() {
            const tbody = document.getElementById('cropTableBody');
            tbody.innerHTML = '';
            
            if (cropData.length === 0) {
                document.getElementById('cropNoData').style.display = 'block';
                updateCropStats();
                return;
            }
            
            document.getElementById('cropNoData').style.display = 'none';
            
            cropData.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                const balance = entry.income - entry.expense;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td><span class="badge" style="background:#8BC34A;color:white;padding:4px 8px;border-radius:4px;">${entry.type}</span></td>
                    <td>${entry.manager}</td>
                    <td>${entry.labor ? 'Rs ' + formatNumber(entry.labor) : '0'}</td>
                    <td>${entry.seeds ? 'Rs ' + formatNumber(entry.seeds) : '0'}</td>
                    <td>${entry.fertilizer ? 'Rs ' + formatNumber(entry.fertilizer) : '0'}</td>
                    <td>${entry.others ? 'Rs ' + formatNumber(entry.others) : '0'}</td>
                    <td style="color:#f44336;font-weight:bold;">Rs ${formatNumber(entry.expense)}</td>
                    <td style="color:#4CAF50;font-weight:bold;">Rs ${formatNumber(entry.income)}</td>
                    <td style="color:${balance >= 0 ? '#4CAF50' : '#f44336'};font-weight:bold;">Rs ${formatNumber(balance)}</td>
                    <td>${entry.description || '-'}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit" onclick="editCropEntry(${entry.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete" onclick="deleteCropEntry(${entry.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateCropStats();
            filterCropData(document.getElementById('cropSearch').value);
        }

        function editCropEntry(id) {
            const entry = cropData.find(item => item.id === id);
            if (entry) {
                editingId = id;
                currentEditingTab = 'crop';
                document.getElementById('cropForm').classList.add('active');
                document.getElementById('cropFormTitle').textContent = 'Edit Crop Entry';
                
                document.getElementById('cropDate').value = entry.date;
                document.getElementById('cropType').value = entry.type;
                document.getElementById('cropManager').value = entry.manager;
                document.getElementById('cropLabor').value = entry.labor || '';
                document.getElementById('cropSeeds').value = entry.seeds || '';
                document.getElementById('cropFertilizer').value = entry.fertilizer || '';
                document.getElementById('cropOthers').value = entry.others || '';
                document.getElementById('cropExpense').value = entry.expense || '';
                document.getElementById('cropIncome').value = entry.income || '';
                document.getElementById('cropDescription').value = entry.description || '';
                
                document.getElementById('cropForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteCropEntry(id) {
            if (confirm('Are you sure you want to delete this crop entry?')) {
                cropData = cropData.filter(item => item.id !== id);
                localStorage.setItem('cropData', JSON.stringify(cropData));
                loadCropData();
                showNotification('Crop entry deleted successfully!', 'success');
            }
        }

        function updateCropStats() {
            const statsContainer = document.getElementById('cropStats');
            if (!statsContainer) return;
            
            const totalExpense = cropData.reduce((sum, item) => sum + (item.expense || 0), 0);
            const totalIncome = cropData.reduce((sum, item) => sum + (item.income || 0), 0);
            const totalBalance = totalIncome - totalExpense;
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-bill-wave"></i> Total Crop Expense</div>
                    <div class="stat-value" style="color:#f44336;">Rs ${formatNumber(totalExpense)}</div>
                    <div class="stat-change">Labor, seeds, fertilizer & others</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-chart-line"></i> Total Crop Income</div>
                    <div class="stat-value" style="color:#4CAF50;">Rs ${formatNumber(totalIncome)}</div>
                    <div class="stat-change positive">From crop sales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-balance-scale"></i> Crop Net Balance</div>
                    <div class="stat-value" style="color:${totalBalance >= 0 ? '#4CAF50' : '#f44336'};">Rs ${formatNumber(totalBalance)}</div>
                    <div class="stat-change ${totalBalance >= 0 ? 'positive' : 'negative'}">
                        ${totalBalance >= 0 ? 'Profit' : 'Loss'}
                    </div>
                </div>
            `;
            
            // Add expense breakdown if available
            if (cropData.length > 0) {
                const totalLabor = cropData.reduce((sum, item) => sum + (item.labor || 0), 0);
                const totalSeeds = cropData.reduce((sum, item) => sum + (item.seeds || 0), 0);
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-chart-pie"></i> Expense Breakdown</div>
                        <div class="stat-value">Rs ${formatNumber(totalLabor + totalSeeds)}</div>
                        <div class="stat-change">
                            Labor: Rs ${formatNumber(totalLabor)} | Seeds: Rs ${formatNumber(totalSeeds)}
                        </div>
                    </div>
                `;
            }
            
            statsContainer.innerHTML = statsHTML;
        }

        function filterCropData(searchTerm = '') {
            const tbody = document.getElementById('cropTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            }
        }

        function downloadCropTemplate() {
            const template = [
                ['Date', 'Crop Type', 'Managed By', 'Labor Cost (Rs)', 'Seeds Cost (Rs)', 'Fertilizer Cost (Rs)', 'Other Expenses (Rs)', 'Total Expense (Rs)', 'Income (Rs)', 'Description']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Crop Template');
            
            XLSX.writeFile(wb, 'Crop_Template.xlsx');
            showNotification('Crop template downloaded!', 'success');
        }

        function uploadCropExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                let importedCount = 0;
                jsonData.forEach(row => {
                    if (row.Date && row['Crop Type'] && row['Managed By']) {
                        const entry = {
                            id: Date.now() + Math.random(),
                            date: formatExcelDate(row.Date),
                            type: row['Crop Type'],
                            manager: row['Managed By'],
                            labor: parseFloat(row['Labor Cost (Rs)']) || 0,
                            seeds: parseFloat(row['Seeds Cost (Rs)']) || 0,
                            fertilizer: parseFloat(row['Fertilizer Cost (Rs)']) || 0,
                            others: parseFloat(row['Other Expenses (Rs)']) || 0,
                            expense: parseFloat(row['Total Expense (Rs)']) || 0,
                            income: parseFloat(row['Income (Rs)']) || 0,
                            description: row.Description || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        cropData.push(entry);
                        importedCount++;
                    }
                });
                
                localStorage.setItem('cropData', JSON.stringify(cropData));
                loadCropData();
                showNotification(`Imported ${importedCount} crop entries successfully!`, 'success');
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // ========== WATER SUPPLY MANAGEMENT ==========
        function showWaterForm() {
            document.getElementById('waterForm').classList.add('active');
            editingId = null;
            currentEditingTab = 'water';
            document.getElementById('waterFormTitle').textContent = 'Add New Water Supply Entry';
            resetWaterForm();
        }

        function cancelWaterForm() {
            document.getElementById('waterForm').classList.remove('active');
            editingId = null;
            currentEditingTab = null;
        }

        function resetWaterForm() {
            document.getElementById('waterDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('waterFarmer').value = '';
            document.getElementById('waterContact').value = '';
            document.getElementById('waterStart').value = '08:00';
            document.getElementById('waterEnd').value = '12:00';
            document.getElementById('waterRate').value = '100';
            document.getElementById('waterHours').value = '';
            document.getElementById('waterBill').value = '';
            document.getElementById('waterPaid').value = '';
            document.getElementById('waterDescription').value = '';
            
            // Trigger calculation
            setTimeout(() => {
                if (document.getElementById('waterStart').value && 
                    document.getElementById('waterEnd').value && 
                    document.getElementById('waterRate').value) {
                    calculateWaterBill();
                }
            }, 100);
        }

        function calculateWaterBill() {
            const start = document.getElementById('waterStart').value;
            const end = document.getElementById('waterEnd').value;
            const rate = document.getElementById('waterRate').value;
            
            if (!start || !end || !rate) return;
            
            const startTime = new Date(`2000-01-01T${start}`);
            const endTime = new Date(`2000-01-01T${end}`);
            
            if (endTime < startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            const hours = (endTime - startTime) / (1000 * 60 * 60);
            const bill = hours * parseFloat(rate);
            
            document.getElementById('waterHours').value = hours.toFixed(2);
            document.getElementById('waterBill').value = bill.toFixed(2);
        }

        function saveWaterEntry() {
            const entry = {
                id: editingId || Date.now(),
                date: document.getElementById('waterDate').value,
                farmer: document.getElementById('waterFarmer').value,
                contact: document.getElementById('waterContact').value,
                start: document.getElementById('waterStart').value,
                end: document.getElementById('waterEnd').value,
                rate: parseFloat(document.getElementById('waterRate').value) || 0,
                hours: parseFloat(document.getElementById('waterHours').value) || 0,
                bill: parseFloat(document.getElementById('waterBill').value) || 0,
                paid: parseFloat(document.getElementById('waterPaid').value) || 0,
                description: document.getElementById('waterDescription').value,
                timestamp: new Date().toISOString()
            };

            if (!entry.date || !entry.farmer || !entry.start || !entry.end) {
                showNotification('Please fill all required fields!', 'error');
                return;
            }

            entry.balance = entry.bill - entry.paid;

            if (editingId) {
                const index = waterData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    waterData[index] = entry;
                    showNotification('Water supply entry updated successfully!', 'success');
                }
            } else {
                waterData.push(entry);
                showNotification('Water supply entry added successfully!', 'success');
            }

            localStorage.setItem('waterData', JSON.stringify(waterData));
            loadWaterData();
            cancelWaterForm();
        }

        function loadWaterData() {
            const tbody = document.getElementById('waterTableBody');
            tbody.innerHTML = '';
            
            if (waterData.length === 0) {
                document.getElementById('waterNoData').style.display = 'block';
                updateWaterStats();
                return;
            }
            
            document.getElementById('waterNoData').style.display = 'none';
            
            waterData.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                const balance = (entry.bill || 0) - (entry.paid || 0);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td><strong>${entry.farmer}</strong></td>
                    <td>${entry.contact || '-'}</td>
                    <td>${entry.start}</td>
                    <td>${entry.end}</td>
                    <td>${entry.hours ? entry.hours.toFixed(2) : '0'}</td>
                    <td>Rs ${formatNumber(entry.rate)}</td>
                    <td style="font-weight:bold;">Rs ${formatNumber(entry.bill)}</td>
                    <td style="color:#4CAF50;">Rs ${formatNumber(entry.paid)}</td>
                    <td style="color:${balance > 0 ? '#f44336' : '#4CAF50'};font-weight:bold;">
                        Rs ${formatNumber(balance)}
                    </td>
                    <td>${entry.description || '-'}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit" onclick="editWaterEntry(${entry.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete" onclick="deleteWaterEntry(${entry.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateWaterStats();
            filterWaterData(document.getElementById('waterSearch').value);
        }

        function editWaterEntry(id) {
            const entry = waterData.find(item => item.id === id);
            if (entry) {
                editingId = id;
                currentEditingTab = 'water';
                document.getElementById('waterForm').classList.add('active');
                document.getElementById('waterFormTitle').textContent = 'Edit Water Supply Entry';
                
                document.getElementById('waterDate').value = entry.date;
                document.getElementById('waterFarmer').value = entry.farmer;
                document.getElementById('waterContact').value = entry.contact || '';
                document.getElementById('waterStart').value = entry.start;
                document.getElementById('waterEnd').value = entry.end;
                document.getElementById('waterRate').value = entry.rate || '';
                document.getElementById('waterHours').value = entry.hours || '';
                document.getElementById('waterBill').value = entry.bill || '';
                document.getElementById('waterPaid').value = entry.paid || '';
                document.getElementById('waterDescription').value = entry.description || '';
                
                document.getElementById('waterForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteWaterEntry(id) {
            if (confirm('Are you sure you want to delete this water supply entry?')) {
                waterData = waterData.filter(item => item.id !== id);
                localStorage.setItem('waterData', JSON.stringify(waterData));
                loadWaterData();
                showNotification('Water supply entry deleted successfully!', 'success');
            }
        }

        function updateWaterStats() {
            const statsContainer = document.getElementById('waterStats');
            if (!statsContainer) return;
            
            const totalBill = waterData.reduce((sum, item) => sum + (item.bill || 0), 0);
            const totalPaid = waterData.reduce((sum, item) => sum + (item.paid || 0), 0);
            const totalBalance = totalBill - totalPaid;
            const totalFarmers = new Set(waterData.map(item => item.farmer)).size;
            const totalHours = waterData.reduce((sum, item) => sum + (item.hours || 0), 0);
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-file-invoice-dollar"></i> Total Billing</div>
                    <div class="stat-value">Rs ${formatNumber(totalBill)}</div>
                    <div class="stat-change">From ${totalFarmers} farmers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-check"></i> Total Received</div>
                    <div class="stat-value" style="color:#4CAF50;">Rs ${formatNumber(totalPaid)}</div>
                    <div class="stat-change positive">${((totalPaid/totalBill)*100).toFixed(1)}% collected</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-clock"></i> Total Hours</div>
                    <div class="stat-value">${totalHours.toFixed(1)} hrs</div>
                    <div class="stat-change">Water supply duration</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-balance-scale"></i> Pending Balance</div>
                    <div class="stat-value" style="color:${totalBalance > 0 ? '#f44336' : '#4CAF50'};">Rs ${formatNumber(totalBalance)}</div>
                    <div class="stat-change ${totalBalance > 0 ? 'negative' : 'positive'}">
                        ${totalBalance > 0 ? 'Amount due' : 'All paid'}
                    </div>
                </div>
            `;
            
            statsContainer.innerHTML = statsHTML;
        }

        function filterWaterData(searchTerm = '') {
            const tbody = document.getElementById('waterTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            }
        }

        function downloadWaterTemplate() {
            const template = [
                ['Date', 'Farmer Name', 'Contact Number', 'Start Time', 'End Time', 'Rate per Hour (Rs)', 'Amount Paid (Rs)', 'Description']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Water Template');
            
            XLSX.writeFile(wb, 'Water_Supply_Template.xlsx');
            showNotification('Water supply template downloaded!', 'success');
        }

        function uploadWaterExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                let importedCount = 0;
                jsonData.forEach(row => {
                    if (row.Date && row['Farmer Name']) {
                        const startTime = row['Start Time'] || '08:00';
                        const endTime = row['End Time'] || '12:00';
                        const rate = parseFloat(row['Rate per Hour (Rs)']) || 100;
                        
                        // Calculate hours and bill
                        const start = new Date(`2000-01-01T${startTime}`);
                        const end = new Date(`2000-01-01T${endTime}`);
                        if (end < start) end.setDate(end.getDate() + 1);
                        const hours = (end - start) / (1000 * 60 * 60);
                        const bill = hours * rate;
                        
                        const entry = {
                            id: Date.now() + Math.random(),
                            date: formatExcelDate(row.Date),
                            farmer: row['Farmer Name'],
                            contact: row['Contact Number'] || '',
                            start: startTime,
                            end: endTime,
                            rate: rate,
                            hours: hours,
                            bill: bill,
                            paid: parseFloat(row['Amount Paid (Rs)']) || 0,
                            description: row.Description || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        waterData.push(entry);
                        importedCount++;
                    }
                });
                
                localStorage.setItem('waterData', JSON.stringify(waterData));
                loadWaterData();
                showNotification(`Imported ${importedCount} water supply entries successfully!`, 'success');
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // ========== EXPENSE MANAGEMENT ==========
        function showExpenseForm() {
            document.getElementById('expenseForm').classList.add('active');
            editingId = null;
            currentEditingTab = 'expense';
            document.getElementById('expenseFormTitle').textContent = 'Add New Expense';
            resetExpenseForm();
        }

        function cancelExpenseForm() {
            document.getElementById('expenseForm').classList.remove('active');
            editingId = null;
            currentEditingTab = null;
        }

        function resetExpenseForm() {
            document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('expenseCategory').value = '';
            document.getElementById('expenseManager').value = '';
            document.getElementById('expenseType').value = '';
            document.getElementById('expenseAmount').value = '';
            document.getElementById('expenseMethod').value = 'Cash';
            document.getElementById('expenseDescription').value = '';
        }

        function saveExpenseEntry() {
            const entry = {
                id: editingId || Date.now(),
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseCategory').value,
                manager: document.getElementById('expenseManager').value,
                type: document.getElementById('expenseType').value,
                amount: parseFloat(document.getElementById('expenseAmount').value) || 0,
                method: document.getElementById('expenseMethod').value,
                description: document.getElementById('expenseDescription').value,
                timestamp: new Date().toISOString()
            };

            if (!entry.date || !entry.category || !entry.manager || !entry.type || entry.amount <= 0) {
                showNotification('Please fill all required fields with valid data!', 'error');
                return;
            }

            if (editingId) {
                const index = expenseData.findIndex(item => item.id === editingId);
                if (index !== -1) {
                    expenseData[index] = entry;
                    showNotification('Expense updated successfully!', 'success');
                }
            } else {
                expenseData.push(entry);
                showNotification('Expense added successfully!', 'success');
            }

            localStorage.setItem('expenseData', JSON.stringify(expenseData));
            loadExpenseData();
            cancelExpenseForm();
        }

        function loadExpenseData() {
            const tbody = document.getElementById('expenseTableBody');
            tbody.innerHTML = '';
            
            if (expenseData.length === 0) {
                document.getElementById('expenseNoData').style.display = 'block';
                updateExpenseStats();
                return;
            }
            
            document.getElementById('expenseNoData').style.display = 'none';
            
            expenseData.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td><span class="badge" style="background:#FF9800;color:white;padding:4px 8px;border-radius:4px;">${entry.category}</span></td>
                    <td>${entry.type}</td>
                    <td>${entry.manager}</td>
                    <td style="color:#f44336;font-weight:bold;">Rs ${formatNumber(entry.amount)}</td>
                    <td>${entry.method}</td>
                    <td>${entry.description || '-'}</td>
                    <td class="actions-cell">
                        <button class="action-btn edit" onclick="editExpenseEntry(${entry.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="action-btn delete" onclick="deleteExpenseEntry(${entry.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            updateExpenseStats();
            filterExpenseData(document.getElementById('expenseSearch').value);
        }

        function editExpenseEntry(id) {
            const entry = expenseData.find(item => item.id === id);
            if (entry) {
                editingId = id;
                currentEditingTab = 'expense';
                document.getElementById('expenseForm').classList.add('active');
                document.getElementById('expenseFormTitle').textContent = 'Edit Expense';
                
                document.getElementById('expenseDate').value = entry.date;
                document.getElementById('expenseCategory').value = entry.category;
                document.getElementById('expenseManager').value = entry.manager;
                document.getElementById('expenseType').value = entry.type;
                document.getElementById('expenseAmount').value = entry.amount;
                document.getElementById('expenseMethod').value = entry.method;
                document.getElementById('expenseDescription').value = entry.description || '';
                
                document.getElementById('expenseForm').scrollIntoView({ behavior: 'smooth' });
            }
        }

        function deleteExpenseEntry(id) {
            if (confirm('Are you sure you want to delete this expense entry?')) {
                expenseData = expenseData.filter(item => item.id !== id);
                localStorage.setItem('expenseData', JSON.stringify(expenseData));
                loadExpenseData();
                showNotification('Expense deleted successfully!', 'success');
            }
        }

        function updateExpenseStats() {
            const statsContainer = document.getElementById('expenseStats');
            if (!statsContainer) return;
            
            const totalExpense = expenseData.reduce((sum, item) => sum + (item.amount || 0), 0);
            
            // Group by category
            const categoryTotals = {};
            expenseData.forEach(item => {
                if (!categoryTotals[item.category]) {
                    categoryTotals[item.category] = 0;
                }
                categoryTotals[item.category] += item.amount;
            });
            
            // Group by manager
            const managerTotals = {};
            expenseData.forEach(item => {
                if (!managerTotals[item.manager]) {
                    managerTotals[item.manager] = 0;
                }
                managerTotals[item.manager] += item.amount;
            });
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-bill-wave"></i> Total Expenses</div>
                    <div class="stat-value" style="color:#f44336;">Rs ${formatNumber(totalExpense)}</div>
                    <div class="stat-change">All categories combined</div>
                </div>
            `;
            
            // Add top category
            const topCategory = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1])[0];
            if (topCategory) {
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-chart-pie"></i> Top Category</div>
                        <div class="stat-value">${topCategory[0]}</div>
                        <div class="stat-change">Rs ${formatNumber(topCategory[1])}</div>
                    </div>
                `;
            }
            
            // Add top manager
            const topManager = Object.entries(managerTotals).sort((a, b) => b[1] - a[1])[0];
            if (topManager) {
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-title"><i class="fas fa-user-tie"></i> Top Spender</div>
                        <div class="stat-value">${topManager[0]}</div>
                        <div class="stat-change">Managed Rs ${formatNumber(topManager[1])}</div>
                    </div>
                `;
            }
            
            // Add payment method summary
            const cashExpenses = expenseData.filter(item => item.method === 'Cash').reduce((sum, item) => sum + item.amount, 0);
            statsHTML += `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-money-bill"></i> Cash Expenses</div>
                    <div class="stat-value">Rs ${formatNumber(cashExpenses)}</div>
                    <div class="stat-change">${((cashExpenses/totalExpense)*100).toFixed(1)}% of total</div>
                </div>
            `;
            
            statsContainer.innerHTML = statsHTML;
        }

        function filterExpenseData(searchTerm = '') {
            const tbody = document.getElementById('expenseTableBody');
            const rows = tbody.getElementsByTagName('tr');
            
            for (let row of rows) {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
            }
        }

        function downloadExpenseTemplate() {
            const template = [
                ['Date', 'Category', 'Type', 'Managed By', 'Amount (Rs)', 'Payment Method', 'Description']
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Expense Template');
            
            XLSX.writeFile(wb, 'Expense_Template.xlsx');
            showNotification('Expense template downloaded!', 'success');
        }

        function uploadExpenseExcel(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                let importedCount = 0;
                jsonData.forEach(row => {
                    if (row.Date && row.Category && row.Type && row['Managed By'] && row['Amount (Rs)']) {
                        const entry = {
                            id: Date.now() + Math.random(),
                            date: formatExcelDate(row.Date),
                            category: row.Category,
                            type: row.Type,
                            manager: row['Managed By'],
                            amount: parseFloat(row['Amount (Rs)']) || 0,
                            method: row['Payment Method'] || 'Cash',
                            description: row.Description || '',
                            timestamp: new Date().toISOString()
                        };
                        
                        expenseData.push(entry);
                        importedCount++;
                    }
                });
                
                localStorage.setItem('expenseData', JSON.stringify(expenseData));
                loadExpenseData();
                showNotification(`Imported ${importedCount} expense entries successfully!`, 'success');
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        // ========== INCOME MANAGEMENT ==========
        function loadIncomeData() {
            const tbody = document.getElementById('incomeTableBody');
            tbody.innerHTML = '';
            
            // Combine all income data
            let allIncomeData = [];
            
            // Add livestock income
            livestockData.forEach(item => {
                if (item.income > 0) {
                    allIncomeData.push({
                        date: item.date,
                        source: 'Livestock',
                        category: item.category,
                        amount: item.income,
                        description: item.description,
                        receivedBy: item.manager,
                        type: 'Livestock Sale'
                    });
                }
            });
            
            // Add crop income
            cropData.forEach(item => {
                if (item.income > 0) {
                    allIncomeData.push({
                        date: item.date,
                        source: 'Crop',
                        category: item.type,
                        amount: item.income,
                        description: item.description,
                        receivedBy: item.manager,
                        type: 'Crop Sale'
                    });
                }
            });
            
            // Add water supply income
            waterData.forEach(item => {
                if (item.paid > 0) {
                    allIncomeData.push({
                        date: item.date,
                        source: 'Water Supply',
                        category: item.farmer,
                        amount: item.paid,
                        description: item.description,
                        receivedBy: 'System',
                        type: 'Water Bill Payment'
                    });
                }
            });
            
            if (allIncomeData.length === 0) {
                document.getElementById('incomeNoData').style.display = 'block';
                updateIncomeStats();
                return;
            }
            
            document.getElementById('incomeNoData').style.display = 'none';
            
            // Sort by date
            allIncomeData.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            // Filter if needed
            const fromDate = document.getElementById('incomeFromDate').value;
            const toDate = document.getElementById('incomeToDate').value;
            const categoryFilter = document.getElementById('incomeCategoryFilter').value;
            
            let filteredData = allIncomeData;
            
            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }
            
            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }
            
            if (categoryFilter) {
                filteredData = filteredData.filter(item => item.source === categoryFilter);
            }
            
            filteredData.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td><span class="badge" style="background:#2196F3;color:white;padding:4px 8px;border-radius:4px;">${entry.source}</span></td>
                    <td>${entry.category}</td>
                    <td style="color:#4CAF50;font-weight:bold;">Rs ${formatNumber(entry.amount)}</td>
                    <td>${entry.description || entry.type}</td>
                    <td>${entry.receivedBy}</td>
                `;
                tbody.appendChild(row);
            });
            
            updateIncomeStats(filteredData);
        }

        function updateIncomeStats(data = null) {
            const statsContainer = document.getElementById('incomeStats');
            if (!statsContainer) return;
            
            // If no data provided, get all income
            if (!data) {
                let allIncomeData = [];
                livestockData.forEach(item => item.income > 0 && allIncomeData.push({source: 'Livestock', amount: item.income}));
                cropData.forEach(item => item.income > 0 && allIncomeData.push({source: 'Crop', amount: item.income}));
                waterData.forEach(item => item.paid > 0 && allIncomeData.push({source: 'Water', amount: item.paid}));
                data = allIncomeData;
            }
            
            const totalIncome = data.reduce((sum, item) => sum + (item.amount || 0), 0);
            
            // Group by source
            const sourceTotals = {};
            data.forEach(item => {
                if (!sourceTotals[item.source]) {
                    sourceTotals[item.source] = 0;
                }
                sourceTotals[item.source] += item.amount;
            });
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-title"><i class="fas fa-chart-line"></i> Total Income</div>
                    <div class="stat-value" style="color:#4CAF50;">Rs ${formatNumber(totalIncome)}</div>
                    <div class="stat-change positive">All sources combined</div>
                </div>
            `;
            
            // Add source breakdown
            Object.entries(sourceTotals).forEach(([source, amount], index) => {
                if (index < 3) { // Show top 3 sources
                    const percentage = ((amount / totalIncome) * 100).toFixed(1);
                    let icon = 'fa-money-bill-wave';
                    let color = '#4CAF50';
                    
                    if (source === 'Livestock') {
                        icon = 'fa-cow';
                        color = '#2e7d32';
                    } else if (source === 'Crop') {
                        icon = 'fa-seedling';
                        color = '#8bc34a';
                    } else if (source === 'Water Supply' || source === 'Water') {
                        icon = 'fa-tint';
                        color = '#2196F3';
                    }
                    
                    statsHTML += `
                        <div class="stat-card">
                            <div class="stat-title"><i class="fas ${icon}" style="color:${color};"></i> ${source}</div>
                            <div class="stat-value">Rs ${formatNumber(amount)}</div>
                            <div class="stat-change">${percentage}% of total</div>
                        </div>
                    `;
                }
            });
            
            statsContainer.innerHTML = statsHTML;
        }

        function filterIncomeData() {
            loadIncomeData();
        }

        function resetIncomeFilter() {
            document.getElementById('incomeFromDate').value = '';
            document.getElementById('incomeToDate').value = '';
            document.getElementById('incomeCategoryFilter').value = '';
            loadIncomeData();
        }

        function generateIncomePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(46, 125, 50);
            doc.text('Income Report - AgriFarm Management', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Stats
            let allIncomeData = [];
            livestockData.forEach(item => item.income > 0 && allIncomeData.push({source: 'Livestock', amount: item.income}));
            cropData.forEach(item => item.income > 0 && allIncomeData.push({source: 'Crop', amount: item.income}));
            waterData.forEach(item => item.paid > 0 && allIncomeData.push({source: 'Water Supply', amount: item.paid}));
            
            const totalIncome = allIncomeData.reduce((sum, item) => sum + (item.amount || 0), 0);
            
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Income: Rs ${formatNumber(totalIncome)}`, 20, 50);
            
            // Table data
            const tableData = allIncomeData.map(item => [
                formatDate(item.date),
                item.source,
                `Rs ${formatNumber(item.amount)}`
            ]);
            
            // Add table
            doc.autoTable({
                startY: 60,
                head: [['Date', 'Source', 'Amount (Rs)']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [46, 125, 50] },
                margin: { top: 60 }
            });
            
            // Save PDF
            doc.save(`Income_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Income PDF report generated successfully!', 'success');
        }

        function downloadIncomeExcel() {
            let allIncomeData = [];
            livestockData.forEach(item => item.income > 0 && allIncomeData.push({
                Date: item.date,
                Source: 'Livestock',
                Category: item.category,
                Amount: item.income,
                Description: item.description,
                'Received By': item.manager
            }));
            cropData.forEach(item => item.income > 0 && allIncomeData.push({
                Date: item.date,
                Source: 'Crop',
                Category: item.type,
                Amount: item.income,
                Description: item.description,
                'Received By': item.manager
            }));
            waterData.forEach(item => item.paid > 0 && allIncomeData.push({
                Date: item.date,
                Source: 'Water Supply',
                Category: item.farmer,
                Amount: item.paid,
                Description: item.description,
                'Received By': 'System'
            }));
            
            const ws = XLSX.utils.json_to_sheet(allIncomeData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Income Report');
            
            XLSX.writeFile(wb, `Income_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
            showNotification('Income Excel report exported successfully!', 'success');
        }

        // ========== REPORTS MANAGEMENT ==========
        function updateReportStats() {
            // Livestock
            const livestockIncome = livestockData.reduce((sum, item) => sum + (item.income || 0), 0);
            const livestockExpense = livestockData.reduce((sum, item) => sum + (item.expense || 0), 0);
            document.getElementById('reportLivestockIncome').textContent = `Rs ${formatNumber(livestockIncome)}`;
            
            // Crop
            const cropIncome = cropData.reduce((sum, item) => sum + (item.income || 0), 0);
            const cropExpense = cropData.reduce((sum, item) => sum + (item.expense || 0), 0);
            document.getElementById('reportCropIncome').textContent = `Rs ${formatNumber(cropIncome)}`;
            
            // Water
            const waterIncome = waterData.reduce((sum, item) => sum + (item.paid || 0), 0);
            document.getElementById('reportWaterIncome').textContent = `Rs ${formatNumber(waterIncome)}`;
            
            // Expenses
            const totalExpenses = expenseData.reduce((sum, item) => sum + (item.amount || 0), 0) + 
                                 livestockExpense + cropExpense;
            document.getElementById('reportTotalExpenses').textContent = `Rs ${formatNumber(totalExpenses)}`;
        }

        function updateReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const categoryFilter = document.getElementById('categoryFilterGroup');
            
            if (reportType === 'category') {
                categoryFilter.style.display = 'block';
            } else {
                categoryFilter.style.display = 'none';
            }
        }

        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const category = document.getElementById('reportCategory').value;
            
            let reportData = [];
            let headers = [];
            
            switch(reportType) {
                case 'summary':
                    headers = ['Category', 'Total Income (Rs)', 'Total Expense (Rs)', 'Net Balance (Rs)', 'Entries'];
                    
                    // Livestock summary
                    const livestockEntries = livestockData.filter(item => 
                        (!fromDate || item.date >= fromDate) && 
                        (!toDate || item.date <= toDate)
                    );
                    const livestockIncome = livestockEntries.reduce((sum, item) => sum + (item.income || 0), 0);
                    const livestockExpense = livestockEntries.reduce((sum, item) => sum + (item.expense || 0), 0);
                    
                    reportData.push([
                        'Livestock',
                        livestockIncome,
                        livestockExpense,
                        livestockIncome - livestockExpense,
                        livestockEntries.length
                    ]);
                    
                    // Crop summary
                    const cropEntries = cropData.filter(item => 
                        (!fromDate || item.date >= fromDate) && 
                        (!toDate || item.date <= toDate)
                    );
                    const cropIncome = cropEntries.reduce((sum, item) => sum + (item.income || 0), 0);
                    const cropExpense = cropEntries.reduce((sum, item) => sum + (item.expense || 0), 0);
                    
                    reportData.push([
                        'Crop',
                        cropIncome,
                        cropExpense,
                        cropIncome - cropExpense,
                        cropEntries.length
                    ]);
                    
                    // Water summary
                    const waterEntries = waterData.filter(item => 
                        (!fromDate || item.date >= fromDate) && 
                        (!toDate || item.date <= toDate)
                    );
                    const waterIncome = waterEntries.reduce((sum, item) => sum + (item.paid || 0), 0);
                    const waterBilling = waterEntries.reduce((sum, item) => sum + (item.bill || 0), 0);
                    
                    reportData.push([
                        'Water Supply',
                        waterIncome,
                        0,
                        waterIncome,
                        waterEntries.length
                    ]);
                    
                    // Expense summary
                    const expenseEntries = expenseData.filter(item => 
                        (!fromDate || item.date >= fromDate) && 
                        (!toDate || item.date <= toDate)
                    );
                    const totalExpense = expenseEntries.reduce((sum, item) => sum + (item.amount || 0), 0);
                    
                    reportData.push([
                        'Other Expenses',
                        0,
                        totalExpense,
                        -totalExpense,
                        expenseEntries.length
                    ]);
                    
                    break;
                    
                case 'category':
                    headers = ['Date', 'Type', 'Details', 'Income (Rs)', 'Expense (Rs)', 'Balance (Rs)', 'Managed By'];
                    
                    let categoryData = [];
                    if (!category || category === 'Livestock') {
                        livestockData.forEach(item => {
                            if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                                categoryData.push({
                                    date: item.date,
                                    type: 'Livestock',
                                    details: item.category,
                                    income: item.income || 0,
                                    expense: item.expense || 0,
                                    balance: (item.income || 0) - (item.expense || 0),
                                    manager: item.manager
                                });
                            }
                        });
                    }
                    
                    if (!category || category === 'Crop') {
                        cropData.forEach(item => {
                            if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                                categoryData.push({
                                    date: item.date,
                                    type: 'Crop',
                                    details: item.type,
                                    income: item.income || 0,
                                    expense: item.expense || 0,
                                    balance: (item.income || 0) - (item.expense || 0),
                                    manager: item.manager
                                });
                            }
                        });
                    }
                    
                    if (!category || category === 'Water') {
                        waterData.forEach(item => {
                            if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                                categoryData.push({
                                    date: item.date,
                                    type: 'Water Supply',
                                    details: item.farmer,
                                    income: item.paid || 0,
                                    expense: 0,
                                    balance: item.paid || 0,
                                    manager: 'System'
                                });
                            }
                        });
                    }
                    
                    categoryData.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    reportData = categoryData.map(item => [
                        formatDate(item.date),
                        item.type,
                        item.details,
                        item.income,
                        item.expense,
                        item.balance,
                        item.manager
                    ]);
                    break;
                    
                case 'ledger':
                    headers = ['Date', 'Description', 'Debit (Rs)', 'Credit (Rs)', 'Balance (Rs)', 'Category'];
                    
                    // Combine all transactions
                    let ledgerData = [];
                    
                    // Add livestock expenses (debit) and income (credit)
                    livestockData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (item.expense > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Livestock - ${item.category}: ${item.description || 'Expense'}`,
                                    debit: item.expense,
                                    credit: 0,
                                    category: 'Livestock'
                                });
                            }
                            if (item.income > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Livestock - ${item.category}: Income`,
                                    debit: 0,
                                    credit: item.income,
                                    category: 'Livestock'
                                });
                            }
                        }
                    });
                    
                    // Add crop transactions
                    cropData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (item.expense > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Crop - ${item.type}: ${item.description || 'Expense'}`,
                                    debit: item.expense,
                                    credit: 0,
                                    category: 'Crop'
                                });
                            }
                            if (item.income > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Crop - ${item.type}: Income`,
                                    debit: 0,
                                    credit: item.income,
                                    category: 'Crop'
                                });
                            }
                        }
                    });
                    
                    // Add water transactions
                    waterData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (item.bill > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Water Supply - ${item.farmer}: Billing`,
                                    debit: 0,
                                    credit: item.bill,
                                    category: 'Water'
                                });
                            }
                            if (item.paid > 0) {
                                ledgerData.push({
                                    date: item.date,
                                    description: `Water Supply - ${item.farmer}: Payment Received`,
                                    debit: item.paid,
                                    credit: 0,
                                    category: 'Water'
                                });
                            }
                        }
                    });
                    
                    // Add other expenses
                    expenseData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            ledgerData.push({
                                date: item.date,
                                description: `${item.category} - ${item.type}: ${item.description || 'Expense'}`,
                                debit: item.amount,
                                credit: 0,
                                category: item.category
                            });
                        }
                    });
                    
                    // Sort by date
                    ledgerData.sort((a, b) => new Date(a.date) - new Date(b.date));
                    
                    // Calculate running balance
                    let balance = 0;
                    reportData = ledgerData.map(item => {
                        balance += item.credit - item.debit;
                        return [
                            formatDate(item.date),
                            item.description,
                            item.debit > 0 ? item.debit : '',
                            item.credit > 0 ? item.credit : '',
                            balance,
                            item.category
                        ];
                    });
                    break;
                    
                case 'manager':
                    headers = ['Manager', 'Total Expenses (Rs)', 'Total Income Managed (Rs)', 'Net (Rs)', 'Entries'];
                    
                    const managerStats = {};
                    
                    // Process livestock
                    livestockData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (!managerStats[item.manager]) {
                                managerStats[item.manager] = {
                                    expenses: 0,
                                    income: 0,
                                    count: 0
                                };
                            }
                            managerStats[item.manager].expenses += item.expense || 0;
                            managerStats[item.manager].income += item.income || 0;
                            managerStats[item.manager].count++;
                        }
                    });
                    
                    // Process crop
                    cropData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (!managerStats[item.manager]) {
                                managerStats[item.manager] = {
                                    expenses: 0,
                                    income: 0,
                                    count: 0
                                };
                            }
                            managerStats[item.manager].expenses += item.expense || 0;
                            managerStats[item.manager].income += item.income || 0;
                            managerStats[item.manager].count++;
                        }
                    });
                    
                    // Process expenses
                    expenseData.forEach(item => {
                        if ((!fromDate || item.date >= fromDate) && (!toDate || item.date <= toDate)) {
                            if (!managerStats[item.manager]) {
                                managerStats[item.manager] = {
                                    expenses: 0,
                                    income: 0,
                                    count: 0
                                };
                            }
                            managerStats[item.manager].expenses += item.amount || 0;
                            managerStats[item.manager].count++;
                        }
                    });
                    
                    // Convert to array
                    reportData = Object.entries(managerStats).map(([manager, stats]) => [
                        manager,
                        stats.expenses,
                        stats.income,
                        stats.income - stats.expenses,
                        stats.count
                    ]);
                    break;
            }
            
            // Display report
            const thead = document.querySelector('#reportTable thead');
            const tbody = document.getElementById('reportTableBody');
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            if (reportData.length === 0) {
                document.getElementById('reportNoData').style.display = 'block';
                return;
            }
            
            document.getElementById('reportNoData').style.display = 'none';
            
            // Create header
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Create rows
            reportData.forEach(rowData => {
                const row = document.createElement('tr');
                rowData.forEach((cellData, index) => {
                    const td = document.createElement('td');
                    
                    // Format numbers
                    if (typeof cellData === 'number') {
                        if (headers[index].includes('(Rs)')) {
                            td.textContent = `Rs ${formatNumber(cellData)}`;
                            if (headers[index].includes('Expense') || headers[index].includes('Debit')) {
                                td.style.color = '#f44336';
                                td.style.fontWeight = 'bold';
                            } else if (headers[index].includes('Income') || headers[index].includes('Credit')) {
                                td.style.color = '#4CAF50';
                                td.style.fontWeight = 'bold';
                            } else if (headers[index].includes('Balance') || headers[index].includes('Net')) {
                                td.style.color = cellData >= 0 ? '#4CAF50' : '#f44336';
                                td.style.fontWeight = 'bold';
                            }
                        } else {
                            td.textContent = cellData;
                        }
                    } else {
                        td.textContent = cellData;
                    }
                    
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            });
            
            showNotification(`${reportType.charAt(0).toUpperCase() + reportType.slice(1)} report generated successfully!`, 'success');
        }

        function exportReportExcel() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value || 'all';
            const toDate = document.getElementById('reportToDate').value || 'all';
            
            // Get current report data from table
            const headers = [];
            const headerCells = document.querySelectorAll('#reportTable thead th');
            headerCells.forEach(th => headers.push(th.textContent));
            
            const data = [];
            const rows = document.querySelectorAll('#reportTable tbody tr');
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(td => {
                    // Extract numeric value from formatted text
                    let text = td.textContent;
                    if (text.includes('Rs ')) {
                        text = text.replace('Rs ', '').replace(/,/g, '');
                    }
                    rowData.push(text);
                });
                data.push(rowData);
            });
            
            if (data.length === 0) {
                showNotification('No data to export! Generate a report first.', 'error');
                return;
            }
            
            // Create worksheet
            const wsData = [headers, ...data];
            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Report');
            
            // Save file
            XLSX.writeFile(wb, `${reportType}_Report_${fromDate}_to_${toDate}.xlsx`);
            showNotification('Report exported to Excel successfully!', 'success');
        }

        function generateSummaryReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(46, 125, 50);
            doc.text('AgriFarm Management - Summary Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            const dateRange = document.getElementById('reportFromDate').value && document.getElementById('reportToDate').value 
                ? `${document.getElementById('reportFromDate').value} to ${document.getElementById('reportToDate').value}`
                : 'All Time';
            doc.text(`Period: ${dateRange} | Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Summary Stats
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Financial Summary', 20, 45);
            
            // Calculate totals
            const livestockIncome = livestockData.reduce((sum, item) => sum + (item.income || 0), 0);
            const livestockExpense = livestockData.reduce((sum, item) => sum + (item.expense || 0), 0);
            const cropIncome = cropData.reduce((sum, item) => sum + (item.income || 0), 0);
            const cropExpense = cropData.reduce((sum, item) => sum + (item.expense || 0), 0);
            const waterIncome = waterData.reduce((sum, item) => sum + (item.paid || 0), 0);
            const otherExpense = expenseData.reduce((sum, item) => sum + (item.amount || 0), 0);
            
            const totalIncome = livestockIncome + cropIncome + waterIncome;
            const totalExpense = livestockExpense + cropExpense + otherExpense;
            const netProfit = totalIncome - totalExpense;
            
            // Stats table
            doc.autoTable({
                startY: 55,
                head: [['Category', 'Income (Rs)', 'Expense (Rs)', 'Balance (Rs)']],
                body: [
                    ['Livestock', livestockIncome, livestockExpense, livestockIncome - livestockExpense],
                    ['Crop', cropIncome, cropExpense, cropIncome - cropExpense],
                    ['Water Supply', waterIncome, 0, waterIncome],
                    ['Other Expenses', 0, otherExpense, -otherExpense],
                    ['TOTAL', totalIncome, totalExpense, netProfit]
                ],
                theme: 'grid',
                headStyles: { fillColor: [46, 125, 50] },
                bodyStyles: { fontSize: 10 },
                columnStyles: {
                    1: { halign: 'right', fontStyle: 'bold' },
                    2: { halign: 'right', fontStyle: 'bold' },
                    3: { halign: 'right', fontStyle: 'bold' }
                },
                didDrawCell: function(data) {
                    if (data.section === 'body' && data.row.index === 4) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.fillColor = [240, 240, 240];
                    }
                    if (data.section === 'body' && data.column.index === 3) {
                        const value = data.cell.raw;
                        if (value < 0) {
                            data.cell.styles.textColor = [244, 67, 54];
                        } else if (value > 0) {
                            data.cell.styles.textColor = [76, 175, 80];
                        }
                    }
                }
            });
            
            // Save PDF
            doc.save(`AgriFarm_Summary_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Summary PDF report generated successfully!', 'success');
        }

        function generateLedgerReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(20);
            doc.setTextColor(46, 125, 50);
            doc.text('AgriFarm Management - Ledger Report', 105, 20, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Create ledger data
            let ledgerData = [];
            
            // Add all transactions
            livestockData.forEach(item => {
                if (item.expense > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Livestock - ${item.category}`,
                        debit: item.expense,
                        credit: 0,
                        category: 'Livestock'
                    });
                }
                if (item.income > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Livestock Income - ${item.category}`,
                        debit: 0,
                        credit: item.income,
                        category: 'Livestock'
                    });
                }
            });
            
            cropData.forEach(item => {
                if (item.expense > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Crop - ${item.type}`,
                        debit: item.expense,
                        credit: 0,
                        category: 'Crop'
                    });
                }
                if (item.income > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Crop Income - ${item.type}`,
                        debit: 0,
                        credit: item.income,
                        category: 'Crop'
                    });
                }
            });
            
            waterData.forEach(item => {
                if (item.bill > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Water Supply - ${item.farmer}`,
                        debit: 0,
                        credit: item.bill,
                        category: 'Water'
                    });
                }
                if (item.paid > 0) {
                    ledgerData.push({
                        date: item.date,
                        description: `Payment Received - ${item.farmer}`,
                        debit: item.paid,
                        credit: 0,
                        category: 'Water'
                    });
                }
            });
            
            expenseData.forEach(item => {
                ledgerData.push({
                    date: item.date,
                    description: `${item.category} - ${item.type}`,
                    debit: item.amount,
                    credit: 0,
                    category: item.category
                });
            });
            
            // Sort by date
            ledgerData.sort((a, b) => new Date(a.date) - new Date(b.date));
            
            // Calculate running balance
            let balance = 0;
            const tableData = ledgerData.map(item => {
                balance += item.credit - item.debit;
                return [
                    formatDate(item.date),
                    item.description,
                    item.debit > 0 ? `Rs ${formatNumber(item.debit)}` : '',
                    item.credit > 0 ? `Rs ${formatNumber(item.credit)}` : '',
                    `Rs ${formatNumber(balance)}`,
                    item.category
                ];
            });
            
            // Add table
            doc.autoTable({
                startY: 40,
                head: [['Date', 'Description', 'Debit (Rs)', 'Credit (Rs)', 'Balance (Rs)', 'Category']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [46, 125, 50] },
                columnStyles: {
                    0: { cellWidth: 25 },
                    1: { cellWidth: 60 },
                    2: { cellWidth: 25, halign: 'right' },
                    3: { cellWidth: 25, halign: 'right' },
                    4: { cellWidth: 30, halign: 'right' },
                    5: { cellWidth: 25 }
                },
                styles: { fontSize: 8 },
                margin: { top: 40 }
            });
            
            // Final balance
            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Final Balance: Rs ${formatNumber(balance)}`, 20, finalY);
            
            if (balance >= 0) {
                doc.setTextColor(76, 175, 80);
                doc.text('(Profit)', 80, finalY);
            } else {
                doc.setTextColor(244, 67, 54);
                doc.text('(Loss)', 80, finalY);
            }
            
            // Save PDF
            doc.save(`Ledger_Report_${new Date().toISOString().split('T')[0]}.pdf`);
            showNotification('Ledger PDF report generated successfully!', 'success');
        }

        // ========== UTILITY FUNCTIONS ==========
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB'); // DD/MM/YYYY format
        }

        function formatExcelDate(excelDate) {
            if (!excelDate) return new Date().toISOString().split('T')[0];
            
            // Handle Excel serial date numbers
            if (typeof excelDate === 'number') {
                const date = new Date((excelDate - (25567 + 2)) * 86400 * 1000);
                return date.toISOString().split('T')[0];
            }
            
            // Handle string dates
            if (typeof excelDate === 'string') {
                // Try to parse various date formats
                const parsed = new Date(excelDate);
                if (!isNaN(parsed.getTime())) {
                    return parsed.toISOString().split('T')[0];
                }
                
                // Try DD/MM/YYYY format
                const parts = excelDate.split('/');
                if (parts.length === 3) {
                    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
                }
            }
            
            return new Date().toISOString().split('T')[0];
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return '0';
            return parseFloat(num).toLocaleString('en-IN', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function closePDFModal() {
            document.getElementById('pdfModal').classList.remove('active');
        }

        // Initialize report filters
        updateReportFilters();
    </script>
</body>
</html>
