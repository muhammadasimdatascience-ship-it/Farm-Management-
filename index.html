<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Management System</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.28/dist/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary-color: #2E8B57;
            --secondary-color: #FFD700;
            --accent-color: #4169E1;
        }
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), #3CB371);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .sidebar {
            background: white;
            min-height: calc(100vh - 56px);
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar .nav-link {
            color: #333;
            padding: 12px 20px;
            border-left: 4px solid transparent;
            transition: all 0.3s;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            background-color: #e8f5e8;
            border-left-color: var(--primary-color);
            color: var(--primary-color);
        }
        .card {
            border: none;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        .btn-primary:hover {
            background-color: #26734d;
            border-color: #26734d;
        }
        .tab-content {
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
        }
        .form-control:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(46, 139, 87, 0.25);
        }
        .modal-header {
            background-color: var(--primary-color);
            color: white;
        }
        .export-btn {
            background-color: var(--accent-color);
            color: white;
            border: none;
        }
        .export-btn:hover {
            background-color: #3154b8;
        }
        .dashboard-icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        .date-range {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .currency-cell {
            font-family: 'Courier New', monospace;
            font-weight: bold;
        }
        .income-cell {
            color: #28a745;
        }
        .expense-cell {
            color: #dc3545;
        }
        .backup-section {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            border: 2px dashed #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-tractor me-2"></i>
                Farm Management System
            </a>
            <div class="d-flex align-items-center">
                <span class="text-white me-3" id="currentDate"></span>
                <button class="btn btn-outline-light" onclick="exportAllData()">
                    <i class="fas fa-download me-1"></i> Backup
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-2 col-md-3 sidebar">
                <nav class="nav flex-column pt-3">
                    <a class="nav-link active" href="#dashboard" onclick="showTab('dashboard')">
                        <i class="fas fa-home me-2"></i> Dashboard
                    </a>
                    <a class="nav-link" href="#livestock" onclick="showTab('livestock')">
                        <i class="fas fa-cow me-2"></i> Livestock
                    </a>
                    <a class="nav-link" href="#crops" onclick="showTab('crops')">
                        <i class="fas fa-seedling me-2"></i> Crops
                    </a>
                    <a class="nav-link" href="#water" onclick="showTab('water')">
                        <i class="fas fa-tint me-2"></i> Water Supply
                    </a>
                    <a class="nav-link" href="#expenses" onclick="showTab('expenses')">
                        <i class="fas fa-money-bill-wave me-2"></i> Expenses
                    </a>
                    <a class="nav-link" href="#income" onclick="showTab('income')">
                        <i class="fas fa-chart-line me-2"></i> Income
                    </a>
                    <a class="nav-link" href="#reports" onclick="showTab('reports')">
                        <i class="fas fa-file-alt me-2"></i> Reports
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="col-lg-10 col-md-9">
                <!-- Dashboard -->
                <div id="dashboard" class="tab-content">
                    <h2 class="mb-4"><i class="fas fa-home text-primary me-2"></i>Dashboard</h2>
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card text-center">
                                <div class="card-body">
                                    <i class="fas fa-cow dashboard-icon"></i>
                                    <h5>Total Livestock</h5>
                                    <h3 id="totalLivestock">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card text-center">
                                <div class="card-body">
                                    <i class="fas fa-seedling dashboard-icon"></i>
                                    <h5>Crop Areas</h5>
                                    <h3 id="totalCrops">0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card text-center">
                                <div class="card-body">
                                    <i class="fas fa-money-bill-wave dashboard-icon"></i>
                                    <h5>Total Income</h5>
                                    <h3 id="totalIncome">₹0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card text-center">
                                <div class="card-body">
                                    <i class="fas fa-coins dashboard-icon"></i>
                                    <h5>Total Expenses</h5>
                                    <h3 id="totalExpenses">₹0</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Recent Transactions</h5>
                                </div>
                                <div class="card-body">
                                    <div id="recentTransactions"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Data Management</h5>
                                </div>
                                <div class="card-body">
                                    <div class="backup-section">
                                        <h6><i class="fas fa-database me-2"></i>Backup & Restore</h6>
                                        <p class="text-muted small mb-2">All data is saved in your browser's local storage</p>
                                        <button class="btn btn-primary mb-2 w-100" onclick="exportAllData()">
                                            <i class="fas fa-download me-2"></i>Export All Data
                                        </button>
                                        <button class="btn btn-success mb-2 w-100" onclick="document.getElementById('importFile').click()">
                                            <i class="fas fa-upload me-2"></i>Import Data
                                        </button>
                                        <input type="file" id="importFile" style="display:none" accept=".json" onchange="importData(event)">
                                        <button class="btn btn-danger w-100" onclick="clearAllData()">
                                            <i class="fas fa-trash me-2"></i>Clear All Data
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 01: Livestock -->
                <div id="livestock" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-cow text-primary me-2"></i>Livestock Management</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Add Livestock Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="livestockForm">
                                        <div class="mb-3">
                                            <label class="form-label">Category</label>
                                            <select class="form-select" id="livestockCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="Cow">Cow</option>
                                                <option value="Beef">Beef</option>
                                                <option value="Goat">Goat</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Animal Name/ID</label>
                                            <input type="text" class="form-control" id="animalName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expense Type</label>
                                            <select class="form-select" id="expenseType">
                                                <option value="">Select Expense Type</option>
                                                <option value="Khal">Khal</option>
                                                <option value="Chokar">Chokar</option>
                                                <option value="Tori">Tori</option>
                                                <option value="Ghaas">Ghaas (Grass/Fodder)</option>
                                                <option value="Medical">Medical</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Amount (₹)</label>
                                            <input type="number" class="form-control" id="expenseAmount" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Income (₹)</label>
                                            <input type="number" class="form-control" id="incomeAmount" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="entryDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="description" rows="2"></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Livestock Records</h5>
                                    <div>
                                        <button class="btn btn-sm export-btn me-2" onclick="downloadExcelTemplate('livestock')">
                                            <i class="fas fa-download me-1"></i>Excel Template
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('excelUpload').click()">
                                            <i class="fas fa-upload me-1"></i>Upload Excel
                                        </button>
                                        <input type="file" id="excelUpload" style="display:none" accept=".xlsx,.xls" onchange="uploadExcel('livestock')">
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="date-range mb-3">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="livestockFromDate">
                                            </div>
                                            <div class="col-md-5">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="livestockToDate">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="filterLivestockRecords()">
                                                    <i class="fas fa-filter"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Category</th>
                                                    <th>Name/ID</th>
                                                    <th>Expense Type</th>
                                                    <th>Expense (₹)</th>
                                                    <th>Income (₹)</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="livestockTable">
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="generateLivestockPDF()">
                                            <i class="fas fa-file-pdf me-2"></i>Generate PDF Report
                                        </button>
                                        <button class="btn btn-success ms-2" onclick="exportToExcel('livestock')">
                                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 02: Crops -->
                <div id="crops" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-seedling text-primary me-2"></i>Crop Management</h2>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Add Crop Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="cropForm">
                                        <div class="mb-3">
                                            <label class="form-label">Crop Name</label>
                                            <input type="text" class="form-control" id="cropName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expense Type</label>
                                            <select class="form-select" id="cropExpenseType" required>
                                                <option value="">Select Type</option>
                                                <option value="Labor">Labor</option>
                                                <option value="Seeds">Seeds (Beej)</option>
                                                <option value="Fertilizer">Fertilizer (Khaad)</option>
                                                <option value="Spray">Spray</option>
                                                <option value="Irrigation">Irrigation</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Expense Amount (₹)</label>
                                            <input type="number" class="form-control" id="cropExpenseAmount" step="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Income (₹)</label>
                                            <input type="number" class="form-control" id="cropIncome" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Area (Acres)</label>
                                            <input type="number" class="form-control" id="cropArea" step="0.01">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="cropDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By</label>
                                            <input type="text" class="form-control" id="cropManagedBy">
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Crop Records</h5>
                                    <div>
                                        <button class="btn btn-sm export-btn me-2" onclick="downloadExcelTemplate('crops')">
                                            <i class="fas fa-download me-1"></i>Excel Template
                                        </button>
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('cropExcelUpload').click()">
                                            <i class="fas fa-upload me-1"></i>Upload Excel
                                        </button>
                                        <input type="file" id="cropExcelUpload" style="display:none" accept=".xlsx,.xls" onchange="uploadExcel('crops')">
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="date-range mb-3">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <label class="form-label">From Date</label>
                                                <input type="date" class="form-control" id="cropFromDate">
                                            </div>
                                            <div class="col-md-5">
                                                <label class="form-label">To Date</label>
                                                <input type="date" class="form-control" id="cropToDate">
                                            </div>
                                            <div class="col-md-2 d-flex align-items-end">
                                                <button class="btn btn-primary w-100" onclick="filterCropRecords()">
                                                    <i class="fas fa-filter"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Crop</th>
                                                    <th>Expense Type</th>
                                                    <th>Expense (₹)</th>
                                                    <th>Income (₹)</th>
                                                    <th>Area</th>
                                                    <th>Managed By</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="cropTable">
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="generateCropPDF()">
                                            <i class="fas fa-file-pdf me-2"></i>Generate PDF Report
                                        </button>
                                        <button class="btn btn-success ms-2" onclick="exportToExcel('crops')">
                                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 03: Water Supply -->
                <div id="water" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-tint text-primary me-2"></i>Water Supply Management</h2>
                    
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Water Billing Entry</h5>
                                </div>
                                <div class="card-body">
                                    <form id="waterForm">
                                        <div class="mb-3">
                                            <label class="form-label">Farmer Name</label>
                                            <input type="text" class="form-control" id="farmerName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Start Time</label>
                                            <input type="datetime-local" class="form-control" id="startTime" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">End Time</label>
                                            <input type="datetime-local" class="form-control" id="endTime" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Rate (₹ per hour)</label>
                                            <input type="number" class="form-control" id="waterRate" value="100" step="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Payment Received (₹)</label>
                                            <input type="number" class="form-control" id="paymentReceived" step="1">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="waterDate" required>
                                        </div>
                                        <div class="alert alert-info">
                                            <strong>Calculated Bill:</strong>
                                            <div id="calculatedBill">₹0</div>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Entry
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Farmer Ledgers</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Farmer</th>
                                                    <th>Total Bill (₹)</th>
                                                    <th>Paid (₹)</th>
                                                    <th>Balance (₹)</th>
                                                    <th>Last Payment</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="waterTable">
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-primary" onclick="showAllLedgers()">
                                            <i class="fas fa-book me-2"></i>View All Ledgers
                                        </button>
                                        <button class="btn btn-success ms-2" onclick="exportWaterReport()">
                                            <i class="fas fa-file-excel me-2"></i>Export Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 04: Expenses -->
                <div id="expenses" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-money-bill-wave text-primary me-2"></i>Expense Management</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>Total Expenses</h5>
                                    <h3 id="totalExpensesAmount">₹0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>This Month</h5>
                                    <h3 id="monthlyExpenses">₹0</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>By Category</h5>
                                    <h3 id="categoryExpenses">-</h3>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>Managed Expenses</h5>
                                    <h3 id="managedExpenses">₹0</h3>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Add Expense</h5>
                                </div>
                                <div class="card-body">
                                    <form id="expenseForm">
                                        <div class="mb-3">
                                            <label class="form-label">Expense Category</label>
                                            <select class="form-select" id="expenseCategory" required>
                                                <option value="">Select Category</option>
                                                <option value="Salary">Salaries</option>
                                                <option value="Livestock">Livestock Expenses</option>
                                                <option value="Crop">Crop Expenses</option>
                                                <option value="Machinery">Machinery</option>
                                                <option value="Maintenance">Maintenance</option>
                                                <option value="Utilities">Utilities</option>
                                                <option value="Others">Others</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Amount (₹)</label>
                                            <input type="number" class="form-control" id="expenseAmountMain" step="1" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Managed By</label>
                                            <input type="text" class="form-control" id="expenseManagedBy" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Description</label>
                                            <textarea class="form-control" id="expenseDescription" rows="2" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">Date</label>
                                            <input type="date" class="form-control" id="expenseDate" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-save me-2"></i>Save Expense
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Expense Records</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Category</th>
                                                    <th>Amount (₹)</th>
                                                    <th>Managed By</th>
                                                    <th>Description</th>
                                                    <th>Actions</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expenseTable">
                                                <!-- Data will be populated here -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 05: Income -->
                <div id="income" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-chart-line text-primary me-2"></i>Income Consolidated</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Income Sources</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Source</th>
                                                <th>Amount (₹)</th>
                                                <th>Percentage</th>
                                            </tr>
                                        </thead>
                                        <tbody id="incomeSources">
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Monthly Income Trend</h5>
                                </div>
                                <div class="card-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Month</th>
                                                <th>Livestock</th>
                                                <th>Crops</th>
                                                <th>Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="monthlyIncome">
                                            <!-- Data will be populated here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab 06: Reports -->
                <div id="reports" class="tab-content" style="display: none;">
                    <h2 class="mb-4"><i class="fas fa-file-alt text-primary me-2"></i>Reports & Analytics</h2>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Generate Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                                    <h5>Monthly Summary</h5>
                                                    <p class="text-muted">Complete monthly report</p>
                                                    <button class="btn btn-danger" onclick="generateMonthlySummary()">
                                                        Generate PDF
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-chart-bar fa-3x text-primary mb-3"></i>
                                                    <h5>Financial Analysis</h5>
                                                    <p class="text-muted">Income vs Expenses</p>
                                                    <button class="btn btn-primary" onclick="generateFinancialAnalysis()">
                                                        Generate Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-user-tie fa-3x text-success mb-3"></i>
                                                    <h5>Managed Expenses</h5>
                                                    <p class="text-muted">By individual</p>
                                                    <button class="btn btn-success" onclick="generateManagedExpensesReport()">
                                                        Generate Report
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <div class="card h-100">
                                                <div class="card-body text-center">
                                                    <i class="fas fa-tint fa-3x text-info mb-3"></i>
                                                    <h5>Water Bills</h5>
                                                    <p class="text-muted">Water supply report</p>
                                                    <button class="btn btn-info" onclick="generateWaterReportPDF()">
                                                        Generate PDF
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Date Range Reports</h5>
                                </div>
                                <div class="card-body">
                                    <form id="reportForm">
                                        <div class="mb-3">
                                            <label class="form-label">Report Type</label>
                                            <select class="form-select" id="reportType">
                                                <option value="livestock">Livestock</option>
                                                <option value="crops">Crops</option>
                                                <option value="expenses">Expenses</option>
                                                <option value="income">Income</option>
                                                <option value="water">Water Supply</option>
                                            </select>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">From Date</label>
                                            <input type="date" class="form-control" id="reportFromDate" required>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">To Date</label>
                                            <input type="date" class="form-control" id="reportToDate" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">
                                            <i class="fas fa-chart-bar me-2"></i>Generate Report
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">Quick Reports</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-outline-primary" onclick="generateTodayReport()">
                                            Today's Report
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="generateWeeklyReport()">
                                            Weekly Report
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="generateMonthlyReport()">
                                            Monthly Report
                                        </button>
                                        <button class="btn btn-outline-primary" onclick="generateYearlyReport()">
                                            Yearly Report
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Record</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="editForm">
                        <input type="hidden" id="editId">
                        <input type="hidden" id="editCollection">
                        <!-- Dynamic form fields will be added here -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveEdit()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ledger Modal -->
    <div class="modal fade" id="ledgerModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Farmer Ledger</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <h6 id="ledgerFarmerName"></h6>
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Bill (₹)</th>
                                    <th>Paid (₹)</th>
                                    <th>Balance (₹)</th>
                                    <th>Type</th>
                                </tr>
                            </thead>
                            <tbody id="ledgerDetails">
                                <!-- Ledger details will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Currency formatting function - removes .00 for whole numbers
        function formatCurrency(amount) {
            if (amount === undefined || amount === null || amount === '') return '₹0';
            
            const num = parseFloat(amount);
            if (isNaN(num)) return '₹0';
            
            // Check if it's a whole number
            if (Number.isInteger(num)) {
                return '₹' + num.toLocaleString('en-IN');
            } else {
                return '₹' + num.toLocaleString('en-IN');
            }
        }

        // Format number for display (without ₹ symbol)
        function formatNumber(num) {
            if (num === undefined || num === null || num === '') return '0';
            
            const number = parseFloat(num);
            if (isNaN(number)) return '0';
            
            // Check if it's a whole number
            if (Number.isInteger(number)) {
                return number.toLocaleString('en-IN');
            } else {
                return number.toLocaleString('en-IN');
            }
        }

        // Data Storage Class
        class DataStorage {
            constructor() {
                this.storageKey = 'farm_management_data';
                this.loadData();
            }

            loadData() {
                const savedData = localStorage.getItem(this.storageKey);
                if (savedData) {
                    const data = JSON.parse(savedData);
                    this.livestock = data.livestock || [];
                    this.crops = data.crops || [];
                    this.water = data.water || [];
                    this.expenses = data.expenses || [];
                } else {
                    this.livestock = [];
                    this.crops = [];
                    this.water = [];
                    this.expenses = [];
                    this.saveAllData();
                }
            }

            saveAllData() {
                const data = {
                    livestock: this.livestock,
                    crops: this.crops,
                    water: this.water,
                    expenses: this.expenses,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem(this.storageKey, JSON.stringify(data));
            }

            // Livestock methods
            addLivestock(entry) {
                entry.id = Date.now().toString();
                this.livestock.push(entry);
                this.saveAllData();
                return entry.id;
            }

            updateLivestock(id, updates) {
                const index = this.livestock.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.livestock[index] = { ...this.livestock[index], ...updates };
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            deleteLivestock(id) {
                const index = this.livestock.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.livestock.splice(index, 1);
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            // Crop methods
            addCrop(entry) {
                entry.id = Date.now().toString();
                this.crops.push(entry);
                this.saveAllData();
                return entry.id;
            }

            updateCrop(id, updates) {
                const index = this.crops.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.crops[index] = { ...this.crops[index], ...updates };
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            deleteCrop(id) {
                const index = this.crops.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.crops.splice(index, 1);
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            // Water methods
            addWater(entry) {
                entry.id = Date.now().toString();
                this.water.push(entry);
                this.saveAllData();
                return entry.id;
            }

            updateWater(id, updates) {
                const index = this.water.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.water[index] = { ...this.water[index], ...updates };
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            deleteWater(id) {
                const index = this.water.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.water.splice(index, 1);
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            // Expense methods
            addExpense(entry) {
                entry.id = Date.now().toString();
                this.expenses.push(entry);
                this.saveAllData();
                return entry.id;
            }

            updateExpense(id, updates) {
                const index = this.expenses.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.expenses[index] = { ...this.expenses[index], ...updates };
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            deleteExpense(id) {
                const index = this.expenses.findIndex(item => item.id === id);
                if (index !== -1) {
                    this.expenses.splice(index, 1);
                    this.saveAllData();
                    return true;
                }
                return false;
            }

            // Export all data
            exportData() {
                return {
                    livestock: this.livestock,
                    crops: this.crops,
                    water: this.water,
                    expenses: this.expenses,
                    exportedAt: new Date().toISOString()
                };
            }

            // Import data
            importData(data) {
                this.livestock = data.livestock || [];
                this.crops = data.crops || [];
                this.water = data.water || [];
                this.expenses = data.expenses || [];
                this.saveAllData();
            }

            // Clear all data
            clearData() {
                this.livestock = [];
                this.crops = [];
                this.water = [];
                this.expenses = [];
                this.saveAllData();
            }
        }

        // Initialize data storage
        const dataStorage = new DataStorage();

        // Initialize Application
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
            updateCurrentDate();
            setInterval(updateCurrentDate, 60000);
        });

        function initializeApp() {
            loadAllData();
            initializeDates();
        }

        function updateCurrentDate() {
            const now = new Date();
            document.getElementById('currentDate').textContent = 
                now.toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
        }

        function showTab(tabName) {
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav links
            const navLinks = document.querySelectorAll('.sidebar .nav-link');
            navLinks.forEach(link => {
                link.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).style.display = 'block';
            
            // Add active class to clicked nav link
            event.target.classList.add('active');
            
            // Load specific tab data
            switch(tabName) {
                case 'livestock':
                    loadLivestockData();
                    break;
                case 'crops':
                    loadCropData();
                    break;
                case 'water':
                    loadWaterData();
                    break;
                case 'expenses':
                    loadExpenseData();
                    break;
                case 'income':
                    loadIncomeData();
                    break;
                case 'reports':
                    loadReportData();
                    break;
            }
        }

        // ========== LIVESTOCK MANAGEMENT ==========
        document.getElementById('livestockForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveLivestockEntry();
        });

        function saveLivestockEntry() {
            const entry = {
                category: document.getElementById('livestockCategory').value,
                animalName: document.getElementById('animalName').value,
                expenseType: document.getElementById('expenseType').value,
                expenseAmount: parseInt(document.getElementById('expenseAmount').value) || 0,
                incomeAmount: parseInt(document.getElementById('incomeAmount').value) || 0,
                date: document.getElementById('entryDate').value,
                description: document.getElementById('description').value,
                timestamp: new Date().toISOString()
            };

            dataStorage.addLivestock(entry);
            alert('Entry saved successfully!');
            document.getElementById('livestockForm').reset();
            loadLivestockData();
            updateDashboardStats();
        }

        function loadLivestockData() {
            const tableBody = document.getElementById('livestockTable');
            tableBody.innerHTML = '';
            
            let totalIncome = 0;
            let totalExpense = 0;
            let totalAnimals = 0;
            
            dataStorage.livestock.forEach(item => {
                const row = `
                    <tr>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td>${item.category}</td>
                        <td>${item.animalName}</td>
                        <td>${item.expenseType}</td>
                        <td class="currency-cell expense-cell">${formatCurrency(item.expenseAmount)}</td>
                        <td class="currency-cell income-cell">${formatCurrency(item.incomeAmount)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editRecord('livestock', '${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('livestock', '${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
                
                totalIncome += item.incomeAmount;
                totalExpense += item.expenseAmount;
                totalAnimals++;
            });
        }

        // ========== CROP MANAGEMENT ==========
        document.getElementById('cropForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveCropEntry();
        });

        function saveCropEntry() {
            const entry = {
                cropName: document.getElementById('cropName').value,
                expenseType: document.getElementById('cropExpenseType').value,
                expenseAmount: parseInt(document.getElementById('cropExpenseAmount').value) || 0,
                incomeAmount: parseInt(document.getElementById('cropIncome').value) || 0,
                area: parseFloat(document.getElementById('cropArea').value) || 0,
                date: document.getElementById('cropDate').value,
                managedBy: document.getElementById('cropManagedBy').value,
                timestamp: new Date().toISOString()
            };

            dataStorage.addCrop(entry);
            alert('Crop entry saved successfully!');
            document.getElementById('cropForm').reset();
            loadCropData();
            updateDashboardStats();
        }

        function loadCropData() {
            const tableBody = document.getElementById('cropTable');
            tableBody.innerHTML = '';
            
            dataStorage.crops.forEach(item => {
                const row = `
                    <tr>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td>${item.cropName}</td>
                        <td>${item.expenseType}</td>
                        <td class="currency-cell expense-cell">${formatCurrency(item.expenseAmount)}</td>
                        <td class="currency-cell income-cell">${formatCurrency(item.incomeAmount)}</td>
                        <td>${item.area} acres</td>
                        <td>${item.managedBy}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editRecord('crops', '${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('crops', '${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // ========== WATER SUPPLY MANAGEMENT ==========
        document.getElementById('waterForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveWaterEntry();
        });

        // Calculate bill in real-time
        document.getElementById('endTime').addEventListener('change', calculateBill);
        document.getElementById('startTime').addEventListener('change', calculateBill);
        document.getElementById('waterRate').addEventListener('input', calculateBill);

        function calculateBill() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const rate = parseInt(document.getElementById('waterRate').value) || 0;
            
            if (startTime && endTime) {
                const start = new Date(startTime);
                const end = new Date(endTime);
                const hours = (end - start) / (1000 * 60 * 60);
                
                if (hours > 0) {
                    const bill = Math.round(hours * rate);
                    document.getElementById('calculatedBill').textContent = formatCurrency(bill);
                }
            }
        }

        function saveWaterEntry() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const start = new Date(startTime);
            const end = new Date(endTime);
            const hours = (end - start) / (1000 * 60 * 60);
            const bill = Math.round(hours * parseInt(document.getElementById('waterRate').value));

            const entry = {
                farmerName: document.getElementById('farmerName').value,
                startTime: startTime,
                endTime: endTime,
                rate: parseInt(document.getElementById('waterRate').value),
                totalBill: bill,
                paymentReceived: parseInt(document.getElementById('paymentReceived').value) || 0,
                balance: bill - (parseInt(document.getElementById('paymentReceived').value) || 0),
                date: document.getElementById('waterDate').value,
                timestamp: new Date().toISOString()
            };

            dataStorage.addWater(entry);
            alert('Water billing entry saved successfully!');
            document.getElementById('waterForm').reset();
            document.getElementById('calculatedBill').textContent = formatCurrency(0);
            loadWaterData();
        }

        function loadWaterData() {
            const farmerSummary = {};
            const tableBody = document.getElementById('waterTable');
            tableBody.innerHTML = '';
            
            dataStorage.water.forEach(item => {
                // Aggregate farmer data
                if (!farmerSummary[item.farmerName]) {
                    farmerSummary[item.farmerName] = {
                        totalBill: 0,
                        totalPaid: 0,
                        lastPayment: ''
                    };
                }
                farmerSummary[item.farmerName].totalBill += item.totalBill;
                farmerSummary[item.farmerName].totalPaid += item.paymentReceived;
                farmerSummary[item.farmerName].lastPayment = item.date;
            });
            
            // Display summary
            for (const farmer in farmerSummary) {
                const balance = farmerSummary[farmer].totalBill - farmerSummary[farmer].totalPaid;
                const row = `
                    <tr>
                        <td><strong>${farmer}</strong></td>
                        <td class="currency-cell">${formatCurrency(farmerSummary[farmer].totalBill)}</td>
                        <td class="currency-cell income-cell">${formatCurrency(farmerSummary[farmer].totalPaid)}</td>
                        <td class="currency-cell ${balance > 0 ? 'expense-cell' : 'income-cell'}">
                            ${formatCurrency(balance)}
                        </td>
                        <td>${farmerSummary[farmer].lastPayment}</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewFarmerLedger('${farmer}')">
                                <i class="fas fa-eye"></i> Ledger
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            }
        }

        function viewFarmerLedger(farmerName) {
            const ledgerDetails = document.getElementById('ledgerDetails');
            ledgerDetails.innerHTML = '';
            let runningBalance = 0;
            
            dataStorage.water
                .filter(item => item.farmerName === farmerName)
                .forEach(item => {
                    runningBalance += item.balance;
                    
                    const row = `
                        <tr>
                            <td>${new Date(item.date).toLocaleDateString()}</td>
                            <td class="currency-cell">${formatCurrency(item.totalBill)}</td>
                            <td class="currency-cell income-cell">${formatCurrency(item.paymentReceived)}</td>
                            <td class="currency-cell ${item.balance > 0 ? 'expense-cell' : 'income-cell'}">
                                ${formatCurrency(item.balance)}
                            </td>
                            <td>${item.paymentReceived > 0 ? 'Payment' : 'Bill'}</td>
                        </tr>
                    `;
                    ledgerDetails.innerHTML += row;
                });
            
            document.getElementById('ledgerFarmerName').textContent = 
                `Ledger for ${farmerName} - Total Balance: ${formatCurrency(runningBalance)}`;
            new bootstrap.Modal(document.getElementById('ledgerModal')).show();
        }

        // ========== EXPENSE MANAGEMENT ==========
        document.getElementById('expenseForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveExpense();
        });

        function saveExpense() {
            const expense = {
                category: document.getElementById('expenseCategory').value,
                amount: parseInt(document.getElementById('expenseAmountMain').value),
                managedBy: document.getElementById('expenseManagedBy').value,
                description: document.getElementById('expenseDescription').value,
                date: document.getElementById('expenseDate').value,
                timestamp: new Date().toISOString()
            };

            dataStorage.addExpense(expense);
            alert('Expense saved successfully!');
            document.getElementById('expenseForm').reset();
            loadExpenseData();
            updateDashboardStats();
        }

        function loadExpenseData() {
            const tableBody = document.getElementById('expenseTable');
            tableBody.innerHTML = '';
            
            let totalExpenses = 0;
            let monthlyExpenses = 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();
            
            dataStorage.expenses.forEach(item => {
                totalExpenses += item.amount;
                
                const expenseDate = new Date(item.date);
                if (expenseDate.getMonth() === currentMonth && expenseDate.getFullYear() === currentYear) {
                    monthlyExpenses += item.amount;
                }
                
                const row = `
                    <tr>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td>${item.category}</td>
                        <td class="currency-cell expense-cell">${formatCurrency(item.amount)}</td>
                        <td>${item.managedBy}</td>
                        <td>${item.description}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editRecord('expenses', '${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('expenses', '${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
            
            // Update expense statistics
            document.getElementById('totalExpensesAmount').textContent = formatCurrency(totalExpenses);
            document.getElementById('monthlyExpenses').textContent = formatCurrency(monthlyExpenses);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
        }

        // ========== INCOME MANAGEMENT ==========
        function loadIncomeData() {
            // Aggregate income from livestock and crops
            let totalIncome = 0;
            let livestockIncome = 0;
            let cropIncome = 0;
            const monthlyData = {};
            
            // Process livestock income
            dataStorage.livestock.forEach(item => {
                livestockIncome += item.incomeAmount;
                totalIncome += item.incomeAmount;
                
                const date = new Date(item.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { livestock: 0, crops: 0, total: 0 };
                }
                monthlyData[monthYear].livestock += item.incomeAmount;
                monthlyData[monthYear].total += item.incomeAmount;
            });
            
            // Process crop income
            dataStorage.crops.forEach(item => {
                cropIncome += item.incomeAmount;
                totalIncome += item.incomeAmount;
                
                const date = new Date(item.date);
                const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                
                if (!monthlyData[monthYear]) {
                    monthlyData[monthYear] = { livestock: 0, crops: 0, total: 0 };
                }
                monthlyData[monthYear].crops += item.incomeAmount;
                monthlyData[monthYear].total += item.incomeAmount;
            });
            
            // Update dashboard
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            
            // Update income sources table
            const incomeSources = document.getElementById('incomeSources');
            incomeSources.innerHTML = `
                <tr>
                    <td>Livestock</td>
                    <td class="currency-cell income-cell">${formatCurrency(livestockIncome)}</td>
                    <td>${totalIncome > 0 ? ((livestockIncome / totalIncome) * 100).toFixed(1) : 0}%</td>
                </tr>
                <tr>
                    <td>Crops</td>
                    <td class="currency-cell income-cell">${formatCurrency(cropIncome)}</td>
                    <td>${totalIncome > 0 ? ((cropIncome / totalIncome) * 100).toFixed(1) : 0}%</td>
                </tr>
                <tr class="table-success">
                    <td><strong>Total</strong></td>
                    <td class="currency-cell income-cell"><strong>${formatCurrency(totalIncome)}</strong></td>
                    <td><strong>100%</strong></td>
                </tr>
            `;
            
            // Update monthly income table
            const monthlyIncomeTable = document.getElementById('monthlyIncome');
            monthlyIncomeTable.innerHTML = '';
            
            Object.keys(monthlyData).sort().reverse().slice(0, 6).forEach(month => {
                const row = `
                    <tr>
                        <td>${month}</td>
                        <td class="currency-cell">${formatCurrency(monthlyData[month].livestock)}</td>
                        <td class="currency-cell">${formatCurrency(monthlyData[month].crops)}</td>
                        <td class="currency-cell income-cell">${formatCurrency(monthlyData[month].total)}</td>
                    </tr>
                `;
                monthlyIncomeTable.innerHTML += row;
            });
        }

        // ========== CRUD OPERATIONS ==========
        function editRecord(collection, id) {
            let data;
            switch(collection) {
                case 'livestock':
                    data = dataStorage.livestock.find(item => item.id === id);
                    break;
                case 'crops':
                    data = dataStorage.crops.find(item => item.id === id);
                    break;
                case 'expenses':
                    data = dataStorage.expenses.find(item => item.id === id);
                    break;
                case 'water':
                    data = dataStorage.water.find(item => item.id === id);
                    break;
            }
            
            if (data) {
                const form = document.getElementById('editForm');
                form.innerHTML = '';
                
                // Create form fields based on collection
                switch(collection) {
                    case 'livestock':
                        form.innerHTML = `
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editCategory" required>
                                    <option value="Cow" ${data.category === 'Cow' ? 'selected' : ''}>Cow</option>
                                    <option value="Beef" ${data.category === 'Beef' ? 'selected' : ''}>Beef</option>
                                    <option value="Goat" ${data.category === 'Goat' ? 'selected' : ''}>Goat</option>
                                    <option value="Others" ${data.category === 'Others' ? 'selected' : ''}>Others</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Animal Name/ID</label>
                                <input type="text" class="form-control" id="editAnimalName" value="${data.animalName || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expense Type</label>
                                <input type="text" class="form-control" id="editExpenseType" value="${data.expenseType || ''}">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expense Amount</label>
                                <input type="number" class="form-control" id="editExpenseAmount" value="${data.expenseAmount || 0}" step="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Income Amount</label>
                                <input type="number" class="form-control" id="editIncomeAmount" value="${data.incomeAmount || 0}" step="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editDate" value="${data.date || ''}" required>
                            </div>
                        `;
                        break;
                    case 'crops':
                        form.innerHTML = `
                            <div class="mb-3">
                                <label class="form-label">Crop Name</label>
                                <input type="text" class="form-control" id="editCropName" value="${data.cropName || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expense Type</label>
                                <input type="text" class="form-control" id="editCropExpenseType" value="${data.expenseType || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expense Amount</label>
                                <input type="number" class="form-control" id="editCropExpenseAmount" value="${data.expenseAmount || 0}" step="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Income Amount</label>
                                <input type="number" class="form-control" id="editCropIncome" value="${data.incomeAmount || 0}" step="1">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editCropDate" value="${data.date || ''}" required>
                            </div>
                        `;
                        break;
                    case 'expenses':
                        form.innerHTML = `
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <input type="text" class="form-control" id="editExpenseCategory" value="${data.category || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Amount</label>
                                <input type="number" class="form-control" id="editExpenseAmount" value="${data.amount || 0}" step="1" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Managed By</label>
                                <input type="text" class="form-control" id="editExpenseManagedBy" value="${data.managedBy || ''}" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="editExpenseDescription" rows="2">${data.description || ''}</textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Date</label>
                                <input type="date" class="form-control" id="editExpenseDate" value="${data.date || ''}" required>
                            </div>
                        `;
                        break;
                }
                
                document.getElementById('editId').value = id;
                document.getElementById('editCollection').value = collection;
                
                const modal = new bootstrap.Modal(document.getElementById('editModal'));
                modal.show();
            }
        }

        function saveEdit() {
            const id = document.getElementById('editId').value;
            const collection = document.getElementById('editCollection').value;
            let updatedData = {};
            let success = false;
            
            switch(collection) {
                case 'livestock':
                    updatedData = {
                        category: document.getElementById('editCategory').value,
                        animalName: document.getElementById('editAnimalName').value,
                        expenseType: document.getElementById('editExpenseType').value,
                        expenseAmount: parseInt(document.getElementById('editExpenseAmount').value) || 0,
                        incomeAmount: parseInt(document.getElementById('editIncomeAmount').value) || 0,
                        date: document.getElementById('editDate').value
                    };
                    success = dataStorage.updateLivestock(id, updatedData);
                    break;
                case 'crops':
                    updatedData = {
                        cropName: document.getElementById('editCropName').value,
                        expenseType: document.getElementById('editCropExpenseType').value,
                        expenseAmount: parseInt(document.getElementById('editCropExpenseAmount').value) || 0,
                        incomeAmount: parseInt(document.getElementById('editCropIncome').value) || 0,
                        date: document.getElementById('editCropDate').value
                    };
                    success = dataStorage.updateCrop(id, updatedData);
                    break;
                case 'expenses':
                    updatedData = {
                        category: document.getElementById('editExpenseCategory').value,
                        amount: parseInt(document.getElementById('editExpenseAmount').value) || 0,
                        managedBy: document.getElementById('editExpenseManagedBy').value,
                        description: document.getElementById('editExpenseDescription').value,
                        date: document.getElementById('editExpenseDate').value
                    };
                    success = dataStorage.updateExpense(id, updatedData);
                    break;
            }
            
            if (success) {
                alert('Record updated successfully!');
                bootstrap.Modal.getInstance(document.getElementById('editModal')).hide();
                reloadCurrentTabData();
                updateDashboardStats();
            }
        }

        function deleteRecord(collection, id) {
            if (confirm('Are you sure you want to delete this record?')) {
                let success = false;
                
                switch(collection) {
                    case 'livestock':
                        success = dataStorage.deleteLivestock(id);
                        break;
                    case 'crops':
                        success = dataStorage.deleteCrop(id);
                        break;
                    case 'expenses':
                        success = dataStorage.deleteExpense(id);
                        break;
                    case 'water':
                        success = dataStorage.deleteWater(id);
                        break;
                }
                
                if (success) {
                    alert('Record deleted successfully!');
                    reloadCurrentTabData();
                    updateDashboardStats();
                }
            }
        }

        function reloadCurrentTabData() {
            const activeTab = document.querySelector('.tab-content[style="display: block;"]').id;
            switch(activeTab) {
                case 'livestock':
                    loadLivestockData();
                    break;
                case 'crops':
                    loadCropData();
                    break;
                case 'water':
                    loadWaterData();
                    break;
                case 'expenses':
                    loadExpenseData();
                    break;
                case 'income':
                    loadIncomeData();
                    break;
            }
        }

        // ========== EXCEL OPERATIONS ==========
        function downloadExcelTemplate(type) {
            let templateData = [];
            let fileName = '';
            
            switch(type) {
                case 'livestock':
                    templateData = [['Date', 'Category', 'Animal Name/ID', 'Expense Type', 'Expense Amount', 'Income Amount', 'Description']];
                    fileName = 'livestock_template.xlsx';
                    break;
                case 'crops':
                    templateData = [['Date', 'Crop Name', 'Expense Type', 'Expense Amount', 'Income Amount', 'Area', 'Managed By']];
                    fileName = 'crops_template.xlsx';
                    break;
            }
            
            const ws = XLSX.utils.aoa_to_sheet(templateData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, fileName);
        }

        function uploadExcel(type) {
            const fileInput = type === 'livestock' ? 
                document.getElementById('excelUpload') : 
                document.getElementById('cropExcelUpload');
            const file = fileInput.files[0];
            
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);
                
                // Process and save data
                processExcelData(type, jsonData);
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(type, data) {
            let count = 0;
            
            data.forEach(row => {
                let entry;
                if (type === 'livestock') {
                    entry = {
                        date: row.Date || new Date().toISOString().split('T')[0],
                        category: row.Category || '',
                        animalName: row['Animal Name/ID'] || '',
                        expenseType: row['Expense Type'] || '',
                        expenseAmount: parseInt(row['Expense Amount']) || 0,
                        incomeAmount: parseInt(row['Income Amount']) || 0,
                        description: row.Description || '',
                        timestamp: new Date().toISOString()
                    };
                    dataStorage.addLivestock(entry);
                } else {
                    entry = {
                        date: row.Date || new Date().toISOString().split('T')[0],
                        cropName: row['Crop Name'] || '',
                        expenseType: row['Expense Type'] || '',
                        expenseAmount: parseInt(row['Expense Amount']) || 0,
                        incomeAmount: parseInt(row['Income Amount']) || 0,
                        area: parseFloat(row.Area) || 0,
                        managedBy: row['Managed By'] || '',
                        timestamp: new Date().toISOString()
                    };
                    dataStorage.addCrop(entry);
                }
                count++;
            });
            
            alert(`${count} records imported successfully!`);
            reloadCurrentTabData();
            updateDashboardStats();
        }

        function exportToExcel(type) {
            let data = [];
            let fileName = '';
            
            switch(type) {
                case 'livestock':
                    data = dataStorage.livestock.map(item => [
                        item.date,
                        item.category,
                        item.animalName,
                        item.expenseType,
                        item.expenseAmount,
                        item.incomeAmount,
                        item.description || ''
                    ]);
                    fileName = `livestock_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    break;
                case 'crops':
                    data = dataStorage.crops.map(item => [
                        item.date,
                        item.cropName,
                        item.expenseType,
                        item.expenseAmount,
                        item.incomeAmount,
                        item.area || 0,
                        item.managedBy || ''
                    ]);
                    fileName = `crops_data_${new Date().toISOString().split('T')[0]}.xlsx`;
                    break;
            }
            
            // Add headers
            const headers = type === 'livestock' ? 
                ['Date', 'Category', 'Animal Name/ID', 'Expense Type', 'Expense Amount', 'Income Amount', 'Description'] :
                ['Date', 'Crop Name', 'Expense Type', 'Expense Amount', 'Income Amount', 'Area', 'Managed By'];
            
            data.unshift(headers);
            
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, fileName);
        }

        // ========== PDF GENERATION ==========
        function generateLivestockPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text('Livestock Management Report', 105, 15, { align: 'center' });
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const tableData = dataStorage.livestock.map(item => [
                new Date(item.date).toLocaleDateString(),
                item.category,
                item.animalName,
                item.expenseType,
                formatCurrency(item.expenseAmount),
                formatCurrency(item.incomeAmount),
                item.description || ''
            ]);
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Category', 'Animal', 'Expense Type', 'Expense', 'Income', 'Description']],
                body: tableData,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [46, 139, 87] }
            });
            
            // Add summary
            const totalExpense = dataStorage.livestock.reduce((sum, item) => sum + item.expenseAmount, 0);
            const totalIncome = dataStorage.livestock.reduce((sum, item) => sum + item.incomeAmount, 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(10);
            doc.text(`Total Expense: ${formatCurrency(totalExpense)}`, 20, finalY);
            doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, finalY + 7);
            doc.text(`Net Profit: ${formatCurrency(totalIncome - totalExpense)}`, 20, finalY + 14);
            
            // Save PDF
            doc.save(`livestock_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateCropPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(16);
            doc.text('Crop Management Report', 105, 15, { align: 'center' });
            
            // Add date
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 22, { align: 'center' });
            
            // Prepare table data
            const tableData = dataStorage.crops.map(item => [
                new Date(item.date).toLocaleDateString(),
                item.cropName,
                item.expenseType,
                formatCurrency(item.expenseAmount),
                formatCurrency(item.incomeAmount),
                `${item.area || 0} acres`,
                item.managedBy || ''
            ]);
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Crop', 'Expense Type', 'Expense', 'Income', 'Area', 'Managed By']],
                body: tableData,
                startY: 30,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [46, 139, 87] }
            });
            
            // Add summary
            const totalExpense = dataStorage.crops.reduce((sum, item) => sum + item.expenseAmount, 0);
            const totalIncome = dataStorage.crops.reduce((sum, item) => sum + item.incomeAmount, 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(10);
            doc.text(`Total Expense: ${formatCurrency(totalExpense)}`, 20, finalY);
            doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, finalY + 7);
            doc.text(`Net Profit: ${formatCurrency(totalIncome - totalExpense)}`, 20, finalY + 14);
            
            // Save PDF
            doc.save(`crop_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateMonthlyReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Title
            doc.setFontSize(18);
            doc.text('Farm Monthly Report', 105, 20, { align: 'center' });
            
            // Date
            doc.setFontSize(12);
            const monthYear = new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            doc.text(`Month: ${monthYear}`, 105, 30, { align: 'center' });
            
            let yPos = 40;
            
            // Calculate totals for the current month
            const startDate = new Date();
            startDate.setDate(1);
            startDate.setHours(0, 0, 0, 0);
            
            const endDate = new Date();
            endDate.setMonth(endDate.getMonth() + 1);
            endDate.setDate(0);
            endDate.setHours(23, 59, 59, 999);
            
            const startDateStr = startDate.toISOString().split('T')[0];
            const endDateStr = endDate.toISOString().split('T')[0];
            
            const currentMonthLivestock = dataStorage.livestock.filter(item => 
                item.date >= startDateStr && item.date <= endDateStr);
            const currentMonthCrops = dataStorage.crops.filter(item => 
                item.date >= startDateStr && item.date <= endDateStr);
            const currentMonthExpenses = dataStorage.expenses.filter(item => 
                item.date >= startDateStr && item.date <= endDateStr);
            
            // Calculate totals
            let livestockIncome = 0;
            let livestockExpense = 0;
            let cropIncome = 0;
            let cropExpense = 0;
            let otherExpenses = 0;
            
            currentMonthLivestock.forEach(item => {
                livestockIncome += item.incomeAmount || 0;
                livestockExpense += item.expenseAmount || 0;
            });
            
            currentMonthCrops.forEach(item => {
                cropIncome += item.incomeAmount || 0;
                cropExpense += item.expenseAmount || 0;
            });
            
            currentMonthExpenses.forEach(item => {
                otherExpenses += item.amount || 0;
            });
            
            const totalIncome = livestockIncome + cropIncome;
            const totalExpense = livestockExpense + cropExpense + otherExpenses;
            const netProfit = totalIncome - totalExpense;
            
            // Add summary section
            doc.setFontSize(14);
            doc.text('Financial Summary', 20, yPos);
            yPos += 10;
            
            doc.setFontSize(10);
            doc.text(`Livestock Income: ${formatCurrency(livestockIncome)}`, 20, yPos);
            doc.text(`Livestock Expenses: ${formatCurrency(livestockExpense)}`, 20, yPos + 7);
            doc.text(`Crop Income: ${formatCurrency(cropIncome)}`, 20, yPos + 14);
            doc.text(`Crop Expenses: ${formatCurrency(cropExpense)}`, 20, yPos + 21);
            doc.text(`Other Expenses: ${formatCurrency(otherExpenses)}`, 20, yPos + 28);
            
            yPos += 40;
            
            // Add totals
            doc.setFontSize(12);
            doc.setDrawColor(0);
            doc.setLineWidth(0.5);
            doc.line(20, yPos, 190, yPos);
            yPos += 10;
            
            doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, yPos);
            doc.text(`Total Expenses: ${formatCurrency(totalExpense)}`, 20, yPos + 7);
            doc.text(`Net Profit: ${formatCurrency(netProfit)}`, 20, yPos + 14);
            
            // Save PDF
            doc.save(`monthly_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // ========== DASHBOARD FUNCTIONS ==========
        function updateDashboardStats() {
            // Calculate livestock stats
            let totalLivestock = 0;
            let totalCrops = 0;
            let totalIncome = 0;
            let totalExpenses = 0;
            
            dataStorage.livestock.forEach(item => {
                totalLivestock++;
                totalIncome += item.incomeAmount || 0;
                totalExpenses += item.expenseAmount || 0;
            });
            
            // Calculate crop stats
            const uniqueCrops = new Set();
            dataStorage.crops.forEach(item => {
                uniqueCrops.add(item.cropName);
                totalIncome += item.incomeAmount || 0;
                totalExpenses += item.expenseAmount || 0;
            });
            totalCrops = uniqueCrops.size;
            
            // Calculate expense stats
            dataStorage.expenses.forEach(item => {
                totalExpenses += item.amount || 0;
            });
            
            // Calculate water expenses
            dataStorage.water.forEach(item => {
                totalExpenses += item.totalBill || 0;
            });
            
            // Update UI
            document.getElementById('totalLivestock').textContent = totalLivestock;
            document.getElementById('totalCrops').textContent = totalCrops;
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
            
            // Update recent transactions
            updateRecentTransactions();
        }

        function updateRecentTransactions() {
            const allTransactions = [];
            
            // Add livestock transactions
            dataStorage.livestock.forEach(item => {
                if (item.incomeAmount > 0 || item.expenseAmount > 0) {
                    allTransactions.push({
                        date: item.date,
                        type: 'Livestock',
                        description: `${item.category} - ${item.animalName}`,
                        amount: item.incomeAmount - item.expenseAmount,
                        isIncome: item.incomeAmount > item.expenseAmount,
                        timestamp: item.timestamp
                    });
                }
            });
            
            // Add crop transactions
            dataStorage.crops.forEach(item => {
                if (item.incomeAmount > 0 || item.expenseAmount > 0) {
                    allTransactions.push({
                        date: item.date,
                        type: 'Crop',
                        description: `${item.cropName}`,
                        amount: item.incomeAmount - item.expenseAmount,
                        isIncome: item.incomeAmount > item.expenseAmount,
                        timestamp: item.timestamp
                    });
                }
            });
            
            // Add expense transactions
            dataStorage.expenses.forEach(item => {
                allTransactions.push({
                    date: item.date,
                    type: 'Expense',
                    description: `${item.category} - ${item.description}`,
                    amount: -item.amount,
                    isIncome: false,
                    timestamp: item.timestamp
                });
            });
            
            // Sort by timestamp (most recent first) and take top 5
            allTransactions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            const recentTransactions = allTransactions.slice(0, 5);
            
            // Display transactions
            const container = document.getElementById('recentTransactions');
            container.innerHTML = '';
            
            recentTransactions.forEach(transaction => {
                const div = document.createElement('div');
                div.className = `d-flex justify-content-between align-items-center p-2 mb-2 ${transaction.isIncome ? 'bg-success bg-opacity-10' : 'bg-danger bg-opacity-10'}`;
                div.innerHTML = `
                    <div>
                        <small class="text-muted">${new Date(transaction.date).toLocaleDateString()}</small>
                        <div>${transaction.type}: ${transaction.description}</div>
                    </div>
                    <div class="${transaction.isIncome ? 'text-success' : 'text-danger'}">
                        ${transaction.isIncome ? '+' : '-'}${formatCurrency(Math.abs(transaction.amount))}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // ========== DATA BACKUP & RESTORE ==========
        function exportAllData() {
            const data = dataStorage.exportData();
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `farm_management_backup_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            alert('All data exported successfully!');
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    dataStorage.importData(data);
                    alert('Data imported successfully!');
                    loadAllData();
                    updateDashboardStats();
                } catch (error) {
                    alert('Error importing data. Please check the file format.');
                }
            };
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
                if (confirm('WARNING: This will delete ALL records. Are you absolutely sure?')) {
                    dataStorage.clearData();
                    alert('All data cleared!');
                    loadAllData();
                    updateDashboardStats();
                }
            }
        }

        // ========== UTILITY FUNCTIONS ==========
        function loadAllData() {
            loadLivestockData();
            loadCropData();
            loadWaterData();
            loadExpenseData();
            loadIncomeData();
        }

        // Filter functions
        function filterLivestockRecords() {
            const fromDate = document.getElementById('livestockFromDate').value;
            const toDate = document.getElementById('livestockToDate').value;
            
            let filteredData = dataStorage.livestock;
            
            if (fromDate) {
                filteredData = filteredData.filter(item => item.date >= fromDate);
            }
            
            if (toDate) {
                filteredData = filteredData.filter(item => item.date <= toDate);
            }
            
            // Update table
            const tableBody = document.getElementById('livestockTable');
            tableBody.innerHTML = '';
            
            filteredData.forEach(item => {
                const row = `
                    <tr>
                        <td>${new Date(item.date).toLocaleDateString()}</td>
                        <td>${item.category}</td>
                        <td>${item.animalName}</td>
                        <td>${item.expenseType}</td>
                        <td class="currency-cell expense-cell">${formatCurrency(item.expenseAmount)}</td>
                        <td class="currency-cell income-cell">${formatCurrency(item.incomeAmount)}</td>
                        <td>
                            <button class="btn btn-sm btn-warning me-1" onclick="editRecord('livestock', '${item.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRecord('livestock', '${item.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.innerHTML += row;
            });
        }

        // Initialize date fields with current date
        function initializeDates() {
            const today = new Date().toISOString().split('T')[0];
            const dateInputs = document.querySelectorAll('input[type="date"]');
            dateInputs.forEach(input => {
                if (!input.value) {
                    input.value = today;
                }
            });
            
            // Set date range defaults
            const firstDay = new Date();
            firstDay.setDate(1);
            document.getElementById('livestockFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('cropFromDate').value = firstDay.toISOString().split('T')[0];
            document.getElementById('reportFromDate').value = firstDay.toISOString().split('T')[0];
            
            document.getElementById('livestockToDate').value = today;
            document.getElementById('cropToDate').value = today;
            document.getElementById('reportToDate').value = today;
        }

        // Additional report functions
        function generateMonthlySummary() {
            generateMonthlyReport();
        }

        function generateFinancialAnalysis() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Financial Analysis Report', 105, 20, { align: 'center' });
            doc.setFontSize(10);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 28, { align: 'center' });
            
            // Calculate totals
            let totalIncome = 0;
            let totalExpenses = 0;
            
            dataStorage.livestock.forEach(item => {
                totalIncome += item.incomeAmount;
                totalExpenses += item.expenseAmount;
            });
            
            dataStorage.crops.forEach(item => {
                totalIncome += item.incomeAmount;
                totalExpenses += item.expenseAmount;
            });
            
            dataStorage.expenses.forEach(item => {
                totalExpenses += item.amount;
            });
            
            dataStorage.water.forEach(item => {
                totalExpenses += item.totalBill;
            });
            
            const netProfit = totalIncome - totalExpenses;
            
            // Add analysis
            doc.setFontSize(12);
            doc.text(`Total Income: ${formatCurrency(totalIncome)}`, 20, 40);
            doc.text(`Total Expenses: ${formatCurrency(totalExpenses)}`, 20, 50);
            doc.text(`Net Profit: ${formatCurrency(netProfit)}`, 20, 60);
            doc.text(`Profit Margin: ${totalIncome > 0 ? ((netProfit / totalIncome) * 100).toFixed(2) : 0}%`, 20, 70);
            
            doc.save(`financial_analysis_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateManagedExpensesReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Managed Expenses Report', 105, 20, { align: 'center' });
            
            // Group expenses by manager
            const managedExpenses = {};
            dataStorage.expenses.forEach(expense => {
                if (!managedExpenses[expense.managedBy]) {
                    managedExpenses[expense.managedBy] = 0;
                }
                managedExpenses[expense.managedBy] += expense.amount;
            });
            
            // Create table data
            const tableData = Object.keys(managedExpenses).map(manager => [
                manager,
                formatCurrency(managedExpenses[manager])
            ]);
            
            doc.autoTable({
                head: [['Managed By', 'Total Amount']],
                body: tableData,
                startY: 30,
                theme: 'grid',
                headStyles: { fillColor: [46, 139, 87] }
            });
            
            doc.save(`managed_expenses_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        function generateWaterReportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Water Supply Report', 105, 15, { align: 'center' });
            
            // Prepare table data
            const tableData = dataStorage.water.map(item => [
                new Date(item.date).toLocaleDateString(),
                item.farmerName,
                formatCurrency(item.totalBill),
                formatCurrency(item.paymentReceived),
                formatCurrency(item.balance),
                `${Math.round((new Date(item.endTime) - new Date(item.startTime)) / (1000 * 60 * 60))} hours`
            ]);
            
            // Add table
            doc.autoTable({
                head: [['Date', 'Farmer', 'Total Bill', 'Paid', 'Balance', 'Hours']],
                body: tableData,
                startY: 25,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [65, 105, 225] }
            });
            
            // Calculate totals
            const totalBill = dataStorage.water.reduce((sum, item) => sum + item.totalBill, 0);
            const totalPaid = dataStorage.water.reduce((sum, item) => sum + item.paymentReceived, 0);
            const totalBalance = dataStorage.water.reduce((sum, item) => sum + item.balance, 0);
            const finalY = doc.lastAutoTable.finalY + 10;
            
            doc.setFontSize(10);
            doc.text(`Total Billed: ${formatCurrency(totalBill)}`, 20, finalY);
            doc.text(`Total Received: ${formatCurrency(totalPaid)}`, 20, finalY + 7);
            doc.text(`Pending Balance: ${formatCurrency(totalBalance)}`, 20, finalY + 14);
            
            doc.save(`water_report_${new Date().toISOString().split('T')[0]}.pdf`);
        }

        // Report form handler
        document.getElementById('reportForm').addEventListener('submit', function(e) {
            e.preventDefault();
            generateCustomReport();
        });

        function generateCustomReport() {
            const reportType = document.getElementById('reportType').value;
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            
            alert(`Generating ${reportType} report from ${fromDate} to ${toDate}`);
            // You can implement custom report generation based on type and date range
        }

        // Quick report functions
        function generateTodayReport() {
            const today = new Date().toISOString().split('T')[0];
            alert(`Generating today's report for ${today}`);
        }

        function generateWeeklyReport() {
            alert('Generating weekly report');
        }

        function generateYearlyReport() {
            alert('Generating yearly report');
        }

        function showAllLedgers() {
            alert('Showing all farmer ledgers');
        }

        function exportWaterReport() {
            exportToExcel('water');
        }

        function loadReportData() {
            // Load data needed for reports
            console.log('Loading report data...');
        }

        // Auto-save functionality for forms
        function autoSaveForm(formId, collection) {
            const form = document.getElementById(formId);
            form.addEventListener('input', function() {
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                localStorage.setItem(`${collection}_draft`, JSON.stringify(data));
            });
            
            // Load draft on page load
            const draft = localStorage.getItem(`${collection}_draft`);
            if (draft) {
                const data = JSON.parse(draft);
                Object.keys(data).forEach(key => {
                    const element = form.querySelector(`[name="${key}"]`);
                    if (element) {
                        element.value = data[key];
                    }
                });
            }
            
            // Clear draft on successful submit
            form.addEventListener('submit', function() {
                localStorage.removeItem(`${collection}_draft`);
            });
        }

        // Initialize auto-save for forms
        autoSaveForm('livestockForm', 'livestock');
        autoSaveForm('cropForm', 'crops');
        autoSaveForm('waterForm', 'water');
        autoSaveForm('expenseForm', 'expenses');

        // Initialize the app
        window.onload = function() {
            loadAllData();
            updateDashboardStats();
        };
    </script>
</body>
</html>
